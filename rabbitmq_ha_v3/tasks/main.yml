---
# RabbitMQ HA v3 Role - Tasks
# Deploys RabbitMQ Quorum Cluster on queue-01, queue-02, queue-03

- name: Install Erlang and RabbitMQ server
  apt:
    name:
      - erlang
      - rabbitmq-server
    state: present
    update_cache: yes

- name: Ensure RabbitMQ data directory exists
  file:
    path: /data/rabbitmq
    state: directory
    owner: rabbitmq
    group: rabbitmq
    mode: '0755'

- name: Stop RabbitMQ service before configuration
  systemd:
    name: rabbitmq-server
    state: stopped
  ignore_errors: yes

- name: Set RabbitMQ nodename based on inventory hostname
  set_fact:
    rabbitmq_nodename: "rabbit@{{ inventory_hostname }}"

- name: Configure RabbitMQ nodename via environment file
  lineinfile:
    path: /etc/rabbitmq/rabbitmq-env.conf
    regexp: '^NODENAME='
    line: 'NODENAME={{ rabbitmq_nodename }}'
    create: yes
    owner: root
    group: root
    mode: '0644'

- name: Deploy RabbitMQ configuration
  template:
    src: rabbitmq.conf.j2
    dest: /etc/rabbitmq/rabbitmq.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart rabbitmq

- name: Deploy RabbitMQ advanced configuration
  template:
    src: advanced.config.j2
    dest: /etc/rabbitmq/advanced.config
    owner: root
    group: root
    mode: '0644'
  notify: restart rabbitmq

- name: Enable RabbitMQ management plugin
  command: rabbitmq-plugins enable rabbitmq_management
  args:
    creates: /etc/rabbitmq/enabled_plugins
  notify: restart rabbitmq

- name: Start and enable RabbitMQ server
  systemd:
    name: rabbitmq-server
    state: started
    enabled: yes

- name: Wait for RabbitMQ to be ready
  wait_for:
    port: 5672
    host: "{{ ansible_host }}"
    delay: 5
    timeout: 60

- name: Join cluster on non-first node
  command: rabbitmqctl stop_app
  when: inventory_hostname != rabbitmq_cluster_first_node
  ignore_errors: yes

- name: Reset cluster state on non-first node
  command: rabbitmqctl reset
  when: inventory_hostname != rabbitmq_cluster_first_node
  ignore_errors: yes

- name: Join cluster to first node
  command: rabbitmqctl join_cluster rabbit@{{ rabbitmq_cluster_first_node }}
  when: inventory_hostname != rabbitmq_cluster_first_node
  ignore_errors: yes
  register: join_result

- name: Start RabbitMQ app after cluster join
  command: rabbitmqctl start_app
  when: inventory_hostname != rabbitmq_cluster_first_node
  ignore_errors: yes

- name: Wait for cluster to stabilize
  pause:
    seconds: 10
  when: inventory_hostname != rabbitmq_cluster_first_node

- name: Verify RabbitMQ cluster status
  command: rabbitmqctl cluster_status
  register: cluster_status
  changed_when: false

- name: Display cluster status
  debug:
    var: cluster_status.stdout_lines

