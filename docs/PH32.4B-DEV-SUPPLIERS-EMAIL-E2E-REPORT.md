# PH32.4B — DEV Suppliers + Email Outbound E2E Report

**Date** : 2026-02-12  
**Environnement** : DEV uniquement  
**Image API** : `ghcr.io/keybuzzio/keybuzz-api:v3.3.5-ph324b-smtp-fix-dev-3`  
**Digest** : `sha256:2cfed3765b3e8b9bd94fd8824e99359da268b23795f175a2a4d10eafe3b41846`

---

## 1. Suppliers CRUD — Preuves

### 1A. GET /suppliers AVANT creation

```
Count: 1
  - 6dabfd4b-cad... | Terra Computer France | ludovic@ecomlg.fr
```

### 1B. POST /suppliers — Creation

```json
{
  "supplier": {
    "id": "237f88e0-d07d-4c04-bca7-e5c2b5dff763",
    "name": "Terra Computer France",
    "email": "ludovic@ecomlg.fr",
    "support_email": "sav@terra-computer.fr"
  }
}
```

### 1C. GET /suppliers APRES creation

```
Count: 2
  - 6dabfd4b-cad... | Terra Computer France | ludovic@ecomlg.fr
  - 237f88e0-d07... | Terra Computer France | ludovic@ecomlg.fr
```

**Persistance confirmee** : le supplier est en DB et visible apres refresh.

### 1D. DELETE /suppliers (cleanup)

```json
{"deleted": true, "id": "237f88e0-d07d-4c04-bca7-e5c2b5dff763"}
```

---

## 2. Supplier Case + Send Email — Preuves

### 2A. POST /supplier-cases — Creation

```
case_id: 69a11d97-d366-48e0-8d4f-e50cae70d900
status: pending_supplier
reply_to_address: sav.ecomlg-001.69a11d97-d366-48e0-8d4f-e50cae70d900@inbound.keybuzz.io
```

### 2B. POST /supplier-cases/:id/send-email

```
Requete:
  subject: "[KBZ-SAV] Test PH32.4B envoi email"
  emailBody: "Bonjour,\nCeci est un test PH32.4B.\nMerci de confirmer..."
  senderName: "Equipe SAV eComLG"

Reponse:
  SUCCESS
  message_id: msg-630c0f33d4d1ac46
  delivery_id: dlv-1770888735675-e7e83d44
  target: ludovic@ecomlg.fr
  replyTo: sav.ecomlg-001.69a11d97-d366-48e0-8d4f-e50cae70d900@inbound.keybuzz.io
  status: queued
```

### 2C. DB — Message cree

```
id: msg-630c0f33d4d1ac46
direction: outbound
message_source: SUPPLIER_CONTACT
body: "[Email fournisseur → Terra Computer France]
  Sujet: [KBZ-SAV] Test PH32.4B envoi email
  Bonjour, Ceci est un test PH32.4B..."
```

### 2D. DB — Supplier case

```json
{
  "id": "69a11d97-d366-48e0-8d4f-e50cae70d900",
  "status": "pending_supplier",
  "reply_to_address": "sav.ecomlg-001.69a11d97-d366-48e0-8d4f-e50cae70d900@inbound.keybuzz.io",
  "last_action_at": "2026-02-12T09:32:15.608Z"
}
```

---

## 3. Pipeline Outbound — Preuves

### 3A. DB — outbound_deliveries

```json
{
  "id": "dlv-1770888735675-e7e83d44",
  "tenant_id": "ecomlg-001",
  "conversation_id": "cmmlghdrl51340b3c3ef64dac",
  "message_id": "msg-630c0f33d4d1ac46",
  "channel": "email",
  "target_address": "ludovic@ecomlg.fr",
  "provider": "SMTP",
  "status": "delivered",
  "attempt_count": 1,
  "delivered_at": "2026-02-12T09:32:19.050Z"
}
```

### 3B. Delivery Trace

```json
{
  "provider": "smtp",
  "processedAt": "2026-02-12T09:32:17.742Z",
  "attemptCount": 1,
  "spapiEnabled": false,
  "workerVersion": "4.3.0-smtp-unified",
  "emailMessageId": "<b00e6c93-0cd6-4a01-8d99-681a464a5f15@keybuzz.io>"
}
```

### 3C. Timeline pipeline

| Etape | Timestamp | Statut |
|-------|-----------|--------|
| INSERT delivery | 09:32:15.608Z | queued |
| Worker process | 09:32:17.742Z | sending |
| SMTP relay accepted | 09:32:19.050Z | **delivered** |

**Statut final : `delivered`** — email accepte par le relay SMTP.

### 3D. Historique complet des supplier messages (conversation)

| ID | Direction | Source | Date |
|----|-----------|--------|------|
| msg-630c0f33d4d1ac46 | outbound | SUPPLIER_CONTACT | 2026-02-12T09:32:15 |
| msg-dc6fe421c06b5de3 | outbound | SUPPLIER_CONTACT | 2026-02-12T09:18:55 |
| msg-9b659679880c1272 | outbound | SUPPLIER_CONTACT | 2026-02-12T07:02:14 |
| msg-52c6038a29b22fd6 | inbound | SUPPLIER_INBOUND | 2026-02-11T21:15:00 |
| msg-288a439830588062 | outbound | SUPPLIER_CONTACT | 2026-02-11T21:08:18 |

---

## 4. Fix applique — Worker SMTP

### Probleme initial

Le worker outbound ne reconnaissait que les providers `mock`, `spapi`, `SMTP_AMAZON_NONORDER`, `email_forward`, `smtp`.  
Le supplier email utilisait `SMTP` (majuscule) → "Unknown provider: SMTP" → echec apres 5 tentatives.

De plus, le handler `smtp` lisait `delivery.subject`, `delivery.body_text`, `delivery.reply_to` depuis des colonnes inexistantes dans `outbound_deliveries`.

### Fix applique

1. **suppliers.routes.ts** : provider = `smtp` (minuscule) + metadata complete dans `delivery_trace` JSONB
2. **outboundWorker.ts** : handler `smtp` lit maintenant en fallback depuis `delivery_trace` (emailSubject, emailBody, replyToAddress) et depuis la table `messages` via `getMessageBody()`

### Non-regression

- Les providers `spapi`, `SMTP_AMAZON_NONORDER`, `mock`, `email_forward` ne sont pas modifies
- Le handler `smtp` reste compatible : si les colonnes existent (futur), elles sont prioritaires

---

## 5. Composants NON modifies

- PROD inchangee
- mail-core-01 inchange
- Client UI inchange
- Routes Amazon inchangees
- KBActions / IA inchanges

---

## 6. Rollback

```bash
# Revenir a l'image precedente
kubectl set image deployment/keybuzz-api \
  keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:v3.3.5-ph324-supplier-ia-dev-2 \
  -n keybuzz-api-dev
```

---

## 7. Root cause : Worker separe

### Decouverte

Le `keybuzz-outbound-worker` tourne en **deployment separe** (pas dans le pod API).  
Image ancienne : `ghcr.io/keybuzzio/keybuzz-api:v0.1.106-smtp-unified`  
→ **Pas de fix PH32.4B** → body vide, pas de Reply-To, sujet = conversation.

### Fix

Mise a jour du deployment `keybuzz-outbound-worker` vers la meme image que l'API :  
`ghcr.io/keybuzzio/keybuzz-api:v3.3.5-ph324b-smtp-fix-dev-3`

### Preuve apres fix worker

```
[Worker] Processing dlv-1770891300537-bd5a99a7 (provider: smtp, attempt: 1)
[Worker] SMTP send: to=ludovic@ecomlg.fr subject=[KBZ-SAV PH32.4B] Test email fournisseur avec contenu replyTo=sav.ecomlg-001.69a11d97-...@inbound.keybuzz.io bodyLen=242
[Worker] dlv-1770891300537-bd5a99a7 delivered via SMTP
```

Delivery trace finale :

```json
{
  "emailBody": "Bonjour Terra Computer,...Merci de nous indiquer la procedure de retour...",
  "emailSubject": "[KBZ-SAV PH32.4B] Test email fournisseur avec contenu",
  "replyToAddress": "sav.ecomlg-001.69a11d97-...@inbound.keybuzz.io",
  "emailMessageId": "<8e4480ec-bf1d-aa9c-5171-737dba2392e4@keybuzz.io>",
  "status": "delivered"
}
```

---

## Conclusion

| Test | Resultat |
|------|----------|
| Supplier CRUD (GET/POST/DELETE) | OK |
| Supplier persistance apres refresh | OK |
| Supplier case creation + reply_to_address | OK |
| Send email → API 200 | OK |
| Message SUPPLIER_CONTACT en DB | OK |
| Delivery queued → delivered | **OK** |
| Email body non vide (242 chars) | **OK** |
| Subject personnalise | **OK** |
| Reply-To tokenise dans headers | **OK** |
| Worker logs confirment processing | **OK** |
| Pipeline complete en < 4s | OK |
