# PH26.5L — Aide IA : Upload capture/fichier + stockage MinIO + traçabilité

**Date** : 2026-01-31  
**Status** : ✅ Déployé (Phase 2 de PH26.5C)

---

## Objectif

Permettre aux utilisateurs d'uploader des fichiers (jpg/png/pdf) pour fournir du contexte à l'IA, avec stockage MinIO et traçabilité complète.

---

## 1. Migration DB

### Table créée : `ai_context_attachments`

```sql
CREATE TABLE ai_context_attachments (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  conversation_id TEXT NOT NULL,
  ai_action_log_id TEXT,
  minio_key TEXT NOT NULL,
  filename TEXT NOT NULL,
  mime_type TEXT NOT NULL,
  size_bytes BIGINT NOT NULL,
  sha256 TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by TEXT
);
```

### Index

- `idx_ai_context_att_tenant` (tenant_id)
- `idx_ai_context_att_conv` (conversation_id)
- `idx_ai_context_att_action` (ai_action_log_id)

---

## 2. Backend

### Nouveau fichier : `aiContextUpload.routes.ts`

**Endpoints créés** :

| Endpoint | Méthode | Description |
|----------|---------|-------------|
| `/api/v1/ai/context/upload` | POST | Upload fichiers (multipart) |
| `/api/v1/ai/context/attachments` | GET | Liste des fichiers d'une conversation |
| `/api/v1/ai/context/download/:id` | GET | Télécharger un fichier |

### Bucket MinIO

- Nom : `keybuzz-ai-context`
- Structure des clés : `ai-context/<tenantId>/<conversationId>/<fileId>/<filename>`

### Limites

| Limite | Valeur |
|--------|--------|
| Taille max par fichier | 10 Mo |
| Fichiers max par action | 5 |
| Types autorisés | jpg, png, pdf |

---

## 3. Client

### Routes API (Next.js proxy)

- `/api/ai/context/upload` → Forward multipart vers backend
- `/api/ai/context/download/[id]` → Proxy téléchargement

### UI modifiée : `AISuggestionSlideOver.tsx`

**Nouveaux états** :

```typescript
const [contextFiles, setContextFiles] = useState<File[]>([]);
const [uploadedFileIds, setUploadedFileIds] = useState<string[]>([]);
const [isUploading, setIsUploading] = useState(false);
```

**Nouvelles fonctions** :

- `handleFileSelect()` : Sélection fichiers
- `removeFile()` : Suppression fichier de la liste
- `uploadContextFiles()` : Upload vers backend

**UI ajoutée** :

1. Bouton "Ajouter des fichiers" avec input file
2. Liste des fichiers sélectionnés (nom + taille + bouton supprimer)
3. Badge "X fichier(s) ajouté(s)" après génération

---

## 4. Flux complet

```
1. Utilisateur clique "Aide IA"
2. Section contexte s'affiche (textarea + upload)
3. Utilisateur peut :
   - Coller du texte (PH26.5C)
   - Uploader des fichiers (PH26.5L)
4. Clic "Générer une suggestion"
5. → Si fichiers : upload vers MinIO via /api/ai/context/upload
6. → Insert dans ai_context_attachments
7. → Appel assistAI avec additionalContext enrichi
8. Badge "Contexte texte" + "X fichier(s)" s'affiche
```

---

## 5. Images déployées

| Service | Tag | Digest |
|---------|-----|--------|
| Backend | `v1.0.44-ph265l` | `sha256:42488108f11091a24305b93b1ea970d5cf49162c08e0bf44e3a030bd40fe9410` |
| Client | `v0.5.15-ph265l` | `sha256:70889d7aa3383d843a6fb06ff3d5eeb53ba23c5821ae1d03afe7e5c8cd42f7eb` |

---

## 6. Multi-tenant

Le stockage est isolé par tenant :

- Clé MinIO : `ai-context/<tenantId>/...`
- DB : `tenant_id` dans ai_context_attachments
- Vérification tenant dans tous les endpoints

---

## 7. Traçabilité

| Élément | Stocké |
|---------|--------|
| tenant_id | ✅ |
| conversation_id | ✅ |
| ai_action_log_id | ✅ (si fourni) |
| filename | ✅ |
| sha256 | ✅ |
| size_bytes | ✅ |
| created_by (email) | ✅ |
| created_at | ✅ |

---

## 8. Validation

### Test manuel

1. Aller sur une conversation dans l'Inbox
2. Cliquer "Aide IA"
3. Déplier "Ajouter du contexte"
4. Cliquer "Ajouter des fichiers"
5. Sélectionner un JPG/PNG/PDF
6. Vérifier que le fichier apparaît dans la liste
7. Cliquer "Générer une suggestion"
8. Vérifier le badge "X fichier(s) ajouté(s)"

### Vérification MinIO

```bash
kubectl exec -n keybuzz-backend-dev deployment/keybuzz-backend -- \
  node -e "const { Client } = require('minio'); /* list bucket */"
```

### Vérification DB

```sql
SELECT id, tenant_id, filename, size_bytes, created_at 
FROM ai_context_attachments 
ORDER BY created_at DESC LIMIT 5;
```

---

**STATUS** : ✅ Déployé
