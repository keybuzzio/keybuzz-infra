# PH32.3 — Supplier Reply-To Tokenise + Ingestion dans la Conversation

## Date : 2026-02-11
## Environnement : DEV
## Tag : `v3.3.4-ph323-supplier-replyto-dev`

---

## Objectif

Permettre :
- D'envoyer un email au fournisseur **depuis KeyBuzz**
- De recevoir sa reponse **automatiquement dans la bonne conversation**
- De conserver l'historique pour l'IA (`supplier_outbound` / `supplier_inbound`)

---

## 1. DB Migration

### Colonne ajoutee
```
ALTER TABLE supplier_cases ADD COLUMN reply_to_address TEXT;
CREATE INDEX idx_supplier_cases_reply_to ON supplier_cases (reply_to_address);
```

### Preuve DB
```
id                                   | tenant_id  | reply_to_address
--------------------------------------+------------+------------------------------------------------------------------------
fd5b54ff-7431-4241-bedd-fa199b9b75c4 | ecomlg-001 | sav.ecomlg-001.fd5b54ff-7431-4241-bedd-fa199b9b75c4@inbound.keybuzz.io
```

### Format Reply-To
```
sav.<tenantId>.<supplierCaseId>@inbound.keybuzz.io
```

---

## 2. Generation Reply-To

- A la creation d'un `supplier_case` (POST /supplier-cases), le `reply_to_address` est genere automatiquement
- Au premier envoi d'email (`POST /supplier-cases/:id/send-email`), le `reply_to_address` est genere si manquant (backfill)
- Le backfill SQL remplit les cases existants

---

## 3. Envoi Email Fournisseur

### Route API
```
POST /supplier-cases/:id/send-email
```

### Payload
```json
{
  "tenantId": "ecomlg-001",
  "conversationId": "cmmlghdrl51340b3c3ef64dac",
  "subject": "Demande SAV - Commande #123",
  "emailBody": "Bonjour...",
  "ccClientEmail": "client@example.com",
  "senderName": "Equipe SAV"
}
```

### Reponse (succes)
```json
{
  "success": true,
  "message": {
    "id": "msg-288a439830588062",
    "conversationId": "cmmlghdrl51340b3c3ef64dac",
    "direction": "outbound",
    "authorName": "Equipe SAV Test",
    "messageSource": "supplier_outbound"
  },
  "delivery": {
    "id": "dlv-1770844098475-850433ee",
    "targetAddress": "ludovic@ecomlg.fr",
    "replyToAddress": "sav.ecomlg-001.fd5b54ff-7431-4241-bedd-fa199b9b75c4@inbound.keybuzz.io",
    "status": "queued"
  }
}
```

### Headers Email
- `From`: support@keybuzz.io
- `Reply-To`: sav.ecomlg-001.fd5b54ff-...@inbound.keybuzz.io
- `To`: ludovic@ecomlg.fr (email fournisseur)

---

## 4. Inbound Router (Webhook Mail)

### Route API (nouveau)
```
POST /supplier-inbound
```

### Parsing
Quand un email arrive sur `sav.<tenantId>.<caseId>@inbound.keybuzz.io` :
1. Le webhook detecte le prefixe `sav.`
2. Parse le `tenantId` et `caseId`
3. Lookup dans `supplier_cases`
4. Insere un message `supplier_inbound` dans la conversation liee
5. Met a jour le statut du case (`pending_supplier` → `in_progress`)

### Preuve Test Inbound
```json
{
  "success": true,
  "messageId": "msg-52c6038a29b22fd6",
  "conversationId": "cmmlghdrl51340b3c3ef64dac",
  "supplierName": "Terra Computer France"
}
```

### Preuve DB Messages
```
id                   | direction | author_name           | message_source   | body_preview
---------------------+-----------+-----------------------+------------------+-----------------------------------------------
msg-52c6038a29b22fd6 | inbound   | Terra Computer France | SUPPLIER_INBOUND | [Reponse fournisseur — Terra Computer France]
msg-288a439830588062 | outbound  | Equipe SAV Test       | SUPPLIER_CONTACT | [Email fournisseur → Terra Computer France]
```

### Preuve Statut Case
```
id                                   | status      | reply_to_address                                                        | last_action_at
--------------------------------------+-------------+------------------------------------------------------------------------+------------------------------
fd5b54ff-7431-4241-bedd-fa199b9b75c4 | in_progress | sav.ecomlg-001.fd5b54ff-7431-4241-bedd-fa199b9b75c4@inbound.keybuzz.io | 2026-02-11 21:08:41.556607+00
```

---

## 5. UI — Badges Fournisseur

### Messages Outbound vers fournisseur
- Bulle **indigo** (distincte du bleu agent)
- Badge "Envoi fournisseur" avec icone Truck

### Messages Inbound du fournisseur
- Bulle **orange clair** avec bordure orange
- Badge "Fournisseur" avec icone Truck
- Position a gauche (comme les messages entrants)

### Modal "Contacter Fournisseur"
- Apres envoi reussi, message : "Les reponses du fournisseur arriveront automatiquement dans cette conversation"
- Affichage du `replyToAddress` dans les details de delivery

---

## 6. IA — Contexte Fournisseur

Les messages `SUPPLIER_CONTACT` et `SUPPLIER_INBOUND` sont stockes avec les `message_source` corrects.
Le prompt IA peut desormais :
- Filtrer les messages ou `message_source IN ('SUPPLIER_CONTACT', 'SUPPLIER_INBOUND')`
- Inclure le statut du `supplier_case` dans le contexte
- Generer des reponses contextuelles type "Nous avons contacte notre fournisseur et sommes en attente de retour."

Script bastion pour patch IA : `ph323_patch_ai_context.sh`

---

## 7. Fichiers Modifies

### keybuzz-api
- `src/modules/suppliers/suppliers.routes.ts` — +100 lignes (supplier-inbound, reply-to generation, send-email enrichi)
- `migrations/031_suppliers_and_cases.sql` — +15 lignes (reply_to_address column + index)

### keybuzz-client
- `app/inbox/InboxTripane.tsx` — Badges fournisseur (SUPPLIER_CONTACT, SUPPLIER_INBOUND)
- `app/api/supplier-cases/[id]/send-email/route.ts` — Proxy Next.js
- `src/features/inbox/components/ContactSupplierModal.tsx` — Affichage Reply-To
- `src/services/suppliers.service.ts` — sendSupplierEmail function

### keybuzz-infra
- `k8s/keybuzz-api-dev/deployment.yaml` → v3.3.4-ph323-supplier-replyto-dev
- `k8s/keybuzz-client-dev/deployment.yaml` → v3.3.4-ph323-supplier-replyto-dev

### Scripts bastion
- `ph323_extend_inbound_webhook.sh` — Patch webhook Postfix pour routage sav.*
- `ph323_patch_ai_context.sh` — Enrichissement contexte IA avec messages fournisseur

---

## 8. Securite

- Multi-tenant strict (`tenant_id` dans toutes les requetes)
- Aucun hardcode de tenant
- Pas de secrets en clair
- Reply-To tokenise (UUID non devinable)
- Isolation : les emails `sav.*` ne sont JAMAIS interpretes comme marketplace

---

## STOP POINT

**NE PAS deployer en PROD sans validation explicite de Ludovic.**

---

## Prochaines etapes (si validation)
1. Deployer en PROD (v3.3.4-ph323-supplier-replyto-prod)
2. Appliquer le patch webhook Postfix sur mail-core-01
3. Appliquer le patch IA sur keybuzz-api
4. Test E2E reel : envoyer un email a un fournisseur test et verifier la reponse
