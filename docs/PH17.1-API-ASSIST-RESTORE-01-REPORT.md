# PH17.1-API-ASSIST-RESTORE-01 — Rapport

**Date** : 2026-01-08  
**Statut** : ✅ TERMINÉ

---

## Résumé

Restauration de l'endpoint `/ai/assist` qui retournait 404 car l'image API déployée était obsolète.

---

## 1. Diagnostic

### Image API

| État | Version | Image |
|------|---------|-------|
| **Avant** | v0.1.59-dev | Obsolète (manque routes IA) |
| **Après** | v0.1.73-dev | À jour (toutes routes) |

### Endpoint /ai/assist

| État | Résultat |
|------|----------|
| **Avant** | 404 Not Found |
| **Après** | 200 OK + suggestions IA |

---

## 2. Actions Réalisées

1. **Diagnostic** : Confirmation que le code existe dans keybuzz-api mais l'image était obsolète
2. **Version bump** : `0.1.72-dev` → `0.1.73-dev`
3. **Build Docker** : `--no-cache` pour image fraîche
4. **Push GHCR** : `ghcr.io/keybuzzio/keybuzz-api:v0.1.73-dev`
5. **Déploiement** : Mise à jour du deployment K8s
6. **Correction secret** : Recréation de `keybuzz-api-postgres-static`

---

## 3. Preuves

### Endpoint 404 → 200

**AVANT** :
```json
{"message":"Route POST:/ai/assist not found","error":"Not Found","statusCode":404}
```

**APRÈS** :
```json
{
  "status": "success",
  "suggestions": [
    {
      "id": "sug-mk52iyi8xcox72",
      "type": "response",
      "content": "Bonjour,\n\nMerci pour votre message...",
      "confidence": 0.7,
      "confidenceLevel": "medium"
    },
    {
      "id": "sug-mk52iyi8h8prwz",
      "type": "reformulation",
      "content": "Reformulation plus professionnelle disponible...",
      "confidence": 0.6,
      "confidenceLevel": "medium"
    }
  ],
  "explanations": [
    {
      "id": "exp-mk52iyi8bj2ih2",
      "title": "Analyse du sentiment",
      "content": "Le client exprime une frustration modérée...",
      "type": "analysis"
    }
  ],
  "confidenceLevel": "medium",
  "disclaimer": "Suggestion générée par IA — à valider par un humain",
  "requestId": "air-mk52iyi8ey65mv"
}
```

### Autres endpoints (non régression)

| Endpoint | Status |
|----------|--------|
| `/health` | ✅ OK |
| `/tenant-context/me` | ✅ OK |
| `/messages/conversations` | ✅ OK |
| `/ai/settings` | ✅ OK |

---

## 4. Configuration PGHOST

Conformément à PH17, la DB utilise le LB :

```
PGHOST=10.0.0.10 (LB write)
```

---

## 5. Commits

| Repo | Commit | Message |
|------|--------|---------|
| keybuzz-api | `bf89a8e` | fix(PH17.1): restore ai/assist endpoint - bump to v0.1.73-dev |
| keybuzz-infra | `2e2da4d` | feat(PH17.1): update keybuzz-api to v0.1.73-dev |

---

## 6. Image Docker

```
ghcr.io/keybuzzio/keybuzz-api:v0.1.73-dev
digest: sha256:57d484390c89f91542a87f738b68c8d6815abc34af3a5653aa9a805d6760b2a2
```

---

## 7. UI IA Assistante

L'UI côté client (`AIAssistant.tsx`) utilise l'endpoint API via `NEXT_PUBLIC_API_URL`:

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://api-dev.keybuzz.io';
// POST /ai/assist
```

Fonctionnalités :
- ✅ Suggestions de réponses
- ✅ Reformulations
- ✅ Analyses de sentiment
- ✅ Disclaimer IA

---

**Fin du rapport PH17.1-API-ASSIST-RESTORE-01**
