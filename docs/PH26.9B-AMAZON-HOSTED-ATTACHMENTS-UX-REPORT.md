# PH26.9B - Amazon "Ã‰lÃ©ment photo" : UI explicite + CTA

**Date:** 2026-02-01  
**Status:** âœ… DÃ‰PLOYÃ‰ EN DEV

---

## 1. RÃ‰SUMÃ‰

Quand un message Amazon contient "Ã‰lÃ©ment photo" mais qu'aucune piÃ¨ce jointe n'est prÃ©sente dans le MIME, l'UI affiche maintenant un bloc explicite avec des actions claires.

---

## 2. IMPLÃ‰MENTATION

### 2.1 Backend (API)

**Fichier:** `keybuzz-api/src/modules/messages/routes.ts`

```typescript
// PH26.9B: Detect Amazon hosted attachment hints
const AMAZON_ATTACHMENT_PATTERNS = [
  /Ã©lÃ©ment\s*photo/i,
  /photo\s*item/i,
  /photo\s*element/i,
  /image\s*attachÃ©e/i,
  /attached\s*image/i,
  /piÃ¨ce\s*jointe\s*image/i,
];

function hasAmazonAttachmentHint(body: string): boolean {
  if (!body) return false;
  return AMAZON_ATTACHMENT_PATTERNS.some(pattern => pattern.test(body));
}
```

**Champ ajoutÃ© au message:**
```typescript
{
  ...msg,
  attachments,
  amazonAttachmentHint,  // PH26.9B: True if "Ã‰lÃ©ment photo" detected but no actual attachments
}
```

### 2.2 Frontend (Client)

**Fichier:** `keybuzz-client/app/inbox/InboxTripane.tsx`

**Interface mise Ã  jour:**
```typescript
interface LocalMessage {
  // ... existing fields
  amazonAttachmentHint?: boolean; // PH26.9B
}
```

**Bloc UI affichÃ©:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“· PiÃ¨ce jointe Amazon non transmise                            â”‚
â”‚                                                                 â”‚
â”‚ Amazon a signalÃ© une photo, mais le fichier n'a pas Ã©tÃ©        â”‚
â”‚ transmis dans l'email de notification.                          â”‚
â”‚                                                                 â”‚
â”‚ [ğŸ”— Ouvrir dans Seller Central]  [ğŸ“¤ Ajouter le fichier...]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. CONDITIONS D'AFFICHAGE

| Condition | Valeur requise |
|-----------|----------------|
| `msg.amazonAttachmentHint` | `true` |
| `msg.attachments.length` | `0` |

Le bloc ne s'affiche que si les deux conditions sont vraies.

---

## 4. ACTIONS CTA

### Bouton 1: Ouvrir dans Seller Central
- **URL:** `https://sellercentral.amazon.fr/messaging/inbox`
- **Comportement:** Ouvre dans un nouvel onglet
- **Style:** Ambre/Warning

### Bouton 2: Ajouter le fichier manuellement
- **Comportement:** Ouvre le sÃ©lecteur de fichier (utilise `fileInputRef.current?.click()`)
- **Style:** Bleu/Primary
- **Formats acceptÃ©s:** `.pdf, .jpg, .jpeg, .png, .gif`

---

## 5. PATTERNS DÃ‰TECTÃ‰S

Les patterns suivants dÃ©clenchent `amazonAttachmentHint=true`:

| Pattern | Regex |
|---------|-------|
| Ã‰lÃ©ment photo | `/Ã©lÃ©ment\s*photo/i` |
| Photo item | `/photo\s*item/i` |
| Photo element | `/photo\s*element/i` |
| Image attachÃ©e | `/image\s*attachÃ©e/i` |
| Attached image | `/attached\s*image/i` |
| PiÃ¨ce jointe image | `/piÃ¨ce\s*jointe\s*image/i` |

---

## 6. TESTS E2E

### Conversation Bariere (ecomlg-001)

| Test | RÃ©sultat attendu |
|------|------------------|
| Message "Ã‰lÃ©ment photo" sans PJ | Bloc affichÃ© âœ… |
| Bouton Seller Central | Ouvre nouvelle fenÃªtre âœ… |
| Bouton "Ajouter fichier" | Ouvre sÃ©lecteur fichier âœ… |
| Liste attachments | Ne ment pas (vide si vide) âœ… |

---

## 7. DÃ‰PLOIEMENT

### Images

| Service | Tag | Digest |
|---------|-----|--------|
| API | `v0.4.30-amazon-hint` | `sha256:e16c1e9a6e21...` |
| Client | `v0.5.29-amazon-hint` | `sha256:7db4ce5ac6ad...` |

### Manifests K8s

- `k8s/keybuzz-api-dev/deployment.yaml` - Mis Ã  jour
- `k8s/keybuzz-client-dev/deployment.yaml` - Mis Ã  jour

---

## 8. FICHIERS MODIFIÃ‰S

| Fichier | Changement |
|---------|------------|
| `keybuzz-api/src/modules/messages/routes.ts` | Ajout dÃ©tection + champ `amazonAttachmentHint` |
| `keybuzz-client/app/inbox/InboxTripane.tsx` | Ajout bloc UI + icÃ´nes Camera/Upload |

---

## 9. NON-RÃ‰GRESSION

- âœ… Les vrais attachments s'affichent normalement
- âœ… Le bloc n'apparaÃ®t PAS si attachments prÃ©sents
- âœ… Le bloc n'apparaÃ®t PAS sans pattern "Ã‰lÃ©ment photo"
- âœ… L'upload fonctionne normalement

---

**Rapport gÃ©nÃ©rÃ© - PH26.9B Amazon Hosted Attachments UX**
