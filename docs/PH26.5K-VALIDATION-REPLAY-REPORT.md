# PH26.5K — Validation: Raw MIME Storage + Replay

**Date** : 2026-01-30  
**Status** : ✅ Validé (simulation complète)

---

## 1. État DB avant validation

### Messages avec raw_mime_key

```
with_raw_mime | without_raw_mime | total 
--------------+------------------+-------
            0 |              323 |   323
```

**Note** : Tous les messages existants n'ont pas de raw_mime car ils ont été créés avant le déploiement de PH26.5K.

### Messages "placeholder" existants

| msg_id | direction | body | has_raw |
|--------|-----------|------|---------|
| msg-176898... | outbound | test | false |
| msg-176894... | outbound | test | false |
| msg-176894... | outbound | essai | false |

**Note** : Les placeholders existants sont des messages outbound (tests), pas des inbound avec MIME incomplet.

---

## 2. Preuve MinIO

### Configuration parsée

```json
{
  "host": "10.0.0.11",
  "port": 9000,
  "useSSL": false
}
```

### Bucket créé

```
Bucket keybuzz-raw-mime exists: false
Bucket created successfully
All buckets: [ 'keybuzz-attachments', 'keybuzz-raw-mime' ]
```

### Preuve de stockage (simulation)

| Paramètre | Valeur |
|-----------|--------|
| Tenant | ecomlg-001 |
| MessageId | test-ph265k-1769843435366 |
| Key | `raw-mime/ecomlg-001/test-ph265k-1769843435366.eml` |
| Size | 679 bytes |
| SHA256 | `cb7fb1d5ada56f74c0dc9d0af89fc0d4...` |

### Vérification intégrité

```
MinIO size: 679 bytes
Size match: true

Retrieved size: 679 bytes
Hash match: true
```

---

## 3. Code déployé

### Vérification présence PH26.5K

```bash
kubectl exec deployment/keybuzz-backend -- grep 'storeRawMime' /app/dist/modules/webhooks/inboxConversation.service.js
```

**Résultat** :
```
async function storeRawMime(tenantId, messageId, rawMime) {
                const mimeInfo = await storeRawMime(tenantId, msgId, rawBody);
```

✅ Fonction `storeRawMime` présente et appelée dans le flux d'ingestion.

---

## 4. Replay (non applicable)

### État actuel

- Aucun message avec `raw_mime_key` rempli (tous antérieurs au déploiement)
- Aucun message inbound placeholder avec raw MIME stocké

### Conclusion

Le replay ne peut pas être testé sur les données existantes car :
1. Les anciens messages n'ont pas de raw MIME stocké
2. Le stockage raw MIME ne s'applique qu'aux nouveaux messages

**Action requise** : Le replay pourra être testé après réception d'un nouveau message inbound Amazon.

---

## 5. Résumé validation

| Test | Résultat |
|------|----------|
| Migration DB (colonnes) | ✅ OK |
| Bucket MinIO créé | ✅ OK |
| Stockage raw MIME | ✅ OK (simulation) |
| Taille correcte | ✅ OK |
| Intégrité SHA256 | ✅ OK |
| Code déployé | ✅ OK |
| Replay | ⏳ En attente nouveau message |

---

## 6. Image déployée

| Service | Tag | Digest |
|---------|-----|--------|
| Backend | `v1.0.43-ph265k` | `sha256:90738239835d065e305fc00043d98872cedcf11e36016590021e84616dfcb1f1` |

---

## 7. Prochaines étapes

1. **Attendre un message inbound Amazon** avec PJ
2. **Vérifier les logs** :
   ```bash
   kubectl logs -n keybuzz-backend-dev deployment/keybuzz-backend --tail=100 | grep "PH26.5K"
   ```
3. **Vérifier la DB** :
   ```sql
   SELECT id, raw_mime_key, raw_mime_size_bytes 
   FROM messages 
   WHERE raw_mime_key IS NOT NULL 
   ORDER BY created_at DESC LIMIT 5;
   ```
4. **Tester le replay** si un message a un body placeholder

---

**STATUS** : ✅ Validation technique complète (simulation réussie)
