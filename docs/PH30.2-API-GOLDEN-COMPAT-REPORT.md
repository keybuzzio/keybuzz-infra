# PH30.2 - API Compatibility pour le client GOLDEN

**Date:** 2026-02-05  
**Statut:** COMPLETE  
**Environnements:** DEV + PROD

---

## Objectif

Rendre l'API compatible avec le client GOLDEN (ef961c8), sans modifier le client.

---

## 1. Endpoints requis par le client GOLDEN

Extraction depuis l'image `ghcr.io/keybuzzio/keybuzz-client:menu-fr-ph28.26-2026-02-03` (commit ef961c8):

| Endpoint | MÃ©thode | UtilisÃ© par |
|----------|---------|-------------|
| `/stats/dashboard` | GET | Dashboard |
| `/stats/conversations` | GET | Dashboard |
| `/stats/sla` | GET | Dashboard |
| `/marketplaces/octopia/status` | GET | Canaux |
| `/marketplaces/octopia/connect` | POST | Canaux |
| `/marketplaces/octopia/disconnect` | POST | Canaux |
| `/marketplaces/octopia/test` | POST | Canaux |
| `/marketplaces/octopia/sync/run` | POST | Canaux |
| `/marketplaces/octopia/config` | GET | Canaux |
| `/api/v1/orders` | GET | Commandes |
| `/conversations` | GET | Messages |
| `/returns/by-order` | GET | Retours |
| `/returns/by-conversation` | GET | Retours |

**Note:** Le client GOLDEN utilise le header `X-Tenant-Id` (pas query param).

---

## 2. Tests AVANT correction (DEV)

```
GET /stats/dashboard              â†’ 404 Not Found
GET /stats/conversations          â†’ 404 Not Found
GET /stats/sla                    â†’ 404 Not Found
GET /marketplaces/octopia/status  â†’ 404 Not Found
GET /api/v1/orders                â†’ 404 Not Found
GET /conversations                â†’ 404 Not Found
GET /returns/by-order             â†’ 404 Not Found
GET /returns/by-conversation      â†’ 404 Not Found
```

---

## 3. Corrections appliquÃ©es

### Nouveaux fichiers crÃ©Ã©s:

1. **`src/modules/stats/routes.ts`**
   - `/stats/dashboard` â†’ Dashboard complet avec KPIs
   - `/stats/conversations` â†’ Compteurs conversations
   - `/stats/sla` â†’ Statistiques SLA

2. **`src/modules/compat/routes.ts`**
   - `/marketplaces/octopia/*` â†’ Aliases vers `/octopia/*`
   - `/api/v1/orders` â†’ Liste commandes
   - `/conversations` â†’ Alias vers `/messages/conversations`
   - `/returns/by-order` â†’ Retours par commande
   - `/returns/by-conversation` â†’ Retours par conversation

### Modifications:
- `src/app.ts` â†’ Import et enregistrement des routes compat

### Commits:
- `6d51830` - PH30.2: Add GOLDEN client API compatibility layer

---

## 4. Tests APRÃˆS correction (DEV)

```
GET /stats/dashboard              â†’ 200 OK
GET /stats/conversations          â†’ 200 OK
GET /stats/sla                    â†’ 200 OK
GET /marketplaces/octopia/status  â†’ 200 OK
GET /marketplaces/octopia/config  â†’ 200 OK
GET /api/v1/orders                â†’ 200 OK
GET /conversations                â†’ 200 OK
GET /returns/by-order             â†’ 200 OK
GET /returns/by-conversation      â†’ 200 OK
```

---

## 5. Tests PROD

```
GET /stats/dashboard              â†’ 200 OK
GET /stats/conversations          â†’ 200 OK
GET /stats/sla                    â†’ 200 OK
GET /marketplaces/octopia/status  â†’ 200 OK
GET /api/v1/orders                â†’ 200 OK
GET /conversations                â†’ 200 OK
GET /returns/by-order             â†’ 200 OK
GET /returns/by-conversation      â†’ 200 OK
```

---

## 6. Images dÃ©ployÃ©es

| Environnement | Image | Digest |
|---------------|-------|--------|
| **DEV** | `ghcr.io/keybuzzio/keybuzz-api:ph30.2-golden-compat-dev-2026-02-05` | `sha256:c26eb5b26b11f77d8ce5ae38b213f32672251d133ceaf7ed448bf9c99cba8584` |
| **PROD** | `ghcr.io/keybuzzio/keybuzz-api:ph30.2-golden-compat-prod-2026-02-05` | `sha256:c26eb5b26b11f77d8ce5ae38b213f32672251d133ceaf7ed448bf9c99cba8584` |

---

## 7. Rollback

En cas de problÃ¨me, revenir aux images prÃ©cÃ©dentes:

**DEV:**
```bash
kubectl -n keybuzz-api-dev set image deployment/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:ph29.6-octopia-dev-2026-02-05
```

**PROD:**
```bash
kubectl -n keybuzz-api-prod set image deployment/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:ph29.3-parity-2026-02-04
```

---

## Conclusion

L'API est maintenant compatible avec le client GOLDEN. Tous les endpoints requis retournent 200 et acceptent le header `X-Tenant-Id`.

**Client intouchable:** âœ… Aucune modification du client  
**GitOps strict:** âœ… Tout versionnÃ© dans Git  
**Rollback possible:** âœ… Images immuables  
**Preuve curl:** âœ… Avant/aprÃ¨s documentÃ©