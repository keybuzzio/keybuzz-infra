# PH26.7 - IA Guardrails & Anti-Refus Report

**Date:** 2026-02-01  
**Version API:** v1.0.40-guardrails  
**Digest:** `sha256:0fc2cdaf1c6bbc80e7b5e8b155963b9670c7a149ab75a57b8dea413c90049f6f`

---

## 1. RÉSUMÉ

Implémentation des guardrails IA pour éliminer définitivement les réponses de type "refus" et garantir que l'IA aide toujours le vendeur.

| Composant | Status |
|-----------|--------|
| System Prompt Immutable | ✅ |
| Contexte Global KeyBuzz | ✅ |
| Anti-Refusal Guard | ✅ |
| Retry automatique | ✅ |
| Déploiement | ✅ |

---

## 2. SYSTEM PROMPT IMMUTABLE

### Code implémenté

```typescript
// PH26.7: Immutable System Prompt - NEVER MODIFY
const KEYBUZZ_IMMUTABLE_SYSTEM_PROMPT = `Tu es KeyBuzz IA, un assistant professionnel dedie aux vendeurs e-commerce.

Ton role est d'aider le vendeur a rediger des reponses claires, professionnelles et conformes aux regles des marketplaces (Amazon, etc.).

Tu n'es pas Amazon.
Tu ne representes pas la marketplace.
Tu aides toujours le vendeur.

REGLES ABSOLUES :
- Tu ne refuses JAMAIS d'aider.
- Tu ne reponds jamais "je ne peux pas aider", "je suis desole mais...", ou equivalent.
- Si une situation est sensible, tu proposes une reponse professionnelle, factuelle et neutre.
- Si une escalade est possible, tu l'indiques dans la reponse, sans refuser d'aider.
- Tu fournis toujours une reponse exploitable par le vendeur.
- Si les informations sont incompletes, tu fais une hypothese raisonnable ou tu proposes une reponse conditionnelle.
`;
```

### Caractéristiques
- **Position:** Injecté AVANT tout autre contenu
- **Modifiable:** NON (hardcodé)
- **Langue:** Français (prompt système)

---

## 3. CONTEXTE GLOBAL KEYBUZZ (Phase 1)

### Code implémenté

```typescript
// PH26.7: Global KeyBuzz Context (Phase 1)
const KEYBUZZ_GLOBAL_CONTEXT = `
Contexte KeyBuzz :
- Le vendeur expedie uniquement des produits neufs.
- Les retours sont traites conformement aux procedures Amazon.
- Le vendeur privilegie des reponses calmes, factuelles et professionnelles.
- L'objectif est d'eviter l'escalade inutile tout en defendant les droits du vendeur.
`;
```

### Évolution prévue (Admin)
- Contexte global plateforme (configurable admin)
- Contexte spécifique client (par tenant)

---

## 4. ANTI-REFUSAL GUARD

### Patterns détectés

```typescript
const REFUSAL_PATTERNS = [
  /je ne peux pas/i,
  /je ne suis pas en mesure/i,
  /desole,? mais/i,
  /I can'?t help/i,
  /I'?m not able to/i,
  /I cannot/i,
  /je suis dans l'impossibilite/i,
  /il m'est impossible/i,
  /je ne suis pas autorise/i,
  /I'?m sorry,? but/i,
  /unfortunately,? I cannot/i,
];
```

### Fonction de détection

```typescript
function detectRefusal(response: string): boolean {
  return REFUSAL_PATTERNS.some(pattern => pattern.test(response));
}
```

### Instruction de retry

```typescript
const ANTI_REFUSAL_INSTRUCTION = `
ATTENTION: Ta reponse precedente contenait un refus.
Tu dois reformuler une reponse professionnelle aidant le vendeur, sans refuser.
Propose une reponse factuelle et exploitable.
Rappelle-toi: tu aides TOUJOURS le vendeur, meme dans les situations delicates.
`;
```

### Logique de retry

```typescript
// PH26.7: Anti-refusal guard - detect and retry if needed
let llmContent = result.content || '';
if (detectRefusal(llmContent)) {
  console.log('[AI Assist] PH26.7: Refusal detected in response, retrying with anti-refusal instruction');
  const retryMessages = [
    ...messages,
    { role: 'assistant' as const, content: llmContent },
    { role: 'user' as const, content: ANTI_REFUSAL_INSTRUCTION }
  ];
  const retryResult = await chatCompletion(
    tenantId,
    undefined,
    'assist-retry',
    retryMessages,
    { maxTokens: 1024, temperature: 0.7 }
  );
  if (retryResult.content) {
    llmContent = retryResult.content;
    console.log('[AI Assist] PH26.7: Retry completed, refusal resolved');
  }
}
```

---

## 5. FLUX COMPLET

```
┌──────────────────────────────────────────────────────────────┐
│                    REQUÊTE UTILISATEUR                        │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  1. KEYBUZZ_IMMUTABLE_SYSTEM_PROMPT                          │
│     (Non modifiable, règles absolues)                        │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  2. KEYBUZZ_GLOBAL_CONTEXT                                   │
│     (Contexte vendeur standard)                              │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  3. Règles de langue + Contexte commande (si applicable)     │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  4. Contexte utilisateur (texte + fichiers)                  │
│     PRIORITAIRE sur hypothèses IA                            │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  5. Conversation (tous messages)                             │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                    APPEL LLM                                  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  6. ANTI-REFUSAL GUARD                                       │
│     detectRefusal(response) ?                                │
│        OUI → Retry avec ANTI_REFUSAL_INSTRUCTION             │
│        NON → Continuer                                       │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                    RÉPONSE FINALE                            │
│              (Toujours exploitable)                          │
└──────────────────────────────────────────────────────────────┘
```

---

## 6. EXEMPLES AVANT/APRÈS

### Cas 1: Litige emballage

**AVANT (refus potentiel):**
```
Je suis désolé, mais je ne peux pas vous aider avec ce litige car 
les informations sont insuffisantes...
```

**APRÈS (avec guardrails):**
```
Bonjour,

Je comprends votre préoccupation concernant l'emballage de votre commande.

Concernant votre remarque sur le conditionnement :
- Nos produits sont systématiquement expédiés neufs et dans leur emballage d'origine
- L'emballage de livraison est conforme aux standards de protection

Si vous constatez un problème avec le produit lui-même, nous vous invitons à :
1. Vérifier le contenu de la commande
2. Nous contacter avec des photos si nécessaire
3. Utiliser la procédure de retour Amazon si applicable

Nous restons à votre disposition pour toute question complémentaire.

Cordialement
```

### Cas 2: Situation sensible (A-to-Z)

**AVANT (refus potentiel):**
```
Je ne suis pas en mesure de vous conseiller sur les réclamations A-to-Z...
```

**APRÈS (avec guardrails):**
```
Bonjour,

Face à cette situation, voici les éléments factuels à considérer :

1. **Votre position de vendeur:**
   - Les produits ont été expédiés neufs conformément à votre politique
   - L'emballage était conforme aux standards

2. **Documentation recommandée:**
   - Conservez les preuves d'expédition
   - Documentez l'état du produit avant envoi si possible

3. **Options disponibles:**
   - Répondre factionnellement à la réclamation
   - Fournir les preuves d'expédition
   - Si escalade nécessaire, contacter le support Seller Central

Je vous conseille de rester calme et factuel dans vos échanges.

Cordialement
```

---

## 7. TEST E2E - CAS FOURNI

### Contexte du test
- **Conversation:** Tal — Order 405-6499160-2621952
- **Contexte utilisateur:** Produits expédiés neufs, pas d'occasion, emballage conforme, réserve livraison nécessaire

### Résultat attendu
- ❌ Pas de refus
- ✅ Réponse structurée avec :
  - Rappel produit neuf
  - Clarification emballage
  - Procédure Amazon
  - Ton calme
  - Option escalade si nécessaire

### Logs de vérification
```bash
# Vérifier les logs en cas de refus détecté
kubectl logs -n keybuzz-api-dev deployment/keybuzz-api | grep "PH26.7"
```

---

## 8. LIMITATIONS CONNUES

| Limitation | Impact | Mitigation |
|------------|--------|------------|
| Retry consomme des tokens supplémentaires | Coût légèrement plus élevé si refus | Refus rares avec nouveau prompt |
| Patterns en français/anglais uniquement | Autres langues non détectées | Ajouter patterns si besoin |
| Un seul retry | Refus persistant possible | Double retry si nécessaire |

---

## 9. MONITORING

### Logs à surveiller
```
[AI Assist] PH26.7: Refusal detected in response, retrying with anti-refusal instruction
[AI Assist] PH26.7: Retry completed, refusal resolved
```

### Métriques suggérées (futur)
- Nombre de refus détectés par jour
- Taux de succès du retry
- Temps de réponse moyen avec retry

---

## 10. FICHIERS MODIFIÉS

| Fichier | Modifications |
|---------|---------------|
| `keybuzz-api/src/modules/ai/ai-assist-routes.ts` | +60 lignes (prompts, detection, retry) |
| `keybuzz-infra/k8s/keybuzz-api-dev/deployment.yaml` | Image → v1.0.40-guardrails |

---

## 11. DÉPLOIEMENT

```
Image: ghcr.io/keybuzzio/keybuzz-api:v1.0.40-guardrails
Digest: sha256:0fc2cdaf1c6bbc80e7b5e8b155963b9670c7a149ab75a57b8dea413c90049f6f
Namespace: keybuzz-api-dev
Status: ✅ Running
```

---

**Rapport généré automatiquement - PH26.7 IA Guardrails Anti-Refus**
