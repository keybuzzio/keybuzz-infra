# PH32.3 PROD-B — Mail-Core-01 Routage SAV Fournisseur — REPORT

**Date** : 2026-02-11
**Phase** : PROD-B (routage mail reel)
**Statut** : COMPLETE

---

## Objectif

Activer sur `mail-core-01` le routage automatique des reponses fournisseur (`sav.<tenantId>.<caseId>@inbound.keybuzz.io`) vers l'endpoint `POST /supplier-inbound` de l'API PROD.

---

## 1. Diff du script webhook

### Fichiers sur mail-core-01

| Fichier | MD5 | Taille |
|---------|-----|--------|
| `/usr/local/bin/postfix_webhook.sh` (patche) | `36061b982ac753d9134f14f236e74b7a` | 241 lignes |
| `/usr/local/bin/postfix_webhook.sh.bak.ph323` (backup) | `d40839ed948c1ca8f096e643f2abe915` | ~5553 octets |

### Changements principaux

Le script original envoyait **tous** les emails aux webhooks DEV/PROD (marketplace). Le patch ajoute une detection en amont :

```diff
+ # PH32.3: SAV Supplier Inbound — DRY_RUN control
+ SAV_DRY_RUN_FILE="/opt/keybuzz/secrets/sav_dryrun"
+ SAV_API_DEV="https://api-dev.keybuzz.io"
+ SAV_API_PROD="https://api.keybuzz.io"
+ SAV_LOG="/var/log/keybuzz/sav_inbound.log"
+
+ # Apres extraction des headers (FROM, TO, SUBJECT, MESSAGE_ID) :
+ TO_LOCAL=$(echo "$TO" | sed 's/@.*//' | tr '[:upper:]' '[:lower:]')
+
+ if echo "$TO_LOCAL" | grep -q "^sav\."; then
+     # Route vers POST /supplier-inbound (API directe)
+     # Si DRY_RUN_FILE existe → log only, pas d'API call
+     # Sinon → LIVE: appel API PROD puis DEV en fallback
+     ...
+     exit 0  # Ne PAS continuer vers le webhook marketplace
+ fi
+
  # Le reste du script (marketplace amazon.*) reste IDENTIQUE
```

### Points cles du patch

- **Detection** : `if echo "$TO_LOCAL" | grep -q "^sav\."` → intercepte uniquement les `sav.*`
- **DRY_RUN** : Controle via fichier `/opt/keybuzz/secrets/sav_dryrun` (existe = dry-run, absent = live)
- **API call** : `POST $SAV_API_PROD/supplier-inbound` avec fallback `$SAV_API_DEV`
- **Log separe** : `/var/log/keybuzz/sav_inbound.log` (n'interfere pas avec les logs marketplace)
- **Exit precoce** : Les emails `sav.*` ne passent PAS par le webhook marketplace (exit 0 apres traitement)
- **Non-regression** : Les emails `amazon.*` continuent le flux normal (aucun code marketplace modifie)

---

## 2. Logs Dry-Run (Phase 1)

```
[2026-02-11 23:17:46] SAV_DETECTED from=sav@terra-computer.fr to=sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io messageId=dryrun-1770851865@test.fr
[2026-02-11 23:17:46] DRY_RUN: Would route sav email — from=sav@terra-computer.fr to=sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io subject=DRY-RUN TEST PH32.3
[2026-02-11 23:17:46] DRY_RUN: Parsed local-part=sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6
[2026-02-11 23:17:46] DRY_RUN: Body preview=Test dry-run.
[2026-02-11 23:17:46] DRY_RUN: No API call made. No DB insertion.
```

**Preuve DB dry-run** : 1 seul message SUPPLIER_INBOUND existait (simulation PROD-A), aucun nouveau cree.

---

## 3. Logs Live (Phase 2)

```
[2026-02-11 23:19:15] SAV_DETECTED from=sav@terra-computer.fr to=sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io messageId=live-test-1770851954@terra-computer.fr
[2026-02-11 23:19:15] LIVE: Routing sav email to supplier-inbound API
[2026-02-11 23:19:15] LIVE_OK api=https://api.keybuzz.io status=201 response={"success":true,"messageId":"msg-3fcdf797161ed132","conversationId":"cmmlghdrl51340b3c3ef64dac","supplierName":"Terra Computer France"}
[2026-02-11 23:19:15] SAV_RESULT: SUCCESS — message routed to conversation
```

---

## 4. Preuve DB — Message cree (LIVE)

```
SUPPLIER_INBOUND total count: 2
  msg-3fcdf797161ed132 | inbound | SUPPLIER_INBOUND | 2026-02-11T23:19:15.000Z | LIVE TEST PH32.3 - Piece de rechange expedie
  msg-f1edf625bd359c98 | inbound | SUPPLIER_INBOUND | 2026-02-11T22:55:00.000Z | RE: Demande SAV (simulation PROD-A)

Supplier case:
  df027be2-e14c-4cc2-a80d-e6802d4bc3d6 | status: in_progress | reply: sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io | last_action: 2026-02-11T23:19:15.699Z
```

Le message `msg-3fcdf797161ed132` a ete cree automatiquement par le routage mail reel, pas par simulation API.

---

## 5. Preuve non-regression inbound Amazon

Emails Amazon traites normalement **apres** le deploiement du patch :

```
[2026-02-11 18:35:37] INBOUND_RECEIVED from=Communications Amazon Seller Central to=amazon.ecomlg-001.fr.3jcpvk@inbound.keybuzz.io
[2026-02-11 18:35:38] INBOUND_POST_OK endpoint=DEV status=200
[2026-02-11 18:35:38] INBOUND_RESULT success=1 fail=0

[2026-02-11 19:06:09] INBOUND_RECEIVED from=Victoria ...@marketplace.amazon.fr to=amazon.ecomlg-001.fr.3jcpvk@inbound.keybuzz.io
[2026-02-11 19:06:10] INBOUND_POST_OK endpoint=DEV status=200
[2026-02-11 19:06:10] INBOUND_RESULT success=1 fail=0
```

Aucune regression detectee. Les emails `amazon.*` continuent d'etre routes vers les webhooks inbound-email.

---

## 6. Plan de rollback

### Commande unique :

```bash
ssh mail-core-01 'cp /usr/local/bin/postfix_webhook.sh.bak.ph323 /usr/local/bin/postfix_webhook.sh'
```

### Pour reactiver le dry-run sans rollback :

```bash
ssh mail-core-01 'touch /opt/keybuzz/secrets/sav_dryrun'
```

### Verification apres rollback :

```bash
ssh mail-core-01 'md5sum /usr/local/bin/postfix_webhook.sh'
# Doit retourner: d40839ed948c1ca8f096e643f2abe915
```

---

## 7. Resume

| Element | Statut |
|---------|--------|
| Backup script original | `/usr/local/bin/postfix_webhook.sh.bak.ph323` |
| Patch deploye | Oui, LIVE |
| Dry-run valide | Oui — logs corrects, 0 DB insertion |
| Live valide | Oui — API 201, message cree en DB |
| Non-regression Amazon | Oui — 2 emails Amazon traites normalement apres patch |
| Rollback pret | Oui — 1 commande `cp .bak.ph323 .sh` |
| Postfix modifie | Non (seul le script webhook a change) |
| DNS modifie | Non |
| Transport map modifie | Non |

---

**Conclusion** : Le routage reel des reponses fournisseur est actif sur PROD. Les emails envoyes a `sav.<tenantId>.<caseId>@inbound.keybuzz.io` sont automatiquement inseres dans la conversation associee en tant que messages `SUPPLIER_INBOUND`.
