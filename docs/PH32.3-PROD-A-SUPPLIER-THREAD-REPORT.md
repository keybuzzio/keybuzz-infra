# PH32.3 PROD-A — Supplier Thread (API + UI only)

## Date : 2026-02-11
## Environnement : **PRODUCTION**
## Status : **PROD-A DEPLOYED**

---

## Images Deployes

### API PROD
- **Tag** : `ghcr.io/keybuzzio/keybuzz-api:v3.3.4-ph323-supplier-replyto-prod`
- **Digest** : `sha256:4649eea1ae8a293c054ee32b53a340896723a49552fa17f7c9daddcdcc77bde8`
- **Rollback** : `v3.3.0-ph32-sav-prod`

### Client PROD
- **Tag** : `ghcr.io/keybuzzio/keybuzz-client:v3.3.4-ph323-supplier-replyto-prod`
- **Digest** : `sha256:50718512533316730339890acb641fcc9e8c742ae7d9cbd4f964fc072c0cf1ea`
- **Rollback** : `v3.3.3-ph34-kpi-prod`

---

## DB Migration PROD

Executee via `kubectl exec` + Node.js dans le pod API PROD.

Tables creees/mises a jour :
- `suppliers` (15 colonnes)
- `supplier_cases` (10 colonnes, incluant `reply_to_address`)
- Index `idx_supplier_cases_reply_to`
- Triggers `updated_at` sur les deux tables

---

## Preuves E2E PROD

### 1. Supplier cree
```json
{
  "id": "0048b66c-1d8e-48b7-86ed-b0319a0b5273",
  "tenant_id": "ecomlg-001",
  "name": "Terra Computer France",
  "email": "ludovic@ecomlg.fr",
  "support_email": "sav@terra-computer.fr"
}
```

### 2. Supplier Case cree (avec Reply-To genere)
```json
{
  "id": "df027be2-e14c-4cc2-a80d-e6802d4bc3d6",
  "tenant_id": "ecomlg-001",
  "conversation_id": "cmmlghdrl51340b3c3ef64dac",
  "status": "pending_supplier",
  "reply_to_address": "sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io"
}
```

### 3. Email envoye au fournisseur (supplier_outbound)
```json
{
  "success": true,
  "message": {
    "id": "msg-abe1dea4381d487b",
    "direction": "outbound",
    "authorName": "Equipe SAV eComLG",
    "messageSource": "supplier_outbound"
  },
  "delivery": {
    "id": "dlv-1770850297447-8ff84e16",
    "targetAddress": "sav@terra-computer.fr",
    "replyToAddress": "sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io",
    "status": "queued"
  }
}
```

### 4. Reponse fournisseur simulee (supplier_inbound)
```json
{
  "success": true,
  "messageId": "msg-f1edf625bd359c98",
  "conversationId": "cmmlghdrl51340b3c3ef64dac",
  "supplierName": "Terra Computer France"
}
```

### 5. Verification DB — 2 messages dans la conversation
```
msg-f1edf625bd359c98 | inbound  | SUPPLIER_INBOUND | Terra Computer France
msg-abe1dea4381d487b | outbound | SUPPLIER_CONTACT | Equipe SAV eComLG
```

### 6. Statut case auto-update
```
df027be2-e14c-4cc2-a80d-e6802d4bc3d6 | in_progress | sav.ecomlg-001.df027be2-...@inbound.keybuzz.io
```
Le statut est passe automatiquement de `pending_supplier` a `in_progress` apres la reception simulee.

### 7. Reply-To tokenise (exemple)
```
sav.ecomlg-001.df027be2-e14c-4cc2-a80d-e6802d4bc3d6@inbound.keybuzz.io
```
Format : `sav.<tenantId>.<caseId>@inbound.keybuzz.io`

---

## UI Badges

- Messages `supplier_outbound` : bulle **indigo** + badge "Envoi fournisseur" avec icone Truck
- Messages `supplier_inbound` : bulle **orange** + badge "Fournisseur" avec icone Truck
- Le modal "Contacter fournisseur" affiche : "Les reponses du fournisseur arriveront automatiquement dans cette conversation"

---

## Confirmation de securite

**Mail-core-01 NON modifie (PROD-A safe)**

- Aucun script webhook Postfix n'a ete applique
- Aucune modification DNS/transport map
- Aucune automatisation IA deployee
- Le routage mail reel n'est PAS actif (PROD-A = API + UI uniquement)
- `POST /supplier-inbound` est disponible pour simulation manuelle uniquement

---

## GitOps

- Commit infra : `deploy(PH32.3-PROD-A): supplier Reply-To + badges v3.3.4 - mail-core NOT modified`
- Pushed to `keybuzzio/keybuzz-infra` main branch
- Images immuables avec tags et digests documentes
- Rollback tags documentes

---

## STOP POINT

**NE PAS lancer PROD-B.**

Question a poser a Ludovic :
> "Souhaites-tu activer le routage mail reel (PROD-B) sur mail-core-01 ?"
