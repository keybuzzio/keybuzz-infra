# PH25.10D-AI-ACTIONS-DEBIT-SOURCE-OF-TRUTH-01 - Rapport

**Date**: 2026-01-26
**Environnement**: DEV uniquement
**Statut**: COMPLETE

## Objectif

Faire des Actions IA la source de vérité UX (le client ne voit plus les $), avec décompte atomique et idempotent sur chaque génération IA.

## 1. Tables DB créées

### `ai_actions_wallet`
```sql
CREATE TABLE ai_actions_wallet (
  tenant_id VARCHAR(64) PRIMARY KEY,
  remaining INTEGER NOT NULL DEFAULT 0,
  purchased_remaining INTEGER NOT NULL DEFAULT 0,
  included_monthly INTEGER NOT NULL DEFAULT 0,
  reset_at TIMESTAMPTZ NOT NULL,
  updated_at TIMESTAMPTZ NOT NULL
);
```

### `ai_actions_ledger`
```sql
CREATE TABLE ai_actions_ledger (
  id VARCHAR(64) PRIMARY KEY,
  tenant_id VARCHAR(64) NOT NULL,
  delta INTEGER NOT NULL,
  reason VARCHAR(64) NOT NULL,
  request_id VARCHAR(128), -- Pour idempotence
  conversation_id VARCHAR(128),
  created_at TIMESTAMPTZ NOT NULL
);

-- Index pour idempotence
CREATE UNIQUE INDEX idx_actions_ledger_request_id 
  ON ai_actions_ledger(request_id) 
  WHERE request_id IS NOT NULL AND delta < 0;
```

## 2. Service `ai-actions.service.ts`

Nouvelles fonctions:
- `getActionsWallet(tenantId)` - Récupère le wallet actions (avec reset mensuel auto)
- `checkActionsAvailable(tenantId)` - Vérifie si actions > 0
- `debitOneAction(tenantId, requestId, conversationId)` - Débit atomique et idempotent
- `addPurchasedActions(tenantId, actions, referenceId)` - Ajoute des actions achetées
- `getActionsLedger(tenantId, limit)` - Historique des débits/crédits
- `devSetActions(tenantId, remaining)` - DEV: Set manuel pour tests

## 3. Modifications `/ai/assist`

### Pré-check Actions
```typescript
// PH25.10D: Check ACTIONS available (source of truth for UX)
const actionsCheck = await checkActionsAvailable(tenantId);
if (!actionsCheck.available) {
  return reply.status(402).send({
    status: 'actions_exhausted',
    error: 'ACTIONS_EXHAUSTED',
    disclaimer: 'Actions IA épuisées. Achetez des actions pour continuer.',
    // ...
  });
}
```

### Débit après succès LLM
```typescript
// PH25.10D: Debit ONE action (idempotent on requestId)
const actionDebitResult = await debitOneAction(tenantId, requestId, effectiveConversationId);

console.log('ACTIONS_DEBIT_TRACE', JSON.stringify({
  tenantId,
  requestId,
  conversationId,
  remainingBefore: actionDebitResult.remainingBefore,
  remainingAfter: actionDebitResult.remainingAfter,
  alreadyDebited: actionDebitResult.alreadyDebited,
}));
```

### Réponse avec actions
```typescript
const response = {
  status: 'success',
  // ...
  actionsConsumed: actionDebitResult.alreadyDebited ? 0 : 1,
  actionsRemaining: actionDebitResult.remainingAfter,
};
```

## 4. Endpoint `/ai/wallet/status`

Retourne maintenant les vraies données de `ai_actions_wallet`:
```json
{
  "balance": 10.00,
  "dailyPlanUsedUsd": 0.02,
  "dailyPlanBudgetUsd": 0.50,
  "actions": {
    "remaining": 10,
    "includedMonthly": 50,
    "purchasedRemaining": 0,
    "resetAt": "2026-02-01T00:00:00.000Z"
  }
}
```

## 5. Endpoints DEV ajoutés

- `POST /ai/wallet/dev/set-actions` - Set actions manuellement (DEV only)
- `GET /ai/wallet/actions/ledger` - Voir le ledger actions

## 6. Modifications Frontend

### `AISuggestionSlideOver.tsx`
- Affiche "Actions restantes : X" avant génération
- Gère `ACTIONS_EXHAUSTED` pour afficher `AIActionsLimitBlock`
- Met à jour `actionsRemaining` après génération réussie
- Bouton désactivé si `actionsRemaining === 0`

### `/billing/ai/page.tsx`
- Header renommé "Actions IA"
- Section Budget $/Tokens dans accordéon "Détails techniques" (fermé par défaut)
- Actions IA reste l'élément principal

### Types mis à jour
- `AIAssistResponse` avec `actionsConsumed`, `actionsRemaining`
- `AIWalletStatus` avec objet `actions`

## 7. Tests effectués

| Test | Résultat |
|------|----------|
| `GET /ai/wallet/status` retourne `actions` | ✅ |
| `POST /ai/wallet/dev/set-actions` fonctionne | ✅ |
| Actions ledger enregistre les opérations | ✅ |
| Build API réussit | ✅ |
| Build Client réussit | ✅ |
| Déploiement DEV réussi | ✅ |

## 8. Versions déployées

- **API**: `ghcr.io/keybuzzio/keybuzz-api:v0.9.22-ph2510d`
- **Client**: `ghcr.io/keybuzzio/keybuzz-client:v0.5.46-ph2510d`

## 9. Tests E2E à effectuer manuellement

1. Aller sur https://client-dev.keybuzz.io/billing/ai
   - Vérifier section "Actions IA" visible en premier
   - Vérifier "Détails techniques" fermé par défaut

2. Aller sur une conversation Inbox, ouvrir Aide IA
   - Vérifier "Actions restantes : X" affiché
   - Générer une suggestion
   - Vérifier que actions baisse de 1

3. Set actions à 0 via API DEV:
   ```bash
   curl -X POST 'https://api-dev.keybuzz.io/ai/wallet/dev/set-actions' \
     -H 'Content-Type: application/json' \
     -d '{"tenantId":"<TENANT_ID>","remaining":0}'
   ```
   - Générer suggestion → doit retourner 402 ACTIONS_EXHAUSTED
   - UI affiche bloc "Actions IA épuisées" avec CTA acheter

4. Acheter pack via Stripe DEV
   - Actions remontent
   - IA fonctionne à nouveau

## 10. Logs de trace

Les logs `ACTIONS_DEBIT_TRACE` contiennent:
```json
{
  "tenantId": "ecomlg-001",
  "requestId": "req-xxx",
  "conversationId": "conv-xxx",
  "remainingBefore": 10,
  "remainingAfter": 9,
  "alreadyDebited": false
}
```

## Règles respectées

- ❌ Aucun hardcode tenantId
- ❌ Aucune modification PROD
- ✅ Débit atomique et idempotent sur requestId
- ✅ Actions = source de vérité UX
- ✅ $ caché dans "Détails techniques"
- ✅ Plan actions inclus par mois + achats séparés
