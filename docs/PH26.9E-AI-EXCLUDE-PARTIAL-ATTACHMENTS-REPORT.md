# PH26.9E - IA : Exclure PJ partial + Message clair

**Date:** 2026-02-01  
**Status:** ✅ DÉPLOYÉ EN DEV

---

## 1. RÉSUMÉ

Les pièces jointes avec `status='partial'` sont automatiquement exclues du contexte IA, avec un message d'avertissement explicite dans le panneau Aide IA.

---

## 2. IMPLÉMENTATION

### 2.1 Détection des PJ partielles

**Fichier:** `AISuggestionSlideOver.tsx`

```typescript
// PH26.9E: Count partial attachments that will be excluded from AI context
const partialAttachments = conversationAttachments.filter(att => att.status === 'partial');
const hasPartialAttachments = partialAttachments.length > 0;
```

### 2.2 Props ajoutée

```typescript
interface AISuggestionSlideOverProps {
  // ...existing props
  // PH26.9E: Attachment info for partial detection
  conversationAttachments?: Array<{ id: string; filename: string; status: string }>;
}
```

### 2.3 Passage des données (InboxTripane)

```typescript
<AISuggestionSlideOver
  // ...existing props
  // PH26.9E: Pass attachments for partial detection
  conversationAttachments={selectedConversation.messages.flatMap(m => 
    (m.attachments || []).map(att => ({
      id: att.id,
      filename: att.filename,
      status: att.status
    }))
  )}
/>
```

---

## 3. UI WARNING

### Affichage conditionnel

Le warning s'affiche si `hasPartialAttachments === true` dans le panneau Aide IA.

### Texte (singulier)

```
⚠️ 1 pièce jointe a été exclue car incomplète
Amazon n'a transmis qu'une partie. Ajoutez le fichier manuellement si nécessaire.
```

### Texte (pluriel)

```
⚠️ 2 pièces jointes ont été exclues car incomplètes
Amazon n'a transmis qu'une partie. Ajoutez le fichier manuellement si nécessaire.
```

### Style

- Fond ambre (`bg-amber-50`)
- Bordure ambre (`border-amber-200`)
- Icône AlertTriangle
- Position: en haut du panneau, avant le contexte utilisateur

---

## 4. COMPORTEMENT IA

### Ce qui est EXCLU

| Élément | Exclu du contexte IA |
|---------|---------------------|
| PJ avec `status='partial'` | ✅ Oui |
| Contenu binaire tronqué | ✅ Oui |
| Référence au fichier | ✅ Oui |

### Ce qui est INCLUS

| Élément | Inclus dans le contexte IA |
|---------|---------------------------|
| Messages texte | ✅ Oui |
| PJ avec `status='uploaded'` | ✅ Oui |
| Contexte utilisateur manuel | ✅ Oui |
| Fichiers uploadés manuellement | ✅ Oui |

---

## 5. TESTS E2E

### Scénario: Message avec PJ partial

| Test | Résultat attendu |
|------|------------------|
| Ouvrir panneau IA | Warning visible en haut |
| Générer suggestion | IA ne "voit" pas la PJ partial |
| Compteur PJ exclues | Affiche le nombre correct |

### Scénario: Message sans PJ partial

| Test | Résultat attendu |
|------|------------------|
| Ouvrir panneau IA | Pas de warning |
| Générer suggestion | Fonctionne normalement |

---

## 6. DÉPLOIEMENT

### Image

| Service | Tag | Digest |
|---------|-----|--------|
| Client | `v0.5.32-ai-exclude-partial` | `sha256:70d272e405b6...` |

### Manifest

- `k8s/keybuzz-client-dev/deployment.yaml` - Mis à jour

---

## 7. FICHIERS MODIFIÉS

| Fichier | Changement |
|---------|------------|
| `src/features/ai-ui/AISuggestionSlideOver.tsx` | Props + détection + warning UI |
| `app/inbox/InboxTripane.tsx` | Passage des attachments au composant |

---

## 8. FLOW LOGIQUE

```
AISuggestionSlideOver ouvert
    │
    ▼
conversationAttachments reçus
    │
    ▼
filter(status === 'partial')
    │
    ├── partialAttachments.length > 0
    │       │
    │       ▼
    │   Afficher warning
    │
    └── Continuer sans warning

Lors de l'appel IA:
    │
    ▼
PJ partial NON transmises au contexte
(elles ne sont jamais dans allMessages.content)
```

---

## 9. NON-RÉGRESSION

- ✅ L'IA fonctionne normalement sans PJ partial
- ✅ Les PJ complètes sont toujours utilisables
- ✅ L'upload manuel fonctionne
- ✅ Le warning disparaît si pas de PJ partial

---

**Rapport généré - PH26.9E AI Exclude Partial Attachments**
