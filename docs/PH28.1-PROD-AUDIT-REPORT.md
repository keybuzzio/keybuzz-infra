# PH28.1 - PROD AUDIT REPORT

**Date:** 2026-02-01  
**Status:** ✅ AUDIT COMPLET

---

## 1. RÉSUMÉ EXÉCUTIF

### État PROD actuel: ⚠️ INSTABLE / PARTIELLEMENT FONCTIONNEL

| Aspect | État | Commentaire |
|--------|------|-------------|
| Infrastructure | ✅ OK | Pods running, Ingress OK |
| Auth/Login | ⚠️ PARTIEL | NextAuth fonctionne, mais API manque routes |
| API routes | ❌ BROKEN | Majorité des routes 404 |
| Database | ⚠️ PARTAGÉ | Même DB que DEV → RISQUE |
| Séparation DEV/PROD | ❌ KO | Client PROD pointe vers backend-dev |

---

## 2. VERSIONS DÉPLOYÉES

### Images PROD

| Service | Image | Age |
|---------|-------|-----|
| API | `ghcr.io/keybuzzio/keybuzz-api:v0.9.29-contact-fix` | 5d16h |
| Client | `ghcr.io/keybuzzio/keybuzz-client:v0.5.3-signup-public` | 12d |
| Website | `ghcr.io/keybuzzio/keybuzz-website:v0.4.20-home-fixes` | 5d11h |

### Images DEV (comparaison)

| Service | Image |
|---------|-------|
| API | `ghcr.io/keybuzzio/keybuzz-api:v0.4.31-replacement` |
| Client | `ghcr.io/keybuzzio/keybuzz-client:v0.5.33-replacement` |

**⚠️ ATTENTION**: Les versions PROD et DEV sont TOTALEMENT DIFFÉRENTES. L'API PROD semble être une version ancienne/simplifiée avec moins de routes.

---

## 3. ENDPOINTS PROD

### API (api.keybuzz.io)

| Endpoint | HTTP Status | État |
|----------|-------------|------|
| `/health` | 200 | ✅ OK |
| `/tenants` | 200 | ✅ OK |
| `/conversations` | 404 | ❌ Absent |
| `/messages` | 404 | ❌ Absent |
| `/attachments` | 404 | ❌ Absent |
| `/dashboard` | 404 | ❌ Absent |
| `/stats` | 404 | ❌ Absent |
| `/webhooks` | 404 | ❌ Absent |
| `/auth/login` | 404 | ❌ Absent |
| `/auth/signup` | 404 | ❌ Absent |
| `/auth/me` | 401 | ⚠️ Existe mais non auth |
| `/debug/version` | 404 | ❌ Absent |

### Client (client.keybuzz.io)

| Endpoint | HTTP Status | État |
|----------|-------------|------|
| `/` | 307 | Redirect → login |
| `/login` | 200 | ✅ OK |
| `/signup` | 200 | ✅ OK |
| `/dashboard` | 307 | Redirect (auth required) |
| `/inbox` | 307 | Redirect (auth required) |

### Website (keybuzz.pro)

| Endpoint | HTTP Status | État |
|----------|-------------|------|
| `/` | 200 | ✅ OK |
| `/pricing` | 200 | ✅ OK |
| `/contact` | 200 | ✅ OK |
| `/features` | 200 | ✅ OK |

---

## 4. AUTHENTIFICATION

### NextAuth (Client PROD)

| Provider | État |
|----------|------|
| Google OAuth | ✅ Configuré |
| Azure AD | ✅ Configuré |
| Email OTP | ✅ Configuré |
| CSRF Token | ✅ Généré |

### Variables d'environnement

```
NEXTAUTH_URL=https://client.keybuzz.io
NEXTAUTH_SECRET=nZnWusgc6hQ2KCgqbfvB1YTXSqxAww4uVf80+Hqzr8s=
```

---

## 5. DATABASE (⚠️ CRITIQUE)

### Configuration

```
Host: 10.0.0.10
Port: 5432
Database: keybuzz
User: keybuzz_api_dev  ← MÊME USER QUE DEV!
```

### Contenu actuel

| Table | Count |
|-------|-------|
| users | 9 |
| tenants | 13 |
| conversations | ~8400+ |
| messages | ~24000+ |

### Utilisateurs récents

| Email | Date création |
|-------|---------------|
| ludovic@keybuzz.io | 2026-01-21 |
| testsaas-jan21-2@example.com | 2026-01-21 |
| ludovic+369@ecomlg.fr | 2026-01-14 |

### ⚠️ PROBLÈME MAJEUR

**PROD et DEV partagent la MÊME base de données!**

Risques:
- Données DEV visibles en PROD
- Modifications DEV impactent PROD
- Pas d'isolation des environnements
- Tests DEV polluent PROD

---

## 6. PROBLÈMES DE CONFIGURATION

### 6.1 Client PROD pointe vers backend DEV

```env
NEXT_PUBLIC_BACKEND_URL=https://backend-dev.keybuzz.io  ← ERREUR!
```

Devrait être `https://backend.keybuzz.io` ou absent.

### 6.2 Pas de manifests PROD dans Git

Les manifests pour `keybuzz-api-prod` et `keybuzz-client-prod` ne sont pas dans `/opt/keybuzz/keybuzz-infra/k8s/`.

Seuls présents:
- `keybuzz-infra/k8s/website-prod/`
- `manifests-prod/` (secrets externes)

---

## 7. TESTS FONCTIONNELS

### 7.1 Login ⚠️ À TESTER MANUELLEMENT

La page `/login` charge correctement.
NextAuth providers sont configurés.

**Test requis:**
1. Aller sur https://client.keybuzz.io/login
2. Se connecter avec Google ou email
3. Vérifier l'accès au dashboard

### 7.2 Création de compte ⚠️ À TESTER MANUELLEMENT

La page `/signup` charge correctement.

**Test requis:**
1. Aller sur https://client.keybuzz.io/signup
2. Créer un compte test
3. Vérifier l'email de confirmation
4. Vérifier la création du tenant

### 7.3 Inbox ❌ NON FONCTIONNEL

L'API ne répond pas sur `/conversations` et `/messages`.
L'Inbox ne peut pas fonctionner en PROD actuellement.

---

## 8. RECOMMANDATIONS CRITIQUES

### Priorité 1: Séparation DB

```
❌ Actuel: PROD + DEV → même DB
✅ Cible: PROD → DB PROD isolée
```

Options:
1. Créer une nouvelle DB `keybuzz_prod` sur le même serveur
2. Utiliser un serveur DB séparé pour PROD

### Priorité 2: Déployer API complète en PROD

L'API PROD actuelle (`v0.9.29`) manque la majorité des routes.
Besoin de déployer la version DEV stable après audit.

### Priorité 3: Corriger variables d'environnement

```diff
- NEXT_PUBLIC_BACKEND_URL=https://backend-dev.keybuzz.io
+ NEXT_PUBLIC_BACKEND_URL=https://backend.keybuzz.io
```

### Priorité 4: Créer manifests PROD dans Git

Pour GitOps proper:
- `keybuzz-infra/k8s/keybuzz-api-prod/deployment.yaml`
- `keybuzz-infra/k8s/keybuzz-client-prod/deployment.yaml`

---

## 9. DÉCISION REQUISE

### Option A: "Fix PROD" (rapide mais risqué)

- Déployer API DEV stable en PROD
- Garder DB partagée temporairement
- Corriger env vars
- Délai: ~1-2h

### Option B: "Rebuild PROD propre" (recommandé)

- Créer DB PROD séparée
- Créer manifests PROD dans Git
- Tag stable DEV → PROD
- Délai: ~4-6h

### Option C: "PROD minimal MVP"

- Garder uniquement website PROD
- Désactiver client.keybuzz.io temporairement
- Refaire PROD complètement plus tard

---

## 10. CONCLUSION

**PROD actuelle = NON PRÊTE pour clients réels**

| Fonctionnalité | PROD | DEV |
|----------------|------|-----|
| Auth/Login | ⚠️ Partiel | ✅ OK |
| Dashboard | ❌ KO | ✅ OK |
| Inbox | ❌ KO | ✅ OK |
| Aide IA | ❌ KO | ✅ OK |
| PJ/Attachments | ❌ KO | ✅ OK |
| Website | ✅ OK | ✅ OK |

**Recommandation:** Appliquer l'**Option B** (Rebuild PROD propre) avant de considérer PROD comme utilisable.

---

**Rapport généré - PH28.1 PROD Audit**
