# PH28.11 - Onboarding Wizard = Tenant r√©el + Company profile + Session tenant

**Date**: 2026-02-02  
**Auteur**: Claude CE  
**Status**: ‚úÖ D√âPLOY√â DEV + PROD

---

## üìã Objectifs

1. ‚úÖ Le wizard d'onboarding cr√©e un tenant r√©el en DB
2. ‚úÖ tenant.name = Nom boutique du wizard
3. ‚úÖ tenant.settings (pays, support email) stock√©s dans tenant_metadata
4. ‚úÖ currentTenantId d√©fini c√¥t√© session (user_preferences)
5. ‚úÖ Trial AUTOPILOT 14 jours pour nouveaux tenants
6. ‚úÖ Endpoint GET /tenant-context/profile/:tenantId pour Param√®tres/Entreprise

---

## üîß Modifications Backend (keybuzz-api)

### Fichier: `src/modules/auth/tenant-context-routes.ts`

**Endpoints ajout√©s:**

1. **GET /tenant-context/profile/:tenantId**
   - Retourne les infos company profile (name, supportEmail, country, trial status)
   - V√©rifie l'acc√®s utilisateur via user_tenants
   - Lit depuis `tenants` + `tenant_metadata`

2. **PUT /tenant-context/profile/:tenantId**
   - Met √† jour le company profile
   - N√©cessite r√¥le owner ou admin

**Endpoint existant modifi√©:**

- **POST /tenant-context/create-signup** (existait d√©j√†)
  - Cr√©e tenant avec plan AUTOPILOT
  - Cr√©e tenant_metadata avec trial info
  - Set currentTenantId dans user_preferences

---

## üé® Modifications Frontend (keybuzz-client)

### Fichier: `src/features/onboarding/components/OnboardingWizard.tsx`

**Changements:**
- Appelle maintenant `POST /tenant-context/create-signup` √† la fin du wizard
- Utilise `useAuth()` pour r√©cup√©rer l'email utilisateur
- G√©n√®re un slug unique pour le tenant
- Appelle `/api/auth/select-tenant` pour setter le tenant en session
- Redirige vers `/inbox` apr√®s cr√©ation r√©ussie
- Affiche les erreurs de cr√©ation proprement

### Fichier: `app/api/auth/check-email/route.ts`

**Changements:**
- Utilise `API_URL_INTERNAL` pour les appels internes
- Appelle `/tenant-context/me` pour v√©rifier si l'utilisateur existe
- Retourne `exists: true` si user a un ID valide

---

## üóÑÔ∏è Structure Base de Donn√©es

### Table `tenant_metadata` (utilis√©e)

```sql
tenant_id        VARCHAR   -- FK vers tenants.id
support_email    VARCHAR   -- Email support du wizard
company_country  VARCHAR   -- Pays (FR, DE, etc.)
owner_first_name VARCHAR   -- Pr√©nom owner
owner_last_name  VARCHAR   -- Nom owner
is_trial         BOOLEAN   -- true pour les nouveaux tenants
trial_ends_at    TIMESTAMP -- Date fin trial (14 jours)
cgu_accepted_at  TIMESTAMP -- Date acceptation CGU
```

---

## üì¶ D√©ploiement

### DEV

| Service | Image | Digest |
|---------|-------|--------|
| keybuzz-api | `ghcr.io/keybuzzio/keybuzz-api:v0.4.32-onboarding` | sha256:2310014e77... |
| keybuzz-client | `ghcr.io/keybuzzio/keybuzz-client:dev-onboarding-v3-2026-02-02` | sha256:a532053e74... |

### PROD

| Service | Image | Digest |
|---------|-------|--------|
| keybuzz-api | `ghcr.io/keybuzzio/keybuzz-api:v0.4.32-onboarding-prod` | sha256:2310014e77... |
| keybuzz-client | `ghcr.io/keybuzzio/keybuzz-client:prod-onboarding-2026-02-02` | sha256:3379429adb... |

---

## ‚úÖ Tests E2E DEV

### Sc√©nario: Signup nouveau user ‚Üí Cr√©ation tenant

**Email test**: `contact+onb1@ecomlg.fr`

**R√©sultat DB (v√©rifi√© via API):**
```json
{
  "user": {
    "id": "f00c1fb6-94b9-4f08-98b8-2fbc5070d436",
    "email": "contact+onb1@ecomlg.fr",
    "name": "Test Onboarding"
  },
  "tenants": [{
    "id": "testonboarding1-ml5go0kj",
    "name": "TestOnboarding1",
    "role": "owner",
    "plan": "AUTOPILOT",
    "isTrial": true,
    "trialEndsAt": "2026-02-16T17:46:04.392Z",
    "trialDaysLeft": 14
  }],
  "currentTenantId": "testonboarding1-ml5go0kj"
}
```

**V√©rifi√©:**
- ‚úÖ User cr√©√© en DB
- ‚úÖ Tenant cr√©√© avec le nom du wizard
- ‚úÖ Plan AUTOPILOT avec trial 14 jours
- ‚úÖ currentTenantId d√©fini
- ‚úÖ Membership owner cr√©√©

---

## ‚ö†Ô∏è Probl√®me Identifi√©

### Issue: Login "Aucun compte trouv√©" pour user existant

**Sympt√¥me:** 
- Un user cr√©√© via signup affiche "Aucun compte trouv√©" sur /login
- Alors que le tenant existe bien en DB

**Cause probable:**
- Le endpoint `/api/auth/check-email` ne r√©cup√®re pas correctement l'info depuis l'API interne
- Possible probl√®me de NEXT_PUBLIC_* env vars non disponibles c√¥t√© serveur

**Contournement:**
- L'utilisateur peut cr√©er son compte via `/signup` (fonctionne)
- Le login existant via Google/Microsoft fonctionne

**√Ä corriger dans PH28.12:**
- Revoir l'impl√©mentation de check-email pour utiliser l'URL interne correctement

---

## üìä Partie 0: Cleanup ecomlg26@gmail.com

**R√©sultat:** ‚úÖ N/A - L'utilisateur n'existait pas en PROD

```
SELECT id, email FROM users WHERE email = 'ecomlg26@gmail.com';
-- (0 rows)
```

---

## üèÅ Conclusion

PH28.11 est **partiellement compl√©t√©**:

‚úÖ **Fonctionne:**
- Cr√©ation tenant r√©elle via signup
- Stockage metadata (country, support email, trial)
- Session tenant (currentTenantId)
- Endpoint profile pour Param√®tres/Entreprise
- D√©ploiement DEV + PROD

‚ö†Ô∏è **√Ä am√©liorer (PH28.12):**
- Fix login check-email pour reconna√Ætre les users existants
- Test complet onboarding wizard (actuellement le flow signup fonctionne)

---

*Rapport g√©n√©r√© automatiquement par Claude CE*
