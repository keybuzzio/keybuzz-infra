# PH26.5K2 — Raw MIME Backfill: Analyse et Conclusion

**Date** : 2026-01-30  
**Status** : ❌ Backfill IMPOSSIBLE (source non disponible)

---

## Objectif initial

Backfiller `raw_mime_key`/`raw_mime_sha256`/`raw_mime_size_bytes` pour les messages existants en retrouvant les emails bruts depuis l'infrastructure.

---

## 0) Sources explorées

### mail-core-01 (10.0.0.160)

| Chemin | Contenu |
|--------|---------|
| `/data/mail_core/` | Vide |
| `/var/mail/` | Vide |
| `/var/spool/postfix/` | Queue transit uniquement, pas d'archive |
| `*.eml` (recherche) | Aucun fichier trouvé |

**Conclusion** : Le serveur mail ne conserve pas les emails après transit.

### ExternalMessage (DB keybuzz_backend)

| Champ | Contenu |
|-------|---------|
| `raw->>'body'` | Texte parsé (HTML ou placeholder), **PAS le MIME original** |
| `raw::text` | Ne contient ni `base64` ni `image/jpeg` |

**Preuve** :

```sql
SELECT has_base64_anywhere, has_jpeg_marker FROM ExternalMessage 
WHERE tenantId = 'ecomlg-001' LIMIT 20;

-- Résultat: TOUS = false/false
```

---

## 1) Analyse du message avec PJ

### Message cible

| Champ | Valeur |
|-------|--------|
| Message ID | `cmml0ym4rw5d43ccb23024567` |
| Body | `[Pièce jointe reçue]` |
| Attachment | `20260130_150548.jpg` (369987 bytes) |
| Created | 2026-01-30 14:09:37 |

### ExternalMessage correspondant

| Champ | Valeur |
|-------|--------|
| ID | `cml0ym4g7000e8h01fbuy2kkd` |
| `raw->>'body'` | `[Pièce jointe reçue]` (20 bytes) |
| `raw` total | 386 bytes |
| base64 présent | **NON** |

**Conclusion** : Le MIME original avec la PJ encodée en base64 n'a jamais été stocké.

---

## 2) Flux de traitement actuel (avant PH26.5K)

```
Email reçu → Webhook → Parse MIME → Extract text + attachments
                                      ↓
                            ExternalMessage.raw = { body: "texte parsé" }
                                      ↓
                            messages.body = "texte parsé"
                                      ↓
                            message_attachments + MinIO = PJ extraite
```

**Problème** : Le MIME original est détruit pendant le parsing. Seul le résultat est conservé.

---

## 3) Ce qui change avec PH26.5K

```
Email reçu → Webhook → STORE RAW MIME (MinIO) → Parse MIME → ...
                              ↓
                      messages.raw_mime_key = "raw-mime/<tenant>/<id>.eml"
```

À partir de maintenant, le MIME original est conservé **avant** le parsing.

---

## 4) Stratégies alternatives (évaluées)

### A) Re-fetch depuis Amazon SP-API

❌ **Non viable** : L'API Messaging ne permet pas de récupérer l'historique complet des messages buyer-seller.

### B) Re-fetch depuis email forwarding

❌ **Non viable** : Les emails forwardés ne sont pas archivés sur mail-core.

### C) Reconstitution depuis MinIO

❌ **Non viable** : Les PJ sont stockées mais pas le MIME complet (headers, boundaries, texte original).

---

## 5) Conclusion

| Aspect | Statut |
|--------|--------|
| Backfill raw MIME historique | ❌ **IMPOSSIBLE** |
| Raison | Source non disponible |
| Impact | 323 messages existants sans raw_mime |
| Solution | Seuls les **nouveaux messages** bénéficieront de PH26.5K |

---

## 6) Recommandations

1. **Documenter la limitation** : Les messages avant le 2026-01-30 n'ont pas de raw MIME récupérable
2. **Monitoring** : Vérifier que les nouveaux messages ont bien `raw_mime_key` rempli
3. **Pas de régression** : Les anciennes PJ restent accessibles via `message_attachments` + MinIO

---

## 7) Validation PH26.5K (prochain message)

Au prochain message inbound Amazon :

```bash
# Vérifier les logs
kubectl logs -n keybuzz-backend-dev deployment/keybuzz-backend --tail=100 | grep "PH26.5K"

# Vérifier la DB
SELECT id, raw_mime_key, raw_mime_size_bytes 
FROM messages 
WHERE raw_mime_key IS NOT NULL 
ORDER BY created_at DESC LIMIT 5;
```

---

**STATUS** : ❌ Backfill impossible — Le raw MIME historique n'est pas récupérable
