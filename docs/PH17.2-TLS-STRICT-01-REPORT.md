# PH17.2-TLS-STRICT-01 - TLS Strict + Guard anti-regression

## Date: 2026-01-12

## Objectif
Supprimer NODE_TLS_REJECT_UNAUTHORIZED=0 et configurer TLS proprement.

---

## Probleme

NODE_TLS_REJECT_UNAUTHORIZED=0 desactive la verification des certificats TLS dans Node.js.
C'est une faille de securite majeure (MITM possible).

### Cause racine
Le certificat Vault etait accede via IP (10.0.0.150) au lieu du hostname (vault.keybuzz.io).
Le certificat Let Encrypt est valide pour vault.keybuzz.io mais pas pour l'IP.

---

## Solution

### 1. hostAliases dans le deployment
Ajoute une entree /etc/hosts dans les pods pour resoudre vault.keybuzz.io vers 10.0.0.150.

\\\yaml
spec:
  hostAliases:
    - ip:  10.0.0.150
      hostnames:
        - vault.keybuzz.io
\\\

### 2. VAULT_ADDR avec hostname
Change de \https://10.0.0.150:8200\ vers \https://vault.keybuzz.io:8200\.

### 3. Suppression NODE_TLS_REJECT_UNAUTHORIZED
\\\ash
kubectl set env deployment/keybuzz-backend -n keybuzz-backend-dev NODE_TLS_REJECT_UNAUTHORIZED-
\\\

---

## Certificat Vault

| Champ | Valeur |
|-------|--------|
| Subject | vault.keybuzz.io |
| Issuer | Let's Encrypt E8 |
| Validite | 2025-12-14 -> 2026-03-14 |
| Chain | vault.keybuzz.io -> E8 -> ISRG Root X1 |

---

## Validation

### 1. TLS depuis install-v3
\\\ash
curl -s https://vault.keybuzz.io:8200/v1/sys/health
# {initialized:true,sealed:false,...}
\\\

### 2. API Backend fonctionne
\\\ash
# OAuth start (lit app credentials depuis Vault)
POST /api/v1/marketplaces/amazon/oauth/start
# {success:true,authUrl:https://sellercentral.amazon.com/...}

# Orders backfill (lit refresh_token depuis Vault)
POST /api/v1/orders/backfill {days:1}
# {success:true,imported:0,errors:[]}
\\\

---

## Guard anti-regression

### Script: /opt/keybuzz/sre/tls_guard.sh

Verifie:
1. NODE_TLS_REJECT_UNAUTHORIZED absent des repos
2. NODE_TLS_REJECT_UNAUTHORIZED absent des deployments K8s
3. Vault TLS fonctionne sans -k

### Resultat
\\\
TLS Guard: ALL CHECKS PASSED
\\\

---

## Fichiers modifies

| Fichier | Changement |
|---------|------------|
| k8s/keybuzz-backend-dev/deployment.yaml | hostAliases, VAULT_ADDR, suppression NODE_TLS |
| sre/tls_guard.sh | Nouveau guard |

---

## Git Commits

### keybuzz-infra
- PH17.2: TLS strict - remove NODE_TLS_REJECT_UNAUTHORIZED
- Add tls_guard.sh

---

## Resume

| Check | Status |
|-------|--------|
| NODE_TLS_REJECT_UNAUTHORIZED supprime | OK |
| VAULT_ADDR hostname | OK |
| hostAliases configure | OK |
| Vault TLS valide | OK |
| Backend fonctionne | OK |
| Guard cree | OK |
