# PH26.9F - Remplacement PJ tronquÃ©es (KeyBuzz-first)

**Date:** 2026-02-01  
**Status:** âœ… DÃ‰PLOYÃ‰ EN DEV

---

## 1. RÃ‰SUMÃ‰

Permet Ã  l'utilisateur de remplacer une PJ partielle directement dans KeyBuzz, sans sortir vers Amazon. Le remplacement devient la source de vÃ©ritÃ©.

---

## 2. ARCHITECTURE

### 2.1 Stockage du mapping

| Champ | Valeur |
|-------|--------|
| `status` | `replacement` |
| `error` | `REPLACES:originalAttachmentId` |

Pas de nouvelle table nÃ©cessaire - utilise les champs existants de `message_attachments`.

### 2.2 Nouvel endpoint API

```
POST /api/attachments/replace
```

**Headers:**
- `x-tenant-id`: Tenant ID

**Body (multipart):**
- `file`: Le fichier de remplacement
- `originalAttachmentId`: ID de la PJ partielle Ã  remplacer
- `messageId`: ID du message contenant la PJ

**RÃ©ponse:**
```json
{
  "success": true,
  "attachmentId": "repl_abc123...",
  "filename": "photo.jpg",
  "size": 132000,
  "status": "replacement",
  "replaces": "att_original123",
  "downloadUrl": "/attachments/repl_abc123..."
}
```

---

## 3. UI

### 3.1 PJ partielle sans remplacement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ [IMG_4123.png] - 45 KB                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ Fichier partiel (Amazon)                  â”‚
â”‚ Amazon n'a transmis qu'une partie.           â”‚
â”‚                                              â”‚
â”‚ [ğŸ“¤ Remplacer ce fichier]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 PJ partielle AVEC remplacement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ [IMG_4123.png] - 45 KB                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ Fichier partiel (Amazon)                  â”‚
â”‚                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ âœ… Fichier de remplacement ajoutÃ©      â”‚   â”‚
â”‚ â”‚ ğŸ“ IMG_4123_complete.jpg (132 KB)     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 TÃ©lÃ©chargement

Les deux fichiers sont tÃ©lÃ©chargeables:
- Lien sur le replacement â†’ fichier complet
- Lien sur l'original â†’ fichier partiel (avec warning)

---

## 4. INTÃ‰GRATION IA

### Panneau Aide IA

| Situation | Message |
|-----------|---------|
| PJ partial sans remplacement | "âš ï¸ 1 piÃ¨ce jointe exclue (incomplÃ¨te)" |
| PJ partial AVEC remplacement | "âœ… 1 piÃ¨ce jointe remplacÃ©e (fichier complet utilisÃ©)" |

Le remplacement est automatiquement utilisÃ© par l'IA (le partial est exclu).

---

## 5. FICHIERS MODIFIÃ‰S

| Fichier | Changement |
|---------|------------|
| `keybuzz-api/src/modules/attachments/routes.ts` | Nouveau endpoint `/replace` |
| `keybuzz-api/src/modules/messages/routes.ts` | Parsing `isReplacement` + `replacesId` |
| `keybuzz-client/app/inbox/InboxTripane.tsx` | UI remplacement + bouton |
| `keybuzz-client/src/features/ai-ui/AISuggestionSlideOver.tsx` | Gestion des replacements |

---

## 6. DÃ‰PLOIEMENT

### Images

| Service | Tag | Digest |
|---------|-----|--------|
| API | `v0.4.31-replacement` | `sha256:eb4daa10d782...` |
| Client | `v0.5.33-replacement` | `sha256:f1269adaec2b...` |

---

## 7. TESTS E2E

### ScÃ©nario: Remplacer une PJ partielle

| Ã‰tape | Action | RÃ©sultat attendu |
|-------|--------|------------------|
| 1 | Ouvrir conversation avec PJ partial | Voir warning + bouton "Remplacer" |
| 2 | Cliquer "Remplacer ce fichier" | File picker s'ouvre |
| 3 | SÃ©lectionner fichier complet | Upload + message succÃ¨s |
| 4 | Refresh page | Replacement affichÃ© |
| 5 | TÃ©lÃ©charger replacement | Fichier complet OK |
| 6 | Ouvrir panneau IA | Message "âœ… remplacÃ©e" |

---

## 8. NON-RÃ‰GRESSION

- âœ… Upload PJ normal fonctionne (PH26.5L)
- âœ… DÃ©tection partial fonctionne (PH26.9D)
- âœ… Warning IA fonctionne (PH26.9E)
- âœ… Download PJ normal fonctionne
- âœ… L'original Amazon est conservÃ© (pas supprimÃ©)

---

## 9. FLOW LOGIQUE

```
PJ partial dÃ©tectÃ©e
    â”‚
    â–¼
Utilisateur clique "Remplacer"
    â”‚
    â–¼
File picker â†’ sÃ©lection fichier
    â”‚
    â–¼
POST /attachments/replace
    â”‚
    â”œâ”€â”€ Upload MinIO (bucket keybuzz-attachments)
    â”‚
    â””â”€â”€ INSERT message_attachments
        - status = 'replacement'
        - error = 'REPLACES:originalId'
    â”‚
    â–¼
Refresh conversation
    â”‚
    â–¼
UI affiche replacement groupÃ© avec original
    â”‚
    â–¼
IA utilise replacement (ignore partial)
```

---

**Rapport gÃ©nÃ©rÃ© - PH26.9F Partial Attachment Replacement**
