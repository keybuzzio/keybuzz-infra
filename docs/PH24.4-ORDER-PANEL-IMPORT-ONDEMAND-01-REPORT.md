# PH24.4-ORDER-PANEL-IMPORT-ONDEMAND-01 â€” Rapport

**Date**: 2026-01-22
**Environnement**: DEV
**Client Tag**: v0.5.11-import-order
**Backend Tag**: v1.0.31-import-order

---

## Objectifs

A) Fournisseurs vides a la creation d'un tenant/user
B) Panel commande (Inbox) : si "Commande introuvable", proposer "Importer cette commande" (SP-API Orders GET)

---

## A) Fournisseurs: Liste vide par defaut

### Modification effectuee

Fichier: `keybuzz-client/app/suppliers/page.tsx`

```diff
- const [suppliers, setSuppliers] = useState<Supplier[]>(mockSuppliers);
+ const [suppliers, setSuppliers] = useState<Supplier[]>([]);
```

### Resultat

- La page `/suppliers` affiche maintenant "0 fournisseurs"
- Empty state: "Aucun fournisseur trouve"
- Bouton "Ajouter un fournisseur" visible

### Preuve visuelle

Screenshot: suppliers-empty.png
- Badge "0 fournisseurs" visible
- Empty state correct

---

## B) Import On-Demand d'une commande

### Backend: Nouveau service et endpoint

1. **Service**: `keybuzz-backend/src/modules/marketplaces/amazon/amazonOrderImport.service.ts`
   - `fetchSingleOrder(tenantId, orderRef)`: Appelle SP-API Orders `GET /orders/v0/orders/{orderRef}`
   - `fetchOrderItems(tenantId, orderRef)`: Appelle SP-API `GET /orders/v0/orders/{orderRef}/orderItems`
   - `upsertOrder(tenantId, amzOrder, items)`: Upsert dans DB Orders + OrderItems
   - `importSingleOrder(tenantId, orderRef)`: Fonction principale d'import

2. **Route**: `POST /api/v1/orders/import-one`
   - Body: `{ tenantId?: string, orderRef: string }`
   - Response: `{ success: true, orderId: string, externalOrderId: string, imported: true }`

### Client: API Route et UI

1. **API Route**: `keybuzz-client/app/api/orders/import-one/route.ts`
   - Proxy vers le backend avec credentials

2. **Panel commande**: `keybuzz-client/src/features/inbox/components/OrderSidePanel.tsx`
   - Etat "Commande introuvable" modifie:
     - Bouton principal: "Importer cette commande" (orange)
     - Bouton secondaire: "Rechercher dans les commandes"
   - Etat "Import en cours...": Animation de chargement
   - Apres import reussi: Affichage des details de la commande

### Preuve visuelle

Screenshot: inbox-order-panel.png
- Reference detectee: "403-2054727-4009138"
- Bouton "Importer cette commande" visible (orange)
- Bouton "Rechercher dans les commandes" visible (secondaire)
- Message: "La commande sera importee depuis Amazon SP-API"

---

## Fichiers modifies

| Fichier | Action |
|---------|--------|
| `keybuzz-client/app/suppliers/page.tsx` | Modifie (empty state) |
| `keybuzz-backend/src/modules/marketplaces/amazon/amazonOrderImport.service.ts` | Cree |
| `keybuzz-backend/src/modules/marketplaces/amazon/amazonOrdersSync.routes.ts` | Modifie (nouvelle route) |
| `keybuzz-client/app/api/orders/import-one/route.ts` | Cree |
| `keybuzz-client/src/features/inbox/components/OrderSidePanel.tsx` | Modifie (import button) |

---

## Deploiement

```bash
# Backend
kubectl -n keybuzz-backend-dev set image deployment/keybuzz-backend \
  keybuzz-backend=ghcr.io/keybuzzio/keybuzz-backend:v1.0.31-import-order

# Client
kubectl -n keybuzz-client-dev set image deployment/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v0.5.11-import-order
```

---

## Tests E2E

### Test A: Fournisseurs vides
- Naviguer vers `/suppliers`
- Verifier "0 fournisseurs"
- Verifier empty state
- PASS

### Test B: Panel commande avec bouton Import
- Naviguer vers `/inbox`
- Selectionner une conversation avec order_ref
- Verifier que le panel droit affiche "Commande introuvable"
- Verifier que le bouton "Importer cette commande" est visible
- PASS

---

## Conclusion

**A) Fournisseurs**: Liste vide par defaut (plus de mock data)
**B) Import On-Demand**: Bouton "Importer cette commande" visible quand commande introuvable

**Regles respectees**:
- DEV ONLY
- Multi-tenant (pas de hardcode)
- Pas de cassure inbound/outbound Amazon
- Import on-demand (pas de backfill global)