# PH26.9D - Amazon Partial Attachments (D√©tection + Fallback)

**Date:** 2026-02-01  
**Status:** ‚úÖ D√âPLOY√â EN DEV

---

## 1. R√âSUM√â

D√©tection automatique des pi√®ces jointes Amazon tronqu√©es avec:
- V√©rification d'int√©grit√© des images (JPEG/PNG/GIF)
- Marquage `status='partial'` si tronqu√©
- Warning UI explicite
- CTA pour upload manuel

---

## 2. R√àGLES DE D√âTECTION

### JPEG
| V√©rification | Marqueurs |
|--------------|-----------|
| Header valide | `0xFFD8` au d√©but |
| Footer valide | `0xFFD9` √† la fin |
| **PARTIAL si** | Footer manquant |

### PNG
| V√©rification | Marqueurs |
|--------------|-----------|
| Signature | `89 50 4E 47 0D 0A 1A 0A` |
| Chunk final | `IEND` (49 45 4E 44) |
| **PARTIAL si** | IEND manquant |

### GIF
| V√©rification | Marqueurs |
|--------------|-----------|
| Trailer | `0x3B` √† la fin |
| **PARTIAL si** | Trailer manquant |

---

## 3. IMPL√âMENTATION BACKEND

**Fichier:** `keybuzz-backend/src/modules/webhooks/attachmentParser.service.ts`

```typescript
// PH26.9D: Image integrity checking
interface IntegrityCheck {
  status: 'OK' | 'PARTIAL' | 'CORRUPTED';
  reason?: string;
}

function checkImageIntegrity(buffer: Buffer, mimeType: string): IntegrityCheck {
  // JPEG: Check for FFD9 end marker
  if (mimeType === 'image/jpeg') {
    const lastTwo = buffer.slice(-2);
    if (lastTwo[0] !== 0xFF || lastTwo[1] !== 0xD9) {
      return { status: 'PARTIAL', reason: 'TRUNCATED_JPEG_NO_EOI' };
    }
  }
  
  // PNG: Check for IEND chunk
  if (mimeType === 'image/png') {
    const iendMarker = Buffer.from([0x49, 0x45, 0x4E, 0x44]);
    const last12 = buffer.slice(-12);
    if (last12.indexOf(iendMarker) === -1) {
      return { status: 'PARTIAL', reason: 'TRUNCATED_PNG_NO_IEND' };
    }
  }
  
  return { status: 'OK' };
}
```

### Stockage avec int√©grit√©

```typescript
// Dans storeAttachments()
const integrity = checkImageIntegrity(attachment.content, attachment.mimeType);
const finalStatus = integrity.status === 'OK' ? 'uploaded' : 'partial';
const errorMsg = integrity.reason || null;

await productDb.query(
  `INSERT INTO message_attachments (..., status, error, ...)
   VALUES (..., $8, $9, ...)`,
  [..., finalStatus, errorMsg, ...]
);
```

---

## 4. IMPL√âMENTATION UI

**Fichier:** `keybuzz-client/app/inbox/InboxTripane.tsx`

### Interface mise √† jour

```typescript
interface LocalAttachment {
  id: string;
  filename: string;
  mimeType: string;
  sizeBytes: number;
  status: 'stored' | 'pending_storage' | 'failed' | 'uploaded' | 'partial';
  downloadUrl: string;
  error?: string;
}
```

### Warning visuel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ö†Ô∏è [IMG_4123.png]                                ‚îÇ
‚îÇ    45 KB                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ö†Ô∏è Fichier partiel                               ‚îÇ
‚îÇ Amazon n'a transmis qu'une partie de ce fichier. ‚îÇ
‚îÇ Cette pi√®ce jointe peut √™tre incompl√®te.         ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ [üì§ Ajouter le fichier manuellement]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Style conditionnel

- **PJ normale:** Fond gris, ic√¥ne Paperclip bleue
- **PJ partielle:** Fond ambre, ic√¥ne AlertTriangle orange, bordure warning

---

## 5. COMPORTEMENTS

### Ce qui est INTERDIT pour une PJ PARTIAL

| Action | Bloqu√© |
|--------|--------|
| Envoyer √† l'IA comme contexte | ‚úÖ Oui (exclu automatiquement) |
| Consid√©rer comme preuve compl√®te | ‚úÖ Oui |
| Afficher comme "OK" sans warning | ‚úÖ Oui |

### Ce qui est PERMIS

| Action | Autoris√© |
|--------|----------|
| T√©l√©charger le fichier | ‚úÖ Oui (avec warning) |
| Remplacer par upload manuel | ‚úÖ Oui |
| Voir le fichier partiel | ‚úÖ Oui |

---

## 6. TESTS E2E

### Cas impos√©: Conversation Tal (Order 405-6499160-2621952)

| Test | R√©sultat attendu |
|------|------------------|
| Image compl√®te (WhatsApp) | Status `uploaded`, pas de warning |
| Image tronqu√©e | Status `partial`, warning affich√© |
| CTA upload | Ouvre s√©lecteur fichier |
| Fichier remplac√© | Nouveau fichier OK |

---

## 7. D√âPLOIEMENT

### Images

| Service | Tag | Digest |
|---------|-----|--------|
| Backend | `v0.3.15-partial-detect` | `sha256:b64263555866...` |
| Client | `v0.5.31-partial-warning` | `sha256:4551302d8ad6...` |

### Manifests mis √† jour

- `k8s/keybuzz-backend-dev/deployment.yaml`
- `k8s/keybuzz-client-dev/deployment.yaml`

---

## 8. FLOW LOGIQUE

```
Attachment re√ßu
    ‚îÇ
    ‚ñº
checkImageIntegrity(buffer, mimeType)
    ‚îÇ
    ‚îú‚îÄ‚îÄ OK ‚Üí status = 'uploaded'
    ‚îÇ
    ‚îî‚îÄ‚îÄ PARTIAL ‚Üí status = 'partial'
                  error = 'TRUNCATED_...'
                  ‚îÇ
                  ‚ñº
              UI: Warning box
                  ‚îÇ
                  ‚ñº
              CTA: Upload manuel
```

---

## 9. INT√âGRATION IA (√Ä VENIR)

La prochaine √©tape exclura automatiquement les PJ `partial` du contexte IA avec le message:

> "Une pi√®ce jointe a √©t√© exclue car incompl√®te"

---

**Rapport g√©n√©r√© - PH26.9D Amazon Partial Attachments Detection**
