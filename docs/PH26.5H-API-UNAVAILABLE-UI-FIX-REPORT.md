# PH26.5H — API indisponible en UI : Diagnostic & Fix

**Date** : 2026-01-30  
**Status** : ✅ RÉSOLU

---

## Symptôme

L'UI (Dashboard + Inbox) affichait "API indisponible / Données démo" alors que l'API répondait correctement en curl.

---

## Audit Initial

### Versions avant fix

| Élément | Valeur |
|---------|--------|
| Client Image | `v0.5.15-ph265g` |
| Backend Image | `v1.0.38-ph265a` |

### API Status

```bash
curl -sk https://api-dev.keybuzz.io/health
# {"status":"ok"}

curl -sk "https://api-dev.keybuzz.io/stats/dashboard?tenantId=ecomlg-001"
# {"conversations":{"total":58,"open":57,...}}
```

✅ L'API fonctionne parfaitement.

---

## Preuve Network AVANT

Requêtes capturées dans le navigateur :

```
[GET] https://api.keybuzz.io/billing/current?tenantId=kbz-001  ❌ PROD!
[GET] https://api.keybuzz.io/stats/dashboard?tenantId=ecomlg-001  ❌ PROD!
```

**Problème** : Le client DEV appelait l'API **PROD** (`api.keybuzz.io`) au lieu de l'API **DEV** (`api-dev.keybuzz.io`).

---

## Cause Racine

### Dockerfile du client

```dockerfile
# AVANT (problématique)
ARG NEXT_PUBLIC_API_URL=https://api.keybuzz.io  ← PROD par défaut !
```

**Explication** : Les variables `NEXT_PUBLIC_*` sont compilées au **build time** dans Next.js, pas au runtime. Même si le manifest K8s avait `NEXT_PUBLIC_API_URL=https://api-dev.keybuzz.io`, cette valeur n'était pas utilisée car l'image avait été buildée avec la valeur par défaut PROD.

---

## Fix Appliqué

### Correction du Dockerfile

```dockerfile
# APRÈS (corrigé)
ARG NEXT_PUBLIC_API_URL=https://api-dev.keybuzz.io  ← DEV par défaut
```

### Rebuild et déploiement

```bash
docker build --no-cache -t ghcr.io/keybuzzio/keybuzz-client:v0.5.16-ph265h .
docker push ghcr.io/keybuzzio/keybuzz-client:v0.5.16-ph265h
kubectl set image deployment/keybuzz-client -n keybuzz-client-dev \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v0.5.16-ph265h
```

---

## Preuve Network APRÈS

Requêtes capturées dans le navigateur :

```
[GET] https://api-dev.keybuzz.io/stats/dashboard?tenantId=ecomlg-001  ✅ DEV!
[GET] https://api-dev.keybuzz.io/billing/current?tenantId=kbz-001  ✅ DEV!
[GET] https://api-dev.keybuzz.io/dashboard/summary?tenantId=ecomlg-001  ✅ DEV!
```

---

## Preuve UI APRÈS

### Dashboard

| KPI | Valeur |
|-----|--------|
| Conversations ouvertes | 57 |
| En attente | 0 |
| SLA à risque | 0 |
| SLA dépassés | 0 |
| Messages 24h | 6 |
| Résolues | 1 |
| **Source** | **Données API** ✅ |

### Inbox

| Compteur | Valeur |
|----------|--------|
| Total | 58+ |
| Ouvert | 57 |
| En attente | 0 |
| Non lu | 0 |

---

## Versions déployées APRÈS

| Élément | Valeur |
|---------|--------|
| Client Image | `v0.5.16-ph265h` |
| Client Digest | `sha256:96768be4b71e30730d87c0f5250d6c7172dbc8c37619a2fb87637021d9c9e669` |
| Backend Image | `v1.0.38-ph265a` (inchangé) |

---

## Leçon Apprise

**`NEXT_PUBLIC_*` = Build Time, pas Runtime !**

Pour les environnements DEV/PROD, il faut :
1. Soit passer `--build-arg NEXT_PUBLIC_API_URL=...` lors du build
2. Soit avoir un Dockerfile avec le bon défaut pour l'environnement cible
3. **Ne jamais compter sur les variables d'env K8s pour `NEXT_PUBLIC_*`**

---

## Fichiers modifiés

| Fichier | Modification |
|---------|--------------|
| `Dockerfile` | `ARG NEXT_PUBLIC_API_URL=https://api-dev.keybuzz.io` |

---

**STATUS** : ✅ Dashboard et Inbox affichent maintenant "Données API" avec les vrais chiffres (58 conversations).
