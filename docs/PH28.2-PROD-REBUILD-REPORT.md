# PH28.2 - PROD Rebuild (Isolation totale DEV/PROD)

**Date:** 2026-02-01  
**Status:** ✅ COMPLET

---

## 1. RÉSUMÉ EXÉCUTIF

PROD est maintenant:
- ✅ **Isolée** de DEV (DB séparée)
- ✅ **Fonctionnelle** (Auth, Login, Tenant selection)
- ✅ **Déployée via GitOps** (manifests versionnés)
- ✅ **Stable** pour onboarding réel

---

## 2. BASE DE DONNÉES PROD

### 2.1 Nouvelle DB dédiée

| Propriété | Valeur |
|-----------|--------|
| Database | `keybuzz_prod` |
| User | `keybuzz_api_prod` |
| Host | `10.0.0.10` (via HAProxy LB) |
| Leader | `db-postgres-03` (10.0.0.122) |
| Cluster | `keybuzz-pg17` (Patroni HA) |

### 2.2 Preuve d'isolation

| Métrique | DEV (`keybuzz`) | PROD (`keybuzz_prod`) |
|----------|-----------------|----------------------|
| Users | 9 | 1 |
| Tenants | 13 | 0 |
| Conversations | 8400+ | 0 |
| Messages | 24000+ | 0 |

### 2.3 Création de la DB

```bash
# Exécuté sur db-postgres-03 (leader)
sudo -u postgres psql -c "CREATE USER keybuzz_api_prod WITH PASSWORD '***';"
sudo -u postgres psql -c "CREATE DATABASE keybuzz_prod OWNER keybuzz_api_prod;"
```

Schema copié depuis DEV (structure uniquement, pas de données).

---

## 3. SECRETS VAULT

### 3.1 Secret PROD mis à jour

**Path:** `secret/keybuzz/prod/db_api`

```
PGHOST=10.0.0.10
PGPORT=5432
PGDATABASE=keybuzz_prod
PGUSER=keybuzz_api_prod
PGPASSWORD=Pr0d_K3yBuzz_***
```

### 3.2 ExternalSecret synchronisé

```bash
kubectl get secret keybuzz-api-postgres -n keybuzz-api-prod \
  -o jsonpath='{.data.PGDATABASE}' | base64 -d
# Output: keybuzz_prod
```

---

## 4. MANIFESTS KUBERNETES (GitOps)

### 4.1 Nouveaux fichiers créés

| Fichier | Description |
|---------|-------------|
| `k8s/keybuzz-api-prod/deployment.yaml` | API PROD avec image stable |
| `k8s/keybuzz-client-prod/deployment.yaml` | Client PROD avec URLs correctes |

### 4.2 Commit Git

```
feat(PH28.2): Add PROD manifests for API and Client
 2 files changed, 242 insertions(+)
```

---

## 5. IMAGES DÉPLOYÉES

| Service | Image | Tag |
|---------|-------|-----|
| API | `ghcr.io/keybuzzio/keybuzz-api` | `v0.4.31-replacement` |
| Client | `ghcr.io/keybuzzio/keybuzz-client` | `prod-2026-02-01` |

### 5.1 Client PROD

Build avec NEXT_PUBLIC_* corrects:
- `NEXT_PUBLIC_API_URL=https://api.keybuzz.io`
- `NEXT_PUBLIC_APP_ENV=production`

---

## 6. TESTS E2E

### 6.1 Auth Flow ✅

| Étape | Résultat |
|-------|----------|
| Page login accessible | ✅ `200 /login` |
| Email OTP envoyé | ✅ Code reçu |
| Vérification code | ✅ Authentifié |
| Redirection tenant | ✅ `/select-tenant` |

### 6.2 Isolation des données ✅

| Vérification | Résultat |
|--------------|----------|
| Aucun tenant DEV visible | ✅ "Aucun espace disponible" |
| Aucune conversation DEV | ✅ DB vide |
| Utilisateur créé en PROD | ✅ 1 user dans `keybuzz_prod` |

### 6.3 Network Requests ✅

| Requête | Destination |
|---------|-------------|
| API calls | `api.keybuzz.io` (PROD) |
| Client assets | `client.keybuzz.io` (PROD) |
| DEV endpoints | ❌ Aucun appel |

---

## 7. ENDPOINTS PROD

### 7.1 API (api.keybuzz.io)

| Endpoint | Status |
|----------|--------|
| `/health` | ✅ 200 |
| `/tenants` | ✅ 200 |
| `/stats/dashboard` | ✅ 400 (requires params) |

### 7.2 Client (client.keybuzz.io)

| Endpoint | Status |
|----------|--------|
| `/` | 307 → /login |
| `/login` | ✅ 200 |
| `/signup` | ✅ 200 |

---

## 8. WORKFLOW DEV → PROD

### 8.1 Promotion sécurisée

```
1. Développer en DEV
2. Valider fonctionnellement
3. Créer tag stable (ex: v1.2.3-stable)
4. Mettre à jour manifest PROD avec le tag
5. kubectl apply -f k8s/keybuzz-*-prod/
6. Vérifier rollout
```

### 8.2 Rollback

```bash
# Revenir à l'image précédente
kubectl set image deployment/keybuzz-api \
  keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:PREVIOUS_TAG \
  -n keybuzz-api-prod

kubectl rollout status deployment/keybuzz-api -n keybuzz-api-prod
```

---

## 9. CHECKLIST DE VALIDATION

- [x] DB PROD créée et isolée
- [x] Secrets Vault mis à jour
- [x] ExternalSecrets synchronisés
- [x] Manifests K8s dans Git
- [x] API PROD déployée
- [x] Client PROD déployé avec bonnes URLs
- [x] Auth/Login fonctionne
- [x] Aucun appel vers DEV
- [x] Données isolées (DEV ≠ PROD)

---

## 10. PROCHAINES ÉTAPES

1. **Créer un tenant PROD** pour test complet
2. **Configurer webhooks Amazon** sur PROD
3. **Activer monitoring PROD** (alertes séparées)
4. **Documenter procédure de promotion** DEV → PROD

---

## 11. ARCHITECTURE FINALE

```
┌─────────────────────────────────────────────────────────────┐
│                         DEV                                 │
├─────────────────────────────────────────────────────────────┤
│  client-dev.keybuzz.io → api-dev.keybuzz.io → keybuzz (DB) │
│                                                             │
│  Images: v0.5.33-replacement / v0.4.31-replacement         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         PROD                                │
├─────────────────────────────────────────────────────────────┤
│  client.keybuzz.io → api.keybuzz.io → keybuzz_prod (DB)    │
│                                                             │
│  Images: prod-2026-02-01 / v0.4.31-replacement             │
└─────────────────────────────────────────────────────────────┘

        ⚠️ AUCUNE CONNEXION CROISÉE ⚠️
```

---

**Rapport généré - PH28.2 PROD Rebuild Complete**
