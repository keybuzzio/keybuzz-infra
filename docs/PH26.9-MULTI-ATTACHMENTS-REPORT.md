# PH26.9 - Amazon Multi-Attachments Report

**Date:** 2026-02-01  
**Status:** üîç INVESTIGATION COMPL√àTE - LIMITATION AMAZON IDENTIFI√âE

---

## 1. R√âSUM√â EX√âCUTIF

L'investigation r√©v√®le que **Amazon n'envoie PAS les pi√®ces jointes dans le payload email**. Le raw MIME ne contient que la notification texte, pas les images.

| Aspect | Constat |
|--------|---------|
| Message DB | `cmml3it8deaccd37be40e03c7` |
| PJ en DB | 1 seule (`IMG_4124.png` - 132KB) |
| PJ attendues | 2 (`IMG_4123.png` + `IMG_4124.png`) |
| Raw MIME size | 2178 bytes (trop petit pour images) |
| Cause racine | **Amazon notification sans PJ embedded** |

---

## 2. PREUVE DB

### 2.1 Message concern√©
```sql
-- Message avec "√âl√©ment photo"
id: cmml3it8deaccd37be40e03c7
conversation_id: cmml2a4opf32f9c0a5ef500ae
body: "√âl√©ment photo"
raw_mime_key: raw-mime/ecomlg-001/cmml3it8deaccd37be40e03c7.eml
raw_mime_size_bytes: 2178  -- TROP PETIT pour contenir des images
```

### 2.2 Attachment existant
```sql
id: att_d04167d75b7dc151d571e36a
message_id: cmml3it8deaccd37be40e03c7
filename: IMG_4124.png
size_bytes: 132112
status: uploaded
created_at: 2026-02-01 09:10:34.840066
```

### 2.3 Raw MIME Content
```
Vous avez recu un message.

# 171-0184035-7532305:
1 / G.Skill 16GB DDR4 ...

------------- Message:  -------------

√âl√©ment photo 

------------- Fin du message -------------

[... footer Amazon ...]
```

**CONSTAT:** Le raw MIME ne contient QUE le texte de notification, pas les donn√©es binaires des images.

---

## 3. ANALYSE DE CAUSE RACINE

### 3.1 Architecture Amazon Messaging

Amazon utilise une architecture o√π :
1. **Le client envoie des PJ** via l'interface Amazon
2. **Amazon stocke les PJ** sur ses serveurs
3. **Amazon envoie une notification** au vendeur avec texte "√âl√©ment photo"
4. **Les PJ NE SONT PAS** incluses dans le payload email

### 3.2 Comment la PJ existante a √©t√© stock√©e

L'attachment `IMG_4124.png` (132KB) cr√©√© 1 seconde apr√®s le message sugg√®re :
- Soit un webhook s√©par√© avec les donn√©es de l'image
- Soit un traitement asynchrone qui fetch les PJ depuis Amazon
- Soit un upload manuel (moins probable vu le timing)

### 3.3 Parser MIME - Audit

Le parser (`attachmentParser.service.ts`) a √©t√© audit√© :

```typescript
// Extraction des attachments - CORRECT
for (const part of attachmentParts) {
  // ...processing...
  result.attachments.push({
    filename: part.filename,
    mimeType,
    content: buffer,
    isInline: part.contentDisposition === 'inline',
  });
}
```

‚úÖ Le parser it√®re sur TOUS les `attachmentParts`  
‚úÖ Chaque attachment est `push()` (pas d'√©crasement)  
‚úÖ Pas de `break` ou `return` pr√©matur√© dans la boucle  

**Le parser est CORRECT pour les multi-PJ quand elles sont dans le MIME.**

---

## 4. LIMITATION IDENTIFI√âE

### Amazon ne transmet pas les PJ dans le payload

| Source | PJ Incluses ? |
|--------|---------------|
| Email webhook (actuel) | ‚ùå Non |
| Amazon SP-API Messaging | ‚ö†Ô∏è √Ä v√©rifier |
| Amazon Seller Central UI | ‚úÖ Oui (manuel) |

### Impact
- Les PJ envoy√©es par les clients via Amazon ne sont pas automatiquement r√©cup√©r√©es
- Le syst√®me re√ßoit seulement la notification texte ("√âl√©ment photo")
- Solution future : utiliser l'API Amazon SP-API pour fetcher les attachments

---

## 5. VALIDATION DU PARSER

### Test: MIME avec multiple attachments (si pr√©sents)

Le parser a √©t√© v√©rifi√© capable de traiter N attachments :

```typescript
// storeAttachments - CORRECT
export async function storeAttachments(params: {
  tenantId: string;
  messageId: string;
  attachments: ParsedAttachment[];  // Array de N attachments
}): Promise<StoredAttachment[]> {
  const stored: StoredAttachment[] = [];

  for (const attachment of attachments) {  // It√®re sur TOUS
    // ... store each one ...
    stored.push({...});
  }

  return stored;  // Retourne TOUS les stored
}
```

‚úÖ Pas de logique limitant √† 1 attachment  
‚úÖ Boucle compl√®te sur tous les attachments  
‚úÖ Stockage MinIO + DB pour chaque  

---

## 6. RECOMMANDATIONS

### Court terme
1. **Documenter la limitation** - Les PJ Amazon ne sont pas automatiquement import√©es
2. **Upload manuel** - Les utilisateurs peuvent ajouter les PJ manuellement via l'UI

### Moyen terme
3. **SP-API Messaging** - Impl√©menter l'API Amazon pour r√©cup√©rer les PJ
   - Endpoint: `/messaging/v1/orders/{orderId}/messages`
   - N√©cessite: OAuth avec scope `messaging`

### Long terme
4. **Sync automatique des PJ** - Worker qui fetch les PJ quand "√âl√©ment photo" est d√©tect√©

---

## 7. STATUT DES COMPOSANTS

### Parser MIME
| Fonction | Status |
|----------|--------|
| `extractMimePartsV2` | ‚úÖ Correct |
| `decodePartContentV2` | ‚úÖ Correct |
| `parseMimeEmail` | ‚úÖ Correct |
| `storeAttachments` | ‚úÖ Correct |

### Multi-PJ Support
| Composant | Multi-PJ Ready |
|-----------|----------------|
| Parser | ‚úÖ Oui |
| MinIO Storage | ‚úÖ Oui |
| DB Schema | ‚úÖ Oui (`message_attachments` table) |
| UI Display | ‚úÖ Oui (liste tous les attachments) |

---

## 8. REPLAY MIME

### Test de replay
```bash
# Le raw_mime_key existe
raw-mime/ecomlg-001/cmml3it8deaccd37be40e03c7.eml

# Mais ne contient pas les images (2178 bytes seulement)
# Replay ne produira pas plus d'attachments
```

**Conclusion:** Replay inutile car le raw MIME original n'a jamais contenu les images.

---

## 9. PROCHAINES √âTAPES

1. [ ] Confirmer avec Ludovic si l'IMG_4124.png a √©t√© upload√©e manuellement
2. [ ] Investiguer l'API Amazon SP-API Messaging pour fetch des PJ
3. [ ] Cr√©er un worker de sync automatique (PH futur)

---

## 10. FICHIERS ANALYS√âS

| Fichier | R√©sultat |
|---------|----------|
| `attachmentParser.service.ts` | ‚úÖ Multi-PJ correct |
| `inboundEmailWebhook.routes.ts` | ‚úÖ Passe tous les attachments |
| `inboxConversation.service.ts` | ‚úÖ Stocke tous les attachments |
| `mimeReplay.service.ts` | ‚úÖ Multi-PJ correct |

---

**Conclusion:** Le syst√®me KeyBuzz supporte correctement les multi-PJ quand elles sont pr√©sentes dans le payload. La limitation vient d'Amazon qui n'inclut pas les donn√©es des PJ dans les notifications email.

---

**Rapport g√©n√©r√© - PH26.9 Multi-Attachments Investigation**
