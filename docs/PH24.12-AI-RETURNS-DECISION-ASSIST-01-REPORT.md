# PH24.12-AI-RETURNS-DECISION-ASSIST-01 - Rapport

**Date**: 2026-01-22
**Environnement**: DEV uniquement

---

## üéØ Objectif

Ajouter une aide IA √† la d√©cision pour les demandes de retour Amazon, sans jamais agir √† la place du vendeur.

---

## ‚úÖ Livrables Impl√©ment√©s

### 1. Backend API Endpoint

**Fichier**: `/opt/keybuzz/keybuzz-api/src/modules/ai/returns-decision-routes.ts`

**Endpoint**: `POST /ai/returns/decision`

**Fonctionnalit√©s**:
- Validation des param√®tres (tenantId, conversationId, orderRef)
- Construction du `ReturnDecisionContext` avec donn√©es conversation, commande, historique client
- Prompt IA strict (assistant d√©cisionnel uniquement, jamais ex√©cutant)
- Gestion gracieuse des tables manquantes (orders)
- Calcul et d√©bit d√©cimal de KBActions
- R√©ponse structur√©e avec `riskLevel`, `summary`, `recommendedActions`, `refundSuggestion`, `warnings`, `confidence`
- Log de tra√ßabilit√© `AI_RETURNS_DECISION_TRACE`

**Gestion KBActions √©puis√©es**:
```json
{
  "status": "actions_exhausted",
  "error": "KBActions insuffisantes. Veuillez recharger votre compte.",
  "kbActionsRemaining": 0,
  "requestId": "req-xxx"
}
```

### 2. Client API Proxy

**Fichier**: `/opt/keybuzz/keybuzz-client/app/api/ai/returns/decision/route.ts`

**Route**: `POST /api/ai/returns/decision`

Proxy vers `https://api-dev.keybuzz.io/ai/returns/decision`

### 3. UI Module "Analyse IA du retour"

**Fichier**: `/opt/keybuzz/keybuzz-client/app/inbox/InboxTripane.tsx`

**Emplacement**: Sous le bloc orange "Demande de retour d√©tect√©e"

**√âl√©ments UI**:
- Badge "IA ‚Äì aide √† la d√©cision" (couleur violet)
- Bouton "Analyser ce retour (consomme des KBActions)"
- Loader pendant l'analyse
- Bloc d'erreur avec CTA "Acheter des KBActions" si √©puis√©es
- Affichage de l'analyse:
  - üü¢ Faible risque / üü° √Ä v√©rifier / üî¥ Risqu√©
  - R√©sum√© neutre
  - Actions recommand√©es (liste)
  - Suggestion de remboursement (optionnel)
  - Points d'attention (optionnel)
  - Niveau de confiance
- Bouton "Copier l'analyse"
- Bouton "Masquer/Afficher l'analyse"

---

## üß™ Tests E2E Valid√©s

### ‚úÖ Test 1: Retour Amazon simple ‚Üí analyse OK

```bash
curl -X POST https://api-dev.keybuzz.io/ai/returns/decision \
  -H 'Content-Type: application/json' \
  -d '{"tenantId":"ecomlg-001","conversationId":"test-001","orderRef":"403-2927481-4527502"}'
```

**R√©sultat**:
```json
{
  "status": "success",
  "analysis": {
    "riskLevel": "MEDIUM",
    "summary": "Demande de retour sans informations disponibles...",
    "recommendedActions": ["Contacter le client...", "V√©rifier manuellement..."],
    "warnings": ["Informations insuffisantes..."],
    "confidence": "faible"
  },
  "kbActionsConsumed": 0.78,
  "kbActionsRemaining": 87.712,
  "requestId": "req-mkxfwckp3qf7q5"
}
```

### ‚úÖ Test 2: D√©bit d√©cimal KBActions

- kbActionsConsumed: **0.78** (d√©cimal)
- kbActionsRemaining: **87.712** (d√©cimal)

### ‚úÖ Test 3: Gestion KBActions √©puis√©es (code review)

**Backend** (returns-decision-routes.ts):
```typescript
const actionsCheck = await checkActionsAvailable(tenantId);
if (!actionsCheck.available) {
  return reply.status(402).send({
    status: 'actions_exhausted',
    error: 'KBActions insuffisantes. Veuillez recharger votre compte.',
    kbActionsRemaining: actionsCheck.remaining,
    requestId,
  });
}
```

**Frontend** (InboxTripane.tsx):
```tsx
if (data.status === 'actions_exhausted') {
  setReturnsAnalysisError('KBActions insuffisantes...');
}
// + CTA "Acheter des KBActions ‚Üí" vers /billing/ai
```

### ‚úÖ Test 4: Aucune r√©gression Inbox/Retours existants

- Le module IA est affich√© UNIQUEMENT si `conversationType === 'RETURN_REQUEST'`
- L'existant (bloc orange "Demande de retour d√©tect√©e", bouton Seller Central) reste intact
- Aucun appel IA automatique (bouton explicite requis)

---

## üõë R√®gles Absolues Respect√©es

| R√®gle | Statut |
|-------|--------|
| ‚ùå Aucune action automatique | ‚úÖ |
| ‚ùå Aucun remboursement d√©clench√© | ‚úÖ |
| ‚ùå Aucun appel Amazon SP-API | ‚úÖ |
| ‚ùå Aucune r√©ponse envoy√©e au client | ‚úÖ |
| ‚ùå Aucune promesse faite au client | ‚úÖ |

**KeyBuzz = copilote d√©cisionnel, jamais ex√©cutant** ‚úÖ

---

## üìÅ Fichiers Modifi√©s/Cr√©√©s

| Fichier | Type | Description |
|---------|------|-------------|
| `keybuzz-api/src/modules/ai/returns-decision-routes.ts` | Cr√©√© | Backend endpoint IA retours |
| `keybuzz-api/src/app.ts` | Modifi√© | Import + register de la route |
| `keybuzz-client/app/api/ai/returns/decision/route.ts` | Cr√©√© | Client API proxy |
| `keybuzz-client/app/inbox/InboxTripane.tsx` | Modifi√© | UI module "Analyse IA du retour" |

---

## üìä M√©triques

- **KBActions par analyse**: ~0.78 (varie selon longueur contexte)
- **Temps de r√©ponse**: ~3-5 secondes
- **Mod√®le IA**: Via LiteLLM service

---

## üîú Non inclus (comme pr√©vu)

- Templates de r√©ponse retour
- Deep-link pr√©cis Seller Central (si Amazon change ses URLs)
- D√©ploiement PROD

---

## ‚úÖ Crit√®res de Validation

| Crit√®re | Statut |
|---------|--------|
| UI IA Retours int√©gr√©e dans Inbox | ‚úÖ |
| Endpoint backend d√©di√© `/ai/returns/decision` | ‚úÖ |
| D√©bit KBActions d√©cimal | ‚úÖ |
| Prompt IA strict (copilote, pas ex√©cutant) | ‚úÖ |
| Sortie structur√©e JSON | ‚úÖ |
| Affichage riskLevel avec badges couleur | ‚úÖ |
| Bouton "Analyser" explicite (pas d'auto) | ‚úÖ |
| Gestion "KBActions √©puis√©es" + CTA | ‚úÖ |
| Log tra√ßabilit√© | ‚úÖ |

---

**Statut final**: ‚úÖ TERMIN√â - Pr√™t pour validation fonctionnelle
