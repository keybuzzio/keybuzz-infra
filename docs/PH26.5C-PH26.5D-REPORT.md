# PH26.5C & PH26.5D — Report

**Date** : 2026-01-30  
**Status** : ✅ Déployé

---

## PH26.5C — Aide IA : Contexte manuel

### Objectif
Permettre à l'utilisateur d'ajouter du contexte à l'Aide IA (copier-coller depuis Seller Central, notes, etc.) pour compenser l'historique Amazon potentiellement incomplet.

### Implémentation

#### 1. UI dans le panneau Aide IA

Ajout dans `AISuggestionSlideOver.tsx` :
- **Bouton collapsible** : "Ajouter du contexte (copier-coller Seller Central...)"
- **Textarea** : Zone de texte pour coller le contexte
- **Badge** : Affiche le nombre de caractères ajoutés
- **Avertissement** : "Ce contexte est envoyé à l'IA mais pas à Amazon"

#### 2. Transmission du contexte

Le champ `additionalContext` existant dans le payload est maintenant utilisé :

```typescript
const result = await assistAI({
  tenantId,
  contextType: 'conversation',
  conversationId,
  payload: {
    messages: [...],
    additionalContext: userContext || undefined,  // PH26.5C
  },
});
```

#### 3. Badge après génération

Quand une suggestion est générée avec du contexte utilisateur, un badge apparaît :
```
✓ Contexte utilisateur inclus (XXX car.)
```

### Limitations (Phase 1)

- **Texte uniquement** : Pas d'upload de fichiers pour l'instant
- **Pas d'OCR** : Les images/PDF ne sont pas analysés
- **Non persisté** : Le contexte n'est pas sauvegardé entre sessions

### Phase 2 (future)

- Upload de fichiers vers MinIO
- Stockage dans le journal IA
- Support OCR pour images/screenshots

---

## PH26.5D — Forcer téléchargement PJ

### Problème

Les PJ s'ouvraient dans le navigateur (inline) au lieu d'être téléchargées.

### Cause racine

1. **Proxy client** : Le fallback utilisait `inline` au lieu de `attachment`
2. **Lien HTML** : Utilisait `target="_blank"` sans attribut `download`

### Fix appliqués

#### 1. Proxy Next.js (`app/api/attachments/[id]/route.ts`)

```typescript
// AVANT
"Content-Disposition": contentDisposition || `inline; filename="attachment"`,

// APRÈS (PH26.5D)
"Content-Disposition": contentDisposition 
  ? contentDisposition.replace(/^inline/, 'attachment')
  : `attachment; filename="attachment"`,
```

#### 2. UI (`InboxTripane.tsx`)

```tsx
// AVANT
<a href={...} target="_blank" rel="noopener noreferrer">

// APRÈS (PH26.5D)
<a href={...} download={att.filename} rel="noopener noreferrer">
```

### Validation

- Clic sur PJ → Téléchargement direct (pas d'ouverture inline)
- Double protection : header HTTP + attribut HTML

---

## Images déployées

| Service | Tag | Digest |
|---------|-----|--------|
| Client | `v0.5.13-ph265cd` | `sha256:4649f2f7c8edcbc08b71c160d1d442990436f1730e12e8d797b4c7e8ae88fd37` |

---

## Fichiers modifiés

### Client

| Fichier | Modification |
|---------|--------------|
| `app/api/attachments/[id]/route.ts` | Force `Content-Disposition: attachment` |
| `app/inbox/InboxTripane.tsx` | Ajout attribut `download` sur liens PJ |
| `src/features/ai-ui/AISuggestionSlideOver.tsx` | UI contexte + badge + transmission `additionalContext` |

---

## Tests recommandés

### PH26.5C - Contexte IA
1. Ouvrir une conversation Amazon
2. Cliquer "Aide IA"
3. Développer "Ajouter du contexte"
4. Coller du texte (ex: message Seller Central)
5. Générer une suggestion
6. Vérifier que le badge "Contexte utilisateur inclus" apparaît

### PH26.5D - Download PJ
1. Ouvrir une conversation avec PJ
2. Cliquer sur la PJ
3. Vérifier que le fichier est téléchargé (pas ouvert dans le navigateur)

---

**STATUS** : ✅ Déployé et opérationnel
