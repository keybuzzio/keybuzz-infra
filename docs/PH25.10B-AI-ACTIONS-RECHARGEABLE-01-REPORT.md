# PH25.10B-AI-ACTIONS-RECHARGEABLE-01 - Rapport

**Date** : 2026-01-26  
**Environnement** : DEV (keybuzz-api-dev, keybuzz-client-dev)  
**Tenant test** : ecomlg-001

---

## RÃ©sumÃ©

| Objectif | Statut |
|----------|--------|
| Bloc "Limite atteinte" | âœ… ImplÃ©mentÃ© |
| Modal packs d'actions | âœ… ImplÃ©mentÃ© |
| Checkout Stripe | âœ… ImplÃ©mentÃ© |
| CrÃ©dit wallet automatique | âœ… ImplÃ©mentÃ© |
| Aucune exposition USD/tokens | âœ… VÃ©rifiÃ© |

---

## A) Composants UI

### 1. AIActionsLimitBlock

AffichÃ© quand les actions IA sont Ã©puisÃ©es :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ Limite d'actions IA atteinte             â”‚
â”‚                                             â”‚
â”‚ Vous pouvez continuer Ã  rÃ©pondre            â”‚
â”‚ manuellement ou ajouter des actions IA      â”‚
â”‚ pour poursuivre sans interruption.          â”‚
â”‚                                             â”‚
â”‚ [âœ¨ Ajouter des actions IA] [Continuer sans IA] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. AIActionPacksModal

Modal de sÃ©lection des packs :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ¨ Ajouter des actions IA           [X]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“¦ Pack Small                    5 â‚¬    â”‚ â”‚
â”‚ â”‚    +50 actions IA              [â†’]      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“¦ Pack Medium          [Populaire]     â”‚ â”‚
â”‚ â”‚    +150 actions IA              12 â‚¬    â”‚ â”‚
â”‚ â”‚                                 [â†’]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“¦ Pack Large                   35 â‚¬    â”‚ â”‚
â”‚ â”‚    +500 actions IA              [â†’]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ Les actions sont utilisables immÃ©diatement. â”‚
â”‚ Paiement sÃ©curisÃ© par Stripe.               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## B) Packs d'actions

| Pack | Actions | Prix EUR | CrÃ©dit interne USD |
|------|---------|----------|-------------------|
| Small | 50 | 5 â‚¬ | $0.50 |
| Medium | 150 | 12 â‚¬ | $1.50 |
| Large | 500 | 35 â‚¬ | $5.00 |

**Important** : Le client ne voit JAMAIS :
- Les dollars ($)
- Les tokens
- Les coÃ»ts techniques IA

---

## C) Backend

### Endpoint crÃ©Ã©

`POST /billing/ai-actions-checkout`

**Body:**
```json
{
  "tenantId": "ecomlg-001",
  "packId": "medium",
  "priceAmountCents": 1200,
  "usdCredit": 1.50,
  "actions": 150,
  "successUrl": "https://client-dev.keybuzz.io/inbox?ai_actions=success",
  "cancelUrl": "https://client-dev.keybuzz.io/inbox?ai_actions=cancelled"
}
```

**Response:**
```json
{
  "url": "https://checkout.stripe.com/c/pay/cs_live_..."
}
```

### Webhook handler

Lors du `checkout.session.completed` avec `metadata.type === 'ai_actions'` :
1. RÃ©cupÃ¨re `tenant_id`, `usd_credit`, `actions`, `pack_id`
2. Appelle `addCredits(tenantId, usdCredit, 'topup', description, sessionId)`
3. Log: `[Billing] AI Actions credited: ecomlg-001 1.50 USD for 150 actions`

---

## D) Flux utilisateur

```
1. Utilisateur ouvre Aide IA
2. Si actions = 0 â†’ Bloc "Limite atteinte"
3. Clic "Ajouter des actions IA"
4. Modal avec packs (50/150/500)
5. Clic sur pack â†’ Stripe Checkout
6. Paiement â†’ Webhook â†’ addCredits()
7. Redirection â†’ /inbox?ai_actions=success
8. Wallet crÃ©ditÃ© â†’ Actions disponibles
```

---

## E) SÃ©curitÃ©

| RÃ¨gle | Statut |
|-------|--------|
| Pas d'appel IA automatique | âœ… |
| Pas d'exposition coÃ»ts techniques | âœ… |
| Pas de hardcoding tenantId | âœ… |
| Tenant-scoped | âœ… |
| Stripe uniquement | âœ… |

---

## Versions dÃ©ployÃ©es

### API
```
Image: ghcr.io/keybuzzio/keybuzz-api:v0.9.20-ph2510b-actions
Commit: f7abd84
```

### Client
```
Image: ghcr.io/keybuzzio/keybuzz-client:v0.5.40-ph2510b-actions
Commits: 4623eed, 8f4c95c
```

---

## Fichiers crÃ©Ã©s/modifiÃ©s

### Client
| Fichier | Modification |
|---------|--------------|
| `src/features/ai-ui/AIActionsLimit.tsx` | **NOUVEAU** - Composants UI |
| `src/features/ai-ui/AISuggestionSlideOver.tsx` | IntÃ©gration modal |
| `src/features/ai-ui/index.ts` | Exports |
| `src/services/ai.service.ts` | getAIWalletStatus |
| `app/api/billing/ai-actions-checkout/route.ts` | **NOUVEAU** - API route |

### API
| Fichier | Modification |
|---------|--------------|
| `src/modules/billing/routes.ts` | Endpoint + webhook handler |

---

## Historique facturation

AprÃ¨s achat, visible comme :
```
"Achat Pack Medium - 150 actions IA"
```

Dans `ai_credits_ledger` :
```sql
type: 'topup'
description: 'Achat Pack medium - 150 actions IA'
amount_usd: 1.50
reference_id: 'cs_live_xxxxx'
```

---

## Non-rÃ©gression

| Composant | Statut |
|-----------|--------|
| Inbox | âœ… Fonctionnel |
| Aide IA (slide-over) | âœ… Fonctionnel |
| Wallet existant | âœ… Non impactÃ© |
| Plans existants | âœ… Non impactÃ©s |
| Amazon/PJ/Orders | âœ… Non modifiÃ©s |

---

*Rapport gÃ©nÃ©rÃ© - 2026-01-26 11:20 UTC*
