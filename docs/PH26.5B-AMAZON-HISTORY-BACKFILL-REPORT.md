# PH26.5B — Amazon History Backfill — Analysis Report

**Date** : 2026-01-30  
**Status** : ⚠️ LIMITATION TECHNIQUE IDENTIFIÉE

---

## 1. Objectif initial

Quand un nouveau message Amazon arrive, KeyBuzz devait :
1. Identifier la conversation (orderId / threadId)
2. Vérifier si l'historique est complet
3. Si incomplet, fetch l'historique via SP-API et insert les messages manquants

---

## 2. Analyse technique

### 2.1. Structure actuelle des données

```sql
-- Conversations avec plusieurs messages (order_ref based)
order_ref           | tenant_id  | msg_count
--------------------+------------+----------
171-6428532-5365958 | ecomlg-001 |        8
171-9818805-2516327 | ecomlg-001 |        7
405-8836025-8168334 | ecomlg-001 |        5
```

**Clé de regroupement** : `order_ref` (Amazon Order ID)

### 2.2. SP-API Capabilities

| API | Capability | Usable for History? |
|-----|------------|---------------------|
| Messaging API | Send messages (confirmOrder, sendInvoice, etc.) | ❌ No |
| Orders API | Get orders, items, buyer info | ❌ No messages |
| Reports API | Generate reports | ❌ No message report |
| Notifications API | Subscribe to events | ❌ Real-time only |

**Conclusion** : Amazon SP-API **ne fournit pas d'endpoint pour récupérer l'historique des messages** d'une conversation.

### 2.3. Source unique des messages

Les messages Amazon arrivent uniquement via :
1. **Email forwarding** : Amazon → Seller Central → Forward → Postfix → KeyBuzz webhook
2. **Pas d'API pull** disponible

---

## 3. Limitation technique

### ⚠️ Le backfill automatique via SP-API n'est pas possible

Amazon ne permet pas de :
- Récupérer l'historique d'une conversation
- Lister les messages reçus
- Accéder aux messages archivés

**Les messages ne peuvent être récupérés que s'ils ont été reçus via email forwarding.**

---

## 4. Solution pragmatique

### 4.1. Améliorer la capture initiale

1. **Stocker le raw MIME complet** dans `ExternalMessage.raw.rawBody`
   - Permet de rejouer le parsing si le parser est amélioré
   - Actuellement seul le body parsé est stocké

2. **Extraire et stocker les Amazon IDs** du message :
   - `amazonIds.threadId` (depuis les URLs dans le body)
   - `amazonIds.orderId` (depuis le subject/body)
   - Utilisés pour le regroupement

### 4.2. Thread key stable

Le `thread_key` dans la table `conversations` permet de regrouper les messages d'une même conversation :

```
thread_key format:
- sc:{threadId}    → Si threadId extrait des URLs
- order:{orderId}  → Si orderId disponible
- hash:{hash}      → Fallback basé sur from+subject
```

### 4.3. Recommandation pour le futur

Si Amazon ajoute un jour une API de récupération d'historique :
- La clé `order_ref` est déjà utilisée comme identifiant de conversation
- L'infrastructure de backfill existe (`amazonOrdersBackfill.service.ts`)
- Adapter serait relativement simple

---

## 5. Actions complétées (PH26.5A)

| Action | Status |
|--------|--------|
| Fix parsing MIME (texte+PJ) | ✅ Déployé v1.0.38-ph265a |
| PJ téléchargement forcé | ✅ Déployé v1.0.36-ph265 |
| Parser valide texte+attachment | ✅ Testé avec fixture |

---

## 6. Actions recommandées (future)

| Action | Priorité | Effort |
|--------|----------|--------|
| Stocker raw MIME complet | Haute | Faible |
| Extraire amazonIds systématiquement | Moyenne | Moyen |
| Améliorer thread_key extraction | Basse | Moyen |

---

## 7. Conclusion

**Le backfill automatique de l'historique Amazon via SP-API n'est techniquement pas possible** car Amazon ne fournit pas d'API pour récupérer les messages d'une conversation.

**La stratégie actuelle reste la meilleure** :
1. Recevoir les messages via email forwarding
2. Parser correctement texte + PJ (fix PH26.5A ✅)
3. Regrouper par order_ref dans les conversations

**Les améliorations futures** doivent se concentrer sur :
- Améliorer la capture initiale (raw MIME, amazonIds)
- S'assurer qu'aucun message n'est perdu lors du forwarding

---

**Versions :**
- Backend: v1.0.38-ph265a
- Parser MIME: Fix validé avec texte+PJ
- PJ Download: Content-Disposition: attachment
