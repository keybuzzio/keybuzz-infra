# PH25.11-KBACTIONS-RENAME-MAPPING-01 - Rapport

**Date**: 2026-01-26
**Environnement**: DEV uniquement
**Statut**: COMPLETE

## Objectif

Finaliser le passage vers l'unité propriétaire **KBActions** avec :
- Renommage UX complet
- Consommation décimale basée sur le coût réel
- Mapping technique `computeKBActions(costUsd)`
- Aucune régression

## 1. Mapping Technique

### Fonction `computeKBActions(costUsd: number): number`

```typescript
/**
 * Convert USD cost to KBActions
 * Base rate: 1 KBAction = $0.01
 * Result rounded to 3 decimals
 * Minimum: 0.1 KBActions
 */
export function computeKBActions(costUsd: number): number {
  const kbActions = costUsd * 100;
  const rounded = Math.round(kbActions * 1000) / 1000;
  return Math.max(0.1, rounded);
}
```

**Exemples:**
| Coût USD | KBActions |
|----------|-----------|
| $0.0065  | 0.65      |
| $0.021   | 2.1       |
| $0.0001  | 0.1 (min) |

## 2. Migration DB

Tables `ai_actions_wallet` et `ai_actions_ledger` modifiées:
- `remaining`, `purchased_remaining`, `included_monthly` → `NUMERIC(12,3)`
- `delta` → `NUMERIC(12,3)`
- Nouveaux champs: `kb_actions`, `cost_usd`

## 3. Backend - Service KBActions

**Fichier**: `src/services/ai-actions.service.ts`

Fonctions mises à jour:
- `computeKBActions(costUsd)` - Conversion USD → KBActions
- `estimateKBActions(model)` - Estimation avant génération
- `debitKBActions(tenantId, requestId, kbActions, conversationId, costUsd)` - Débit décimal
- `getActionsWallet()` - Retourne solde décimal
- `addPurchasedActions()` - Ajoute des KBActions achetées

## 4. Backend - Route `/ai/assist`

Modifications:
1. Après LLM: calcul `kbActionsToDebit = computeKBActions(actualCost)`
2. Débit via `debitKBActions()` avec coût réel
3. Réponse inclut `kbActionsConsumed` et `kbActionsRemaining` (décimaux)

**Trace log:**
```json
KBACTIONS_DEBIT_TRACE {
  "tenantId": "ecomlg-001",
  "requestId": "req-xxx",
  "kbActions": 0.65,
  "costUsd": 0.0065,
  "remainingBefore": 100,
  "remainingAfter": 99.35
}
```

## 5. Backend - `/ai/wallet/status`

Réponse mise à jour:
```json
{
  "kbActions": {
    "remaining": 99.35,
    "includedMonthly": 50,
    "purchasedRemaining": 49.35,
    "resetAt": "2026-02-01T00:00:00.000Z"
  },
  "actions": { ... }  // Backward compat
}
```

## 6. Frontend - Renommage UX

### Avant → Après

| Ancien | Nouveau |
|--------|---------|
| Actions IA | KBActions |
| Acheter des actions | Acheter des KBActions |
| Actions restantes | KBActions restantes |
| Incluses/mois | KBActions incluses / mois |
| Actions achetées | KBActions achetées |
| Actions épuisées | KBActions épuisées |

### Fichiers modifiés

- `/billing/ai/page.tsx` - Titre, labels, stats
- `AISuggestionSlideOver.tsx` - Prompt, compteur, erreurs
- `AIActionsLimit.tsx` - Blocs limite, modal, packs

## 7. Packs Stripe

```typescript
export const ACTION_PACKS: ActionPack[] = [
  { id: 'small', name: 'Pack Small', kbActions: 50, priceEur: 5 },
  { id: 'medium', name: 'Pack Medium', kbActions: 150, priceEur: 12, popular: true },
  { id: 'large', name: 'Pack Large', kbActions: 500, priceEur: 35 },
];
```

**Affichage**: "+50 KBActions", "+150 KBActions", etc.

## 8. Tests API

```bash
# Wallet status
curl "https://api-dev.keybuzz.io/ai/wallet/status?tenantId=ecomlg-001"
→ { kbActions: { remaining: 100, ... } }

# Set KBActions (DEV)
curl -X POST 'https://api-dev.keybuzz.io/ai/wallet/dev/set-actions' \
  -d '{"tenantId":"ecomlg-001","remaining":100}'
→ { actions: { remaining: 100, ... } }

# Ledger
curl "https://api-dev.keybuzz.io/ai/wallet/actions/ledger?tenantId=ecomlg-001"
→ { ledger: [{ delta: -0.65, kbActions: 0.65, costUsd: 0.0065, ... }] }
```

## 9. Versions déployées

- **API**: `ghcr.io/keybuzzio/keybuzz-api:v0.9.23-ph2511`
- **Client**: `ghcr.io/keybuzzio/keybuzz-client:v0.5.47-ph2511`

## 10. Tests E2E à effectuer

1. **`/billing/ai`**:
   - Titre "KBActions" visible
   - Stats avec décimales (ex: 99.35 KBActions restantes)
   - Bouton "Acheter des KBActions"

2. **Inbox → Aide IA**:
   - Label "Consomme des KBActions"
   - "KBActions restantes : X.X"
   - Après génération: KBActions baisse selon coût réel

3. **Set KBActions à 0** → 402 ACTIONS_EXHAUSTED:
   - Message "KBActions épuisées"
   - CTA "Acheter des KBActions"

4. **Packs**:
   - Affichage "+50 KBActions", "+150 KBActions", "+500 KBActions"
   - Pas de $ visible

## Règles respectées

- ✅ KBActions = unique unité visible
- ❌ Pas de $ exposé
- ❌ Pas de tokens exposé
- ❌ Pas de coûts LLM exposé
- ✅ Valeurs décimales (ex: 0.65, 2.1)
- ✅ Aucun hardcodage
- ✅ Backward compatibility (champ `actions` conservé)
- ✅ DEV uniquement (PROD intacte)

## Non impacté

- Amazon inbound/outbound
- Inbox fonctionnel
- PJ
- Orders
- SLA
- Plans/quotas (inchangés)
