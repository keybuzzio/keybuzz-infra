# PH32.4 â€” AUDIT IA CONTEXT (rapport intermediaire)

**Date** : 2026-02-11
**Fichier audite** : `keybuzz-api/src/modules/ai/ai-assist-routes.ts` (874 lignes)

---

## 1. Construction du prompt

### Fichier principal
`src/modules/ai/ai-assist-routes.ts`

### Fonction cle : `buildSystemPrompt(contextType, orderContext, tenantRules)`

Le system prompt est construit en couches :

1. **Base** : Instructions generales KeyBuzz (langue, empathie, regles)
2. **Contexte commande** (`orderContext`) : reference, statut, tracking, articles, fulfillment
3. **Regles tenant** (`tenantRules`) : regles IA actives du vendeur (langue, ton, instructions)
4. **Instructions finales** : demande de suggestion + actions + analyse

### Payload envoye au LLM

```typescript
messages = [
  { role: 'system', content: buildSystemPrompt(...) },
  { role: 'user', content: 'Conversation:\n...\n\nPropose une reponse...' }
]
```

- **Temperature** : 0.7
- **Max tokens** : 1024
- **Moteur** : LiteLLM (OpenAI/Anthropic via proxy)
- **Modele** : selectionne selon le plan tenant (starter/pro/enterprise)

## 2. Contexte actuellement injecte

| Element | Source | Present |
|---------|--------|---------|
| Messages conversation (10 derniers) | `messages` table | Oui |
| Contexte commande | `orders` table (ou import on-demand) | Oui |
| Articles commandes | `orders.products` JSONB | Oui |
| Instructions utilisateur (`additionalContext`) | Payload frontend | Oui |
| Regles IA tenant | `ai_rules` / `ai_rule_conditions` / `ai_rule_actions` | Oui |
| Detection langue client | Heuristique sur dernier message client | Oui |
| **Contexte fournisseur** | `supplier_cases` / `suppliers` / `messages` | **NON** |

## 3. Point d'injection identifie

### Dans `buildSystemPrompt()` :
- **Apres** le bloc `=== REGLES SPECIFIQUES DU VENDEUR ===`
- **Avant** les instructions finales (`Contexte: ... Tu dois fournir: ...`)

### Dans le route handler `/assist` :
- **Apres** le chargement des regles tenant (~ligne 558)
- **Avant** la construction du tableau `messages`

## 4. Approche retenue

- Ajouter une interface `SupplierContext`
- Ajouter une fonction `loadSupplierContext(pool, tenantId, conversationId)`
- Modifier `buildSystemPrompt()` pour accepter un 4e parametre `supplierContext`
- Injecter un bloc `=== CONTEXTE FOURNISSEUR ===` lisible par l'IA
- NE PAS inclure : `reply_to_address`, email technique, UUID
- NE PAS modifier KBActions ni la consommation
- NE PAS modifier les routes Amazon ou la logique existante
