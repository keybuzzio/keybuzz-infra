# PH25.9-AI-DEGRADED-RESTORE+UTF8-01 - Rapport

**Date** : 2026-01-25
**Environnement** : DEV (keybuzz-api-dev, keybuzz-client-dev)
**Tenant test** : ecomlg-001

---

## R√©sum√©

| Objectif | Statut |
|----------|--------|
| Sortir l'IA du mode d√©grad√© | ‚úÖ Corrig√© |
| G√©n√©rer suggestions via LiteLLM | ‚úÖ Fonctionnel |
| Corriger mojibake UTF-8 | ‚úÖ Corrig√© |
| Valider d√©bit wallet/budget | ‚úÖ V√©rifi√© |

---

## 1) Diagnostic - Cause du "mode d√©grad√©"

### Sympt√¥me
Le panneau "Aide IA" affichait "KeyBuzz n'a pas de suggestion pour ce message" au lieu de g√©n√©rer des r√©ponses via LiteLLM.

### Cause identifi√©e
Le composant `AIDecisionPanel.tsx` appelait uniquement `/ai/evaluate` qui match des **r√®gles m√©tier** (table `ai_rules`). Sans r√®gles configur√©es, aucune suggestion n'√©tait retourn√©e.

L'endpoint `/ai/assist` (qui appelle LiteLLM) n'√©tait **jamais appel√©** par le panneau IA.

### Preuve
```
Network requests:
- POST https://api-dev.keybuzz.io/ai/evaluate ‚Üí { suggestions: [] }
- GET https://api-dev.keybuzz.io/ai/settings ‚Üí OK
- ‚ùå AUCUN appel vers /ai/assist
```

---

## 2) V√©rification LiteLLM

### Test endpoint
```bash
curl https://llm.keybuzz.io/v1/models -H "Authorization: Bearer ****"
```

**R√©ponse:**
```json
{
  "data": [
    {"id": "kbz-cheap", "object": "model"},
    {"id": "kbz-standard", "object": "model"},
    {"id": "kbz-premium", "object": "model"}
  ]
}
```

‚úÖ **LiteLLM fonctionne** - 3 mod√®les disponibles

### Test /ai/assist
```bash
curl -X POST https://api-dev.keybuzz.io/ai/assist -d '{
  "tenantId": "ecomlg-001",
  "contextType": "conversation",
  "conversationId": "test123",
  "payload": { "messages": [{"role": "customer", "content": "Bonjour"}] }
}'
```

**R√©ponse:**
```json
{
  "status": "success",
  "suggestions": [{"id": "sug-...", "content": "R√©ponse g√©n√©r√©e...", "confidence": 0.85}],
  "provider": "litellm",
  "model": "kbz-standard",
  "usage": {"tokens": 425, "costUsd": 0.00402}
}
```

‚úÖ **LiteLLM g√©n√®re des r√©ponses** via `/ai/assist`

---

## 3) Correction - AIDecisionPanel appelle /ai/assist

### Modifications

**Fichier:** `keybuzz-client/src/services/ai.service.ts`
- Ajout interface `AIAssistResponse`
- Ajout fonction `assistAI()`

**Fichier:** `keybuzz-client/src/features/ai-ui/AIDecisionPanel.tsx`
- Import de `assistAI` et `AIAssistResponse`
- Modification de `loadAIData()`:
  - Si `/ai/evaluate` ne retourne pas de suggestions
  - Alors appel `/ai/assist` pour obtenir des suggestions LiteLLM

### Code cl√©
```typescript
// Si pas de suggestions r√®gles, appeler LiteLLM
if (!aiEval?.suggestions?.length && !aiEval?.blocked) {
  const assistResult = await assistAI({
    tenantId, contextType: 'conversation', conversationId,
    payload: { messages: [...] }
  });
  // Convertir format AIAssist ‚Üí AIEvaluate
  finalEval = { status: 'success', suggestions: assistResult.suggestions.map(...) };
}
```

### Commits
- `65585b4` - fix(PH25.9): AIDecisionPanel calls /ai/assist for LiteLLM suggestions
- `69ee661` - fix: correct syntax error in ai.service.ts

---

## 4) Correction UTF-8 / Apostrophes

### Probl√®me
Les strings dans `AIDecisionPanel.tsx` avaient des apostrophes manquantes:
- `"n a pas"` ‚Üí devrait √™tre `"n'a pas"`
- `"l envoi"` ‚Üí devrait √™tre `"l'envoi"`

Et des apostrophes non-√©chapp√©es en JSX:
- `<p>KeyBuzz n'a pas...</p>` ‚Üí erreur React

### Solution
1. Ajout des apostrophes correctes
2. √âchappement en JSX avec `&apos;`

### Commits
- `60d64d4` - fix(PH25.9): fix apostrophe encoding
- `137d052` - fix(PH25.9): escape JSX apostrophes with HTML entity

---

## 5) Validation d√©bit

### Test avant g√©n√©ration
```json
{
  "dailyPlanUsedUsd": 0.008319,
  "balanceUsd": 8,
  "today": { "calls": 2, "tokens": 929 }
}
```

### Test apr√®s g√©n√©ration
```json
{
  "dailyPlanUsedUsd": 0.014931,
  "balanceUsd": 8,
  "today": { "calls": 3, "tokens": 1569 }
}
```

### Analyse
| M√©trique | Avant | Apr√®s | Diff |
|----------|-------|-------|------|
| dailyPlanUsedUsd | $0.0083 | $0.0149 | +$0.0066 |
| calls | 2 | 3 | +1 |
| tokens | 929 | 1569 | +640 |
| balanceUsd | $8.00 | $8.00 | $0 (correct) |

‚úÖ **Le d√©bit fonctionne** - Budget plan utilis√© en premier, wallet inchang√©

---

## Versions d√©ploy√©es

### Client
```
Image: ghcr.io/keybuzzio/keybuzz-client:v0.5.35-ph259-utf8
Commits: 65585b4, 69ee661, 60d64d4, 137d052
```

### API
Aucune modification n√©cessaire - LiteLLM fonctionnait d√©j√†

---

## R√©sultat final - UI

### Avant (mode d√©grad√©)
```
[Bot icon]
KeyBuzz n'a pas de suggestion pour ce message
Vous pouvez r√©pondre manuellement
```

### Apr√®s (IA active)
```
[Bot icon] üü¢
D√©cision KeyBuzz - Suggestion
KeyBuzz peut vous aider

[R√©ponse propos√©e]
"Bonjour ! Je serais ravi de vous renseigner sur l'√©tat de votre commande..."

[Laisser KeyBuzz r√©pondre] [Modifier avant envoi] [Je r√©ponds moi-m√™me]
```

---

## Non-r√©gression

| Composant | Statut |
|-----------|--------|
| Inbox Amazon | ‚úÖ Non modifi√© |
| Outbound SMTP | ‚úÖ Non modifi√© |
| PJ MIME | ‚úÖ Non modifi√© |
| Wallet DEV tools | ‚úÖ Fonctionne |
| Dashboard | ‚úÖ Donn√©es API |

---

*Rapport g√©n√©r√© - 2026-01-25 14:10 UTC*
