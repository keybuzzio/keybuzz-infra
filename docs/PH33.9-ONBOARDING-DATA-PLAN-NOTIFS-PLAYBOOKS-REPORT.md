# PH33.9 — Onboarding Data Persistence + Plan + Notifications + Seed Playbooks — REPORT

**Date** : 2026-02-13  
**Environnement** : DEV uniquement  
**Statut** : DEPLOYE en DEV — En attente validation Ludovic

---

## Objectif

Après un onboarding `/register` complet en DEV :
1. **Paramètres → Entreprise** affiche les infos saisies (SIRET, adresse, etc.)
2. **Paramètres → Notifications** email prérempli
3. **Facturation** affiche le plan réellement choisi (Starter/Pro/Autopilot)
4. **Automatisation IA** contient des playbooks par défaut "KeyBuzz" (non eComLG)

---

## Snapshot rollback

| Service | Tag avant PH33.9 | Tag PH33.9 |
|---------|-------------------|------------|
| **Client DEV** | `v3.4.0-ph33-session-bootstrap-fix-1` | `v3.4.0-ph339-onboarding-data-fix-1` |
| **API DEV** | `v3.4.0-ph33-onboarding-dev` | `v3.4.0-ph339-onboarding-data-fix-1` |

**Rollback** : revenir aux tags précédents dans `k8s/keybuzz-client-dev/deployment.yaml` et `k8s/keybuzz-api-dev/deployment.yaml`.

---

## Fix 1 : Enterprise profile persistence

### Problème
`create-signup` écrivait correctement `siret`, `street`, `zip_code`, `city`, `company_phone` dans `tenant_metadata`, mais :
- Le endpoint `GET /tenant-context/profile/:tenantId` ne les retournait pas
- Le endpoint `PUT /tenant-context/profile/:tenantId` ne les acceptait pas
- L'UI Settings ProfileTab n'avait que 4 champs (companyName, email, phone, returnAddress)

### Corrections

**Backend** (`keybuzz-api/src/modules/auth/tenant-context-routes.ts`) :
- **GET** : étendu la query SELECT pour inclure `siret, street, zip_code, city, company_phone`
- **GET** : ajouté dans la réponse JSON : `siret`, `street`, `zipCode`, `city`, `companyPhone`, `country`
- **PUT** : étendu le type Body pour accepter les nouveaux champs
- **PUT** : étendu le UPSERT SQL avec les colonnes `siret, street, zip_code, city, company_phone` ($6-$10)

**Frontend** :
- `app/settings/types.ts` : `BusinessProfile` étendu avec `siret`, `street`, `zipCode`, `city`, `companyPhone`, `country`
- `app/settings/constants.ts` : `defaultProfile` mis à jour avec valeurs vides
- `app/settings/components/ProfileTab.tsx` : refactoré avec 2 sections :
  - **Identité entreprise** : Nom société, SIRET, Email contact, Téléphone entreprise, Téléphone principal
  - **Adresse** : Rue, Code postal, Ville, Pays (select), Adresse de retour
- `app/settings/page.tsx` : mapping API → state étendu avec les nouveaux champs ; payload save étendu

### Preuve DB

```
tenant-1770996266047 (SWITAA):
  plan: STARTER
  support_email: contact@switaa.com
  street: 137 Avenue de la République
  zip_code: 26270
  city: Loriol-sur-Drôme
  company_phone: +33783348999
  company_country: FR
  phone: +33783348999
```

---

## Fix 2 : Notifications email prefill

### Problème
`NotificationSettings.emailAddress` initialisé à `""` (placeholder "alertes@monentreprise.com"), jamais prérempli depuis le profil.

### Correction
Dans `app/settings/page.tsx`, après le chargement du profil :
```typescript
// PH33.9: Prefill notification email from profile if empty
if (!data.notifications?.emailAddress && data.profile?.email) {
  setNotifications(prev => ({ ...prev, emailAddress: data.profile.email }));
}
```
Si `emailAddress` est vide et que `profile.email` (= `support_email` en DB) existe, il est utilisé comme valeur initiale.

---

## Fix 3 : Plan correctness

### Pipeline vérifié
Le pipeline plan fonctionne correctement sans modification :

1. `/register` → `create-signup` → `INSERT INTO tenants (plan)` avec le plan choisi
2. `GET /billing/current?tenantId=...` :
   - D'abord cherche dans `billing_subscriptions`
   - Si absent, fallback sur `tenants.plan` (source de vérité)
3. `useCurrentPlan()` hook React → appelle BFF `/api/billing/current` → affiche le plan dans l'UI Facturation

### Vérification
- `tenant-1770996266047` → `plan: STARTER` en DB
- Aucun hardcode "Pro" par défaut : si plan absent, fallback = `STARTER`

---

## Fix 4 : Seed playbooks par défaut KeyBuzz

### Implémentation
Fonction `seedDefaultPlaybooks(pool, tenantId)` ajoutée dans `tenant-context-routes.ts` :

- **Idempotence** : vérifie `SELECT count(*) FROM ai_rules WHERE tenant_id = $1` — si > 0, skip
- **Appelée** dans `create-signup` après la création du tenant
- **5 playbooks neutres** (aucune mention eComLG) :

| # | Nom | Description |
|---|-----|-------------|
| 1 | Retard livraison | Réponse automatique aux signalements de retard |
| 2 | Où est ma commande | Fournir le statut de suivi |
| 3 | Produit endommagé | Réclamation avec demande de photo |
| 4 | Demande de retour | Procédure standard de retour |
| 5 | Sans réponse 2h — Escalade | Alerte quand message sans réponse > 2h |

- **Signature** : "Service client {{companyName}}" (variable, pas hardcodé)
- **Stockage** : table `ai_rules` avec `is_active = true`

### Note
Les playbooks seront seedés automatiquement pour tout **nouveau** tenant créé via `/register`. Les tenants existants ne sont pas impactés (pas de migration rétroactive).

---

## Tags et digests déployés

| Image | Tag | Digest |
|-------|-----|--------|
| `keybuzz-api` | `v3.4.0-ph339-onboarding-data-fix-1` | `sha256:fa53947c69d40da918bd231c6627a00995c1aa51d2f303f479fb30dda32e7ed9` |
| `keybuzz-client` | `v3.4.0-ph339-onboarding-data-fix-1` | `sha256:11cab1d7913a82943dce4c3b33388842c46f8c0dfb1a1bcbce579c33bab46a3c` |

---

## Fichiers modifiés

### Backend (keybuzz-api)
- `src/modules/auth/tenant-context-routes.ts`
  - GET profile étendu (siret, street, zip_code, city, company_phone, country)
  - PUT profile étendu (accept + persist new fields)
  - `seedDefaultPlaybooks()` function + appel dans create-signup

### Frontend (keybuzz-client)
- `app/settings/types.ts` — BusinessProfile étendu
- `app/settings/constants.ts` — defaultProfile mis à jour
- `app/settings/components/ProfileTab.tsx` — UI complète avec SIRET, adresse, pays
- `app/settings/page.tsx` — mapping API étendu + save étendu + notification email prefill

### Infra (keybuzz-infra)
- `k8s/keybuzz-client-dev/deployment.yaml` — image tag updated
- `k8s/keybuzz-api-dev/deployment.yaml` — image tag updated

---

## Tests E2E à effectuer

### Scénario complet
1. Navigation privée → `https://client-dev.keybuzz.io/register?plan=starter`
2. Auth OTP ou Google
3. Remplir infos entreprise (nom, SIRET, adresse, téléphone)
4. Remplir infos user
5. Stripe Checkout (carte test 4242...)
6. Vérifier :
   - [ ] **Paramètres → Entreprise** : tous les champs remplis (nom, SIRET, rue, CP, ville, téléphone)
   - [ ] **Paramètres → Notifications** : email prérempli avec l'email de contact
   - [ ] **Facturation** : plan "Starter" affiché, KBActions = 0, limitations correctes (1 canal)
   - [ ] **Automatisation IA** : 5 playbooks présents (neutres, sans mention eComLG)
   - [ ] Les boutons "Configurer Amazon" et "Aller au dashboard" fonctionnent

---

## Commit Git

| Repo | Commit | Message |
|------|--------|---------|
| `keybuzz-infra` | `37ebcd8` | PH33.9: update DEV images - onboarding data persistence fix |

---

## STOP POINT

**PROD non déployé.** En attente de validation de Ludovic.

Rollback possible vers :
- Client : `v3.4.0-ph33-session-bootstrap-fix-1`
- API : `v3.4.0-ph33-onboarding-dev`
