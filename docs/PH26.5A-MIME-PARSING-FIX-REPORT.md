# PH26.5A — MIME Parsing Fix Report

**Date** : 2026-01-30  
**Environnement** : DEV ONLY  
**Status** : ✅ Déployé, en attente de validation E2E

---

## 1. Localisation de la fonction

**Fichier** : `/opt/keybuzz/keybuzz-backend/src/modules/webhooks/attachmentParser.service.ts`

**Flux identifié** :
1. `inboundEmailWebhook.routes.ts` reçoit le webhook avec `payload.body` (MIME brut)
2. Appelle `parseMimeEmail(payload.body)` → fonction synchrone
3. `parseMimeEmail` appelle `parseMimeEmailManual` (fallback manuel)
4. Retourne `{ textBody, htmlBody, attachments }`

**Fonction cible** : `parseMimeEmailManual(rawEmail: string): ParsedEmail`

---

## 2. Logs des parts MIME (PH26.5A DEBUG)

Nouveaux logs ajoutés pour chaque part :

```
[MimeParser PH26.5A] Boundary: ------=_Part_...
[MimeParser PH26.5A] Found N raw parts
[MimeParser PH26.5A] Part 0: type=text/plain, disp=, file=none, enc=quoted-printable, size=XXX, isText=true, isAtt=false
[MimeParser PH26.5A] Part 1: type=application/pdf, disp=attachment, file=document.pdf, enc=base64, size=XXX, isText=false, isAtt=true
```

**Métadonnées loguées** (sans PII) :
- `contentType` : type MIME
- `contentDisposition` : inline/attachment
- `filename` : nom du fichier (si présent)
- `transferEncoding` : base64/quoted-printable
- `charset` : charset déclaré
- `size` : taille en bytes
- `isTextCandidate` : true si text/* sans filename
- `isAttachmentCandidate` : true si filename OU disposition=attachment

---

## 3. Cause racine identifiée

### Bug classique confirmé

**AVANT (code original)** :
```typescript
// Extraction text/plain avec regex restrictif
const textPlainMatch = rawEmail.match(/Content-Type:\s*text\/plain[^]*?\n\n([\s\S]*?)(?=------=_Part|$)/i);
```

**Problèmes** :
1. Le regex attendait `\n\n` mais Amazon envoie parfois `\r\n\r\n`
2. Le texte pouvait être dans une part alternative (multipart/alternative)
3. Si la PJ était parsée en premier et qu'aucun texte n'était trouvé, le fallback mettait `[Pièce jointe reçue]`
4. Pas de décodage charset correct (iso-8859-1 → utf-8)

---

## 4. Fix implémenté

### Nouvelle approche (PH26.5A)

```typescript
// 1. Extraire TOUTES les parts MIME avec métadonnées
const parts = extractMimePartsV2(rawEmail);

// 2. Séparer text candidates et attachments
const textParts = parts.filter(p => p.isTextCandidate);
const attachmentParts = parts.filter(p => p.isAttachmentCandidate);

// 3. PRIORITÉ body: text/plain non vide > text/html converti > fallback
for (const part of textParts) {
  if (part.contentType === 'text/plain') {
    const decoded = decodePartContentV2(part);
    if (decoded.trim().length > 0) {
      result.textBody = decoded;
      break;  // STOP - on a trouvé le texte
    }
  }
}

// 4. PJ = toutes les parts avec filename OU disposition=attachment
// Ne jamais écraser le body avec une PJ
```

### Règles appliquées

| Règle | Implementation |
|-------|----------------|
| Body jamais écrasé par PJ | `isTextCandidate` vs `isAttachmentCandidate` séparés |
| Priorité text/plain | Boucle sur `textParts`, break dès non-vide |
| Fallback text/html | Si text/plain vide, convertir HTML → text |
| Décodage correct | `decodePartContentV2` : base64, quoted-printable, charset |
| Logs debug | Métadonnées de chaque part (sans contenu) |

---

## 5. Déploiement

### Image déployée

```
ghcr.io/keybuzzio/keybuzz-backend:v1.0.37-ph265a
Digest: sha256:525b294099b05502c4f20f4afa43e395b4851b464d3ce69e8ea0870632f30b37
```

### Backup

```
/opt/keybuzz/keybuzz-backend/src/modules/webhooks/attachmentParser.service.ts.bak.ph265a.20260130_163408
```

---

## 6. Validation E2E (À FAIRE)

### Test attendu

Quand un nouvel email Amazon avec PJ arrive :

1. **Logs** : Vérifier les logs `[MimeParser PH26.5A]` dans le pod
2. **textBody** : Doit contenir le texte du message (non vide)
3. **attachments** : Doit contenir la PJ avec filename correct
4. **Inbox** : Texte visible + PJ téléchargeable

### Commande pour vérifier les logs

```bash
kubectl logs deployment/keybuzz-backend -n keybuzz-backend-dev --tail=200 | grep -E 'MimeParser|PH26.5A'
```

---

## 7. Fichiers modifiés

| Fichier | Modification |
|---------|--------------|
| `attachmentParser.service.ts` | Nouvelle fonction `parseMimeEmailManual` avec extraction améliorée |
| `attachmentParser.service.ts` | Ajout `extractMimePartsV2` et `decodePartContentV2` |
| `attachmentParser.service.ts` | Logs debug PH26.5A |

---

## 8. Prochaines étapes

1. **Attendre un nouvel email Amazon avec PJ** pour validation E2E
2. **Vérifier les logs** du parser
3. **Confirmer** que le texte est visible dans l'Inbox
4. Si OK → **PH26.5B** (Backfill historique)

---

**STATUS** : Déployé, en attente de validation E2E avec un message réel
