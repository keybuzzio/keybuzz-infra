# PH26.8 - Inbox Default Filter = "En attente" Report

**Date:** 2026-02-01  
**Version Client:** v0.5.27-pending-default  
**Digest:** `sha256:7e41678c7069d1b124550b460176ec6e2622a670e6573c7197697bd00523ba5f`

---

## 1. RÉSUMÉ

Modification du filtre par défaut de l'Inbox pour afficher "En attente" (pending) au lieu de "Tous", avec persistance localStorage par tenant.

| Fonctionnalité | Status |
|----------------|--------|
| Filtre par défaut = "En attente" | ✅ |
| Respect URL param | ✅ |
| Persistance localStorage | ✅ |
| Multi-tenant | ✅ |
| Pas de hardcode | ✅ |

---

## 2. COMPORTEMENT

### Priorité des filtres

```
1. URL param ?status=xxx     (priorité haute - override tout)
2. localStorage par tenant   (préférence utilisateur)
3. "pending" par défaut      (UX Work Queue)
```

### Flux décisionnel

```
┌─────────────────────────────────────┐
│         Ouverture /inbox            │
└─────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────┐
│   URL contient ?status=xxx ?        │
│   (all, open, pending, resolved)    │
└─────────────────────────────────────┘
         │                    │
        OUI                  NON
         │                    │
         ▼                    ▼
┌─────────────┐    ┌─────────────────────────────┐
│ Utiliser    │    │ localStorage contient       │
│ URL param   │    │ kb_inbox_filter:<tenantId> ?│
└─────────────┘    └─────────────────────────────┘
                           │              │
                          OUI            NON
                           │              │
                           ▼              ▼
                   ┌─────────────┐  ┌─────────────┐
                   │ Utiliser    │  │ Défaut      │
                   │ localStorage│  │ "pending"   │
                   └─────────────┘  └─────────────┘
```

---

## 3. CODE IMPLÉMENTÉ

### Initialisation du filtre (useState)

```typescript
// PH26.8: Default filter = "En attente" (pending) with localStorage persistence
const [statusFilter, setStatusFilter] = useState<string>(() => {
  // Check URL param first (highest priority)
  if (typeof window !== 'undefined') {
    const urlParams = new URLSearchParams(window.location.search);
    const urlStatus = urlParams.get('status');
    if (urlStatus && ['all', 'open', 'pending', 'resolved'].includes(urlStatus)) {
      return urlStatus;
    }
    // Check localStorage for tenant-specific preference
    const tenantId = localStorage.getItem('keybuzz_last_tenant') || 'default';
    const savedFilter = localStorage.getItem(`kb_inbox_filter:${tenantId}`);
    if (savedFilter && ['all', 'open', 'pending', 'resolved'].includes(savedFilter)) {
      return savedFilter;
    }
  }
  // Default to "pending" (En attente) - PH26.8 UX Work Queue
  return "pending";
});
```

### Persistance localStorage

```typescript
// PH26.8: Persist status filter to localStorage when user changes it
useEffect(() => {
  if (typeof window !== 'undefined' && statusFilter) {
    const tenantId = localStorage.getItem('keybuzz_last_tenant') || 'default';
    localStorage.setItem(`kb_inbox_filter:${tenantId}`, statusFilter);
  }
}, [statusFilter]);
```

---

## 4. CLÉS LOCALSTORAGE

| Clé | Format | Exemple |
|-----|--------|---------|
| Préférence filtre | `kb_inbox_filter:<tenantId>` | `kb_inbox_filter:ecomlg` |
| Tenant actuel | `keybuzz_last_tenant` | `ecomlg` |

---

## 5. AVANT / APRÈS

### AVANT (v0.5.26)

```
- Ouverture /inbox → Filtre "Tous" actif
- Utilisateur doit cliquer sur "En attente" manuellement
- Pas de persistance du choix
```

### APRÈS (v0.5.27)

```
- Ouverture /inbox → Filtre "En attente" actif par défaut
- Liste affiche directement les conversations à traiter
- Choix persisté en localStorage par tenant
- URL ?status=xxx toujours respecté
```

---

## 6. VALIDATION E2E

### Test 1: Session fraîche
```
1. Vider localStorage (DevTools > Application > Clear storage)
2. Ouvrir https://client-dev.keybuzz.io/inbox
3. ✅ Vérifier que "En attente" est sélectionné (badge bleu actif)
4. ✅ Vérifier que la liste affiche les conversations "pending"
```

### Test 2: Persistance
```
1. Cliquer sur "Tous"
2. Rafraîchir la page (F5)
3. ✅ Vérifier que "Tous" reste sélectionné (localStorage)
```

### Test 3: URL override
```
1. Naviguer vers /inbox?status=resolved
2. ✅ Vérifier que "Résolues" est sélectionné
3. ✅ Même si localStorage contient autre chose
```

### Test 4: Multi-tenant
```
1. Se connecter avec tenant A
2. Sélectionner filtre "Ouvertes"
3. Se déconnecter
4. Se connecter avec tenant B
5. ✅ Vérifier que le filtre est "En attente" (pas celui de A)
```

---

## 7. DÉPLOIEMENT

```
Image: ghcr.io/keybuzzio/keybuzz-client:v0.5.27-pending-default
Digest: sha256:7e41678c7069d1b124550b460176ec6e2622a670e6573c7197697bd00523ba5f
Namespace: keybuzz-client-dev
Status: ✅ Running
```

---

## 8. FICHIERS MODIFIÉS

| Fichier | Modifications |
|---------|---------------|
| `keybuzz-client/app/inbox/InboxTripane.tsx` | +20 lignes (smart default + persistence) |
| `keybuzz-infra/k8s/keybuzz-client-dev/deployment.yaml` | Image → v0.5.27-pending-default |

---

## 9. NON-RÉGRESSION

- ✅ Filtres existants fonctionnent
- ✅ Pas de hardcode de tenant
- ✅ URL params respectés
- ✅ Multi-tenant via localStorage
- ✅ SSR compatible (check `typeof window`)

---

**Rapport généré automatiquement - PH26.8 Inbox Default Pending**
