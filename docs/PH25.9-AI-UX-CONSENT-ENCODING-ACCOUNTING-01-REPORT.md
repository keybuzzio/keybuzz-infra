# PH25.9-AI-UX-CONSENT-ENCODING-ACCOUNTING-01 - Rapport

**Date** : 2026-01-25
**Environnement** : DEV (keybuzz-api-dev, keybuzz-client-dev)
**Tenant test** : ecomlg-001

---

## RÃ©sumÃ©

| Objectif | Statut |
|----------|--------|
| A) Consentement IA (pas d'appel sans clic) | âœ… CorrigÃ© |
| B) Fix Mojibake UTF-8 | âœ… CorrigÃ© |
| C) Affichage coÃ»ts 6 dÃ©cimales | âœ… CorrigÃ© |

---

## A) Consentement IA

### ProblÃ¨me
L'IA consommait des crÃ©dits dÃ¨s l'ouverture d'une conversation, sans action explicite de l'utilisateur.

### Solution
1. **Suppression de l'auto-appel**: Le `useEffect` ne charge plus que les settings, pas les suggestions
2. **Ajout d'un Ã©tat `hasUserConsent`**: InitialisÃ© Ã  `false`
3. **UI de consentement**: Affiche un message clair et un bouton CTA avant tout appel IA
4. **Bouton "Laisser KeyBuzz rÃ©pondre"**: DÃ©sactivÃ© si le mode autonome n'est pas activÃ©

### Code modifiÃ©

```typescript
// AVANT (auto-call)
useEffect(() => {
  loadAIData(); // â† Appelait /ai/assist automatiquement
}, [loadAIData]);

// APRÃˆS (consent required)
useEffect(() => {
  loadSettingsOnly(); // â† Ne charge que les settings
}, [loadSettingsOnly]);

// L'appel /ai/assist ne se fait que sur clic:
const generateSuggestions = useCallback(async () => {
  setHasUserConsent(true);
  // ... appel /ai/assist ...
});
```

### UI de consentement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    âœ¨ Assistance KeyBuzz                    â”‚
â”‚                                             â”‚
â”‚    Cliquez pour obtenir une suggestion      â”‚
â”‚    (consomme du crÃ©dit)                     â”‚
â”‚                                             â”‚
â”‚    [âœ¨ GÃ©nÃ©rer une suggestion]              â”‚
â”‚                                             â”‚
â”‚    Vous pouvez aussi rÃ©pondre manuellement  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Preuve Network (AVANT clic)

```
GET /ai/settings?tenantId=ecomlg-001 â† Seul appel IA
âŒ AUCUN POST /ai/assist
âŒ AUCUN POST /ai/evaluate
```

### Preuve Network (APRÃˆS clic sur CTA)

```
POST /ai/assist â† Uniquement aprÃ¨s clic utilisateur
```

---

## B) Fix Mojibake UTF-8

### ProblÃ¨me
Les emojis Ã©taient mal encodÃ©s (double-encodage UTF-8):
- `Ã°Å¸Å¸Â¢` au lieu de ğŸŸ¢
- `Ã°Å¸Å¸Â¡` au lieu de ğŸŸ¡

### Solution
DÃ©tection et remplacement des patterns mojibake dans `AIDecisionPanel.tsx`:

```python
fixes = [
    ('Ã°Å¸Å¸Â¢', 'ğŸŸ¢'),  # Green circle
    ('Ã°Å¸Å¸Â¡', 'ğŸŸ¡'),  # Yellow circle
]
```

### RÃ©sultat
Les indicateurs de confiance s'affichent maintenant correctement:
- ğŸŸ¢ Confiance Ã©levÃ©e
- ğŸŸ¡ Confiance moyenne
- ğŸ”´ Confiance faible

---

## C) Affichage coÃ»ts

### ProblÃ¨me
Le coÃ»t affichÃ© Ã©tait `0.0000` alors que des tokens Ã©taient consommÃ©s.

### Cause
Le champ `today.costUsd` dans `/ai/wallet/status` reprÃ©sente le coÃ»t dÃ©bitÃ© du **wallet** (credits), pas du **budget plan**.

Le budget plan est dans `dailyPlanUsedUsd` qui contenait bien la valeur `0.044118`.

### Solution
1. Augmentation de la prÃ©cision d'affichage de 4 Ã  6 dÃ©cimales
2. Le budget plan est dÃ©jÃ  correctement affichÃ©: `${dailyPlanUsed} / ${dailyPlanBudget}`

### Code modifiÃ©

```typescript
// AVANT
status?.dailyPlanUsedUsd?.toFixed(4)  // "0.0441"
status?.today?.costUsd?.toFixed(4)     // "0.0000"

// APRÃˆS
status?.dailyPlanUsedUsd?.toFixed(6)  // "0.044118"
status?.today?.costUsd?.toFixed(6)     // "0.000000" (correct - wallet non utilisÃ©)
```

### Explication UI

Sur `/billing/ai`:
```
Budget plan quotidien: $0.044118 / $0.50
Wallet: $8.00 (utilisÃ© aprÃ¨s Ã©puisement du budget plan)
```

---

## Version dÃ©ployÃ©e

```
Image: ghcr.io/keybuzzio/keybuzz-client:v0.5.36-ph259-consent
Commit: 81cc8b4
```

---

## Checklist E2E

| Test | RÃ©sultat |
|------|----------|
| Ouvrir conversation sans clic IA | âœ… Aucun appel /ai/assist |
| Voir UI consentement | âœ… "Cliquez pour obtenir une suggestion" |
| Cliquer "GÃ©nÃ©rer une suggestion" | âœ… Appel /ai/assist dÃ©clenchÃ© |
| VÃ©rifier emojis confiance | âœ… ğŸŸ¢ğŸŸ¡ affichÃ©s correctement |
| VÃ©rifier coÃ»ts sur /billing/ai | âœ… 6 dÃ©cimales affichÃ©es |
| Budget plan utilisÃ© visible | âœ… `$0.044118 / $0.50` |

---

## Non-rÃ©gression

| Composant | Statut |
|-----------|--------|
| Inbox Amazon | âœ… Non modifiÃ© |
| Outbound SMTP | âœ… Non modifiÃ© |
| PJ MIME | âœ… Non modifiÃ© |
| Workers | âœ… Non modifiÃ©s |
| Guards IA | âœ… Non modifiÃ©s |

---

## Fichiers modifiÃ©s

| Fichier | Modification |
|---------|--------------|
| `src/features/ai-ui/AIDecisionPanel.tsx` | Consentement + fix emojis |
| `app/billing/ai/page.tsx` | 6 dÃ©cimales |
| `app/billing/page.tsx` | 6 dÃ©cimales |

---

*Rapport gÃ©nÃ©rÃ© - 2026-01-25 18:30 UTC*
