# PH30.5 â€” PROD: Fix "Importer cette commande" (paritÃ© DEV)

**Date** : 2026-02-06
**Commit API** : `0c0cfe6` â€” `PH30.5: Add orders import module`
**Image API** : `ghcr.io/keybuzzio/keybuzz-api:ph30.5-order-import-prod`
**Digest** : `sha256:936ff23ec9a767c2b197cfe17c42dc09e8bf1bfb7114594650dcb08860f7066a`
**Client** : Intouchable (GOLDEN `menu-fr-ph28.26-2026-02-03`)

---

## 1. Endpoint exact cÃ´tÃ© client (GOLDEN)

### ChaÃ®ne d'appel

```
Bouton "Importer cette commande" (OrderSidePanel)
  â†’ POST /api/orders/import-one (BFF Next.js)
    â†’ POST ${BACKEND_URL}/api/v1/orders/import-one (Backend Fastify)
      Headers: Content-Type, X-User-Email, X-Tenant-Id
      Body: { tenantId: string, orderRef: string }
```

### Autres endpoints orders appelÃ©s par le client

| BFF Route | Backend Call | MÃ©thode |
|---|---|---|
| `POST /api/orders/import-one` | `POST /api/v1/orders/import-one` | Import order |
| `GET /api/orders?q=<ref>` | `GET /api/v1/orders?q=<ref>` | Search/list |
| `GET /api/orders/<orderId>` | `GET /api/v1/orders/<orderId>` | Detail |

### RÃ©ponse attendue par le client (import)

```json
{
  "orderId": "ord-xxx",
  "externalOrderId": "171-...",
  "status": "Shipped",
  "totalAmount": 29.99,
  "products": [{ "name": "...", "quantity": 1, "price": 29.99 }],
  "customer": { "name": "...", "email": null, "address": "..." },
  "source": "amazon_spapi" | "cache" | "stub"
}
```

---

## 2. Cause racine

**Route `/api/v1/orders/import-one` n'existait pas dans le backend.**
Le BFF (client) appelait le backend, mais aucune route ne rÃ©pondait (404).
La table `orders` n'existait pas non plus dans la base de donnÃ©es.

---

## 3. Fix appliquÃ©

### Nouveau module `src/modules/orders/routes.ts`

| Route | Description |
|---|---|
| `POST /api/v1/orders/import-one` | Import order depuis Amazon SP-API (ou stub si pas de creds) |
| `GET /api/v1/orders` | Liste/recherche orders par tenant |
| `GET /api/v1/orders/:orderId` | DÃ©tail d'une commande |

### FonctionnalitÃ©s

- **SP-API integration** : Utilise les credentials Vault (mÃªme pattern que `spapiMessaging.ts`)
  - Appelle `GET /orders/v0/orders/{orderId}` (header) + `GET /orders/v0/orders/{orderId}/orderItems` (items)
- **Mode stub** : Si pas de creds SP-API, crÃ©e un enregistrement minimal depuis les donnÃ©es conversation
- **Idempotent** : Re-import retourne l'ordre dÃ©jÃ  importÃ© (`source: "cache"`)
- **Table `orders`** : CrÃ©Ã©e en DDL sÃ©parÃ© (DEV + PROD)

### Migration DDL

```sql
CREATE TABLE orders (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  external_order_id TEXT NOT NULL,
  channel TEXT DEFAULT 'amazon',
  status TEXT DEFAULT 'Unshipped',
  total_amount NUMERIC(12,2) DEFAULT 0,
  currency TEXT DEFAULT 'EUR',
  order_date TIMESTAMPTZ,
  fulfillment_channel TEXT DEFAULT 'MFN',
  customer_name TEXT, customer_email TEXT, customer_address TEXT,
  carrier TEXT, tracking_code TEXT, tracking_url TEXT,
  delivery_status TEXT DEFAULT 'pending',
  products JSONB DEFAULT '[]',
  raw_data JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

---

## 4. RÃ©sultats curl â€” AVANT / APRÃˆS

### AVANT (tous 404)

```
DEV:  POST /api/v1/orders/import-one â†’ 404
PROD: POST /api/v1/orders/import-one â†’ 404
```

### APRÃˆS â€” DEV

```
POST /api/v1/orders/import-one â†’ 200 (orderId: ord-mlanrh0t-9kjknx, source: stub)
GET  /api/v1/orders?tenantId=ecomlg-001 â†’ 200 (total: 1)
GET  /api/v1/orders/ord-mlanrh0t-9kjknx â†’ 200
Re-import â†’ 200 (source: cache)
Search ?q=171-4093870 â†’ 200 (found: 1)
```

### APRÃˆS â€” PROD

```
POST /api/v1/orders/import-one â†’ 200 (orderId: ord-mlantdo3-m3jgx5, source: stub)
GET  /api/v1/orders?tenantId=ecomlg-ml5hgxky â†’ 200 (total: 1)
GET  /api/v1/orders/ord-mlantdo3-m3jgx5 â†’ 200
Re-import â†’ 200 (source: cache)
```

### OrderId test : `171-4093870-1757126`

| Env | HTTP | orderId | source |
|-----|------|---------|--------|
| DEV | 200 | ord-mlanrh0t-9kjknx | stub |
| PROD | 200 | ord-mlantdo3-m3jgx5 | stub |

> Note: `source: stub` car aucun credential Amazon SP-API configurÃ© dans Vault pour ces tenants. Quand les creds seront ajoutÃ©s, l'import enrichira automatiquement les donnÃ©es (montant, articles, adresse, tracking).

---

## 5. Rollback

```bash
# Revenir Ã  l'image prÃ©cÃ©dente
kubectl set image deployment/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:ph30.4-status-workflow-prod -n keybuzz-api-prod
# La table orders peut rester (pas de rÃ©gression)
```

---

## 6. RÃ©sumÃ©

| Ã‰lÃ©ment | Valeur |
|---------|--------|
| API DEV tag | `ph30.5-order-import` |
| API PROD tag | `ph30.5-order-import-prod` |
| Digest (identique) | `sha256:936ff23e...` |
| Commit | `0c0cfe6` |
| Table DDL | `orders` (DEV + PROD) |
| Client modifiÃ© | Non |
| Rollback | Image prÃ©cÃ©dente `ph30.4-status-workflow-prod` |