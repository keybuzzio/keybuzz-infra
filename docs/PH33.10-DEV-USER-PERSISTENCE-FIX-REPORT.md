# PH33.10 — User Persistence & Login Lookup Fix — REPORT

**Date** : 2026-02-13  
**Environnement** : DEV uniquement  
**Statut** : DEPLOYE en DEV — En attente validation Ludovic

---

## Problème observé

Après un onboarding `/register` réussi, lorsque l'utilisateur se déconnecte et tente de se reconnecter via `/login` avec `contact@switaa.com`, le système affiche :

> "Aucun compte n'est associé à l'adresse : contact@switaa.com"

Alors que l'utilisateur EXISTE en base de données avec 2 tenants liés.

---

## Diagnostic

### 1. Source de vérité user

| Élément | Résultat |
|---------|----------|
| Table backend | `users` (schema public, UUID id) |
| Colonnes | `id` (uuid), `email` (varchar), `name` (varchar), `created_at` (timestamptz) |
| NextAuth tables | **Aucune** — NextAuth utilise des sessions JWT (pas de table DB) |
| ID canonique | `users.id` (UUID) |
| Mapping email → user | `WHERE lower(email) = lower($1)` |

### 2. Audit DB — contact@switaa.com

```sql
-- User existe
SELECT * FROM users WHERE lower(email) = lower('contact@switaa.com');
-- id: 412ed090-f7da-44b5-8770-2c1545b381c4
-- email: contact@switaa.com
-- name: Ludovic GONTHIER
-- created_at: 2026-02-13T15:24:02.811Z

-- 2 tenants liés
SELECT * FROM user_tenants WHERE user_id = '412ed090...';
-- tenant-1770996266047 (role: owner)
-- tenant-1770999544257 (role: owner)

-- Préférences OK
SELECT * FROM user_preferences WHERE user_id = '412ed090...';
-- current_tenant_id: tenant-1770999544257
```

**Verdict** : L'utilisateur est correctement persisté. Le problème est dans le lookup.

### 3. Audit endpoints

Le login page (`/login`) appelle :
1. `POST /api/auth/check-email` (BFF client) avec `{ email }`
2. Le BFF appelle `GET ${API_URL}/tenant-context/check-user` avec header `X-User-Email`
3. Si `exists: false` → affiche "Aucun compte"

**PROBLEME** : l'endpoint `GET /tenant-context/check-user` **n'existe pas** dans le backend !

```
grep -rn 'check-user' keybuzz-api/src/ → (vide)
```

Le backend retourne **404**. Le BFF interprète le 404 comme `{ exists: false }` :

```typescript
// BFF check-email/route.ts
if (res.status === 400 || res.status === 401 || res.status === 404) {
  return NextResponse.json({ exists: false, hasTenants: false });
}
```

---

## Cause racine

**Catégorie B : endpoint `check-user` manquant sur le backend.**

Le BFF côté client a été créé avec l'attente d'un endpoint backend `/tenant-context/check-user`, mais cet endpoint n'a jamais été implémenté dans l'API. Tous les logins OTP montrent donc "Aucun compte" même si l'utilisateur existe.

---

## Fix appliqué

### Endpoint ajouté : `GET /tenant-context/check-user`

**Fichier** : `keybuzz-api/src/modules/auth/tenant-context-routes.ts`

**Comportement** :
- Lit l'email depuis le header `X-User-Email`
- Query : `SELECT id, email, name FROM users WHERE lower(trim(email)) = lower(trim($1))`
- Si trouvé : vérifie les memberships dans `user_tenants`
- Retourne : `{ exists: true/false, hasTenants: true/false, tenantCount: N, userName: "..." }`

**Caractéristiques** :
- Strictement **read-only** (aucune écriture)
- Case-insensitive + trim sur l'email
- Pas de données sensibles exposées

### Test curl après déploiement

```bash
curl -H "X-User-Email: contact@switaa.com" \
  http://localhost:3001/tenant-context/check-user

# Réponse :
{"exists":true,"hasTenants":true,"tenantCount":2,"userName":"Ludovic GONTHIER"}
```

---

## Tags déployés

| Service | Tag avant | Tag après | Digest après |
|---------|-----------|-----------|--------------|
| **API DEV** | `v3.4.0-ph339-onboarding-data-fix-1` | `v3.4.0-ph3310-user-persist-fix-1` | `sha256:60884ad2fdce85be18ade61b3bc7ba806baa9b24516c9a0b6471b630dcb676ad` |
| **Client DEV** | `v3.4.0-ph339-onboarding-data-fix-1` | *(inchangé)* | — |

---

## Fichier modifié

- `keybuzz-api/src/modules/auth/tenant-context-routes.ts` : ajout endpoint `GET /check-user`

---

## Tests E2E à effectuer

1. Ouvrir navigation privée → `https://client-dev.keybuzz.io/login`
2. Entrer `contact@switaa.com`
3. **Attendu** : le système envoie un code OTP (pas "Aucun compte")
4. Entrer le code OTP
5. **Attendu** : connexion réussie, tenant retrouvé, redirection vers inbox/dashboard

---

## Commits Git

| Repo | Commit | Message |
|------|--------|---------|
| `keybuzz-infra` | (dans ce push) | PH33.10: update API DEV image - check-user endpoint fix |

---

## STOP POINT

**PROD non déployé.** En attente de validation de Ludovic.

Rollback : `kubectl -n keybuzz-api-dev set image deploy/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:v3.4.0-ph339-onboarding-data-fix-1`
