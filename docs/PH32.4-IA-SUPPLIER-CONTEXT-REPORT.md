# PH32.4 — Injection contexte fournisseur dans Aide IA — REPORT

**Date** : 2026-02-11
**Phase** : DEV (validation avant PROD)
**Statut** : COMPLETE — En attente validation PROD

---

## Objectif

Quand l'utilisateur clique "Obtenir une suggestion" sur une conversation liee a un supplier_case, l'IA recoit automatiquement :
- `supplier_case.status`
- `supplier.name`
- `supplier.last_action_at`
- Dernier message fournisseur (supplier_inbound)
- Dernier message envoye au fournisseur (supplier_outbound)

---

## 1. Image API DEV

| Composant | Tag | Digest |
|-----------|-----|--------|
| keybuzz-api | `v3.3.5-ph324-supplier-ia-dev` | `sha256:913f00ea50029c9b5d9498874193feed97822716ae5fa3038c0ad9f5fe15b7a2` |

Pas de modification client necessaire (le contexte fournisseur est injecte cote API dans le prompt systeme).

---

## 2. Extrait prompt AVANT (sans PH32.4)

```
Tu es KeyBuzz, un assistant IA specialise dans le support client e-commerce.
...
=== CONTEXTE COMMANDE (IMPORTANT) ===
Commande 408-2783801-4970714 | Statut: Shipped | ...
...
=== REGLES SPECIFIQUES DU VENDEUR ===
...
=== FIN REGLES VENDEUR ===

Contexte: conversation
Tu dois fournir: ...
```

**Aucune information fournisseur.**

---

## 3. Extrait prompt APRES (avec PH32.4)

```
Tu es KeyBuzz, un assistant IA specialise dans le support client e-commerce.
...
=== CONTEXTE COMMANDE (IMPORTANT) ===
Commande 408-2783801-4970714 | Statut: Shipped | ...
...
=== REGLES SPECIFIQUES DU VENDEUR ===
...
=== FIN REGLES VENDEUR ===

=== CONTEXTE FOURNISSEUR ===
Statut fournisseur: pending_supplier
Fournisseur: Terra Computer France
Derniere action: 11/02/2026 23:19
Dernier message envoye au fournisseur:
"Demande SAV - Retour produit defectueux..."
Dernier message du fournisseur:
"La piece de rechange a ete expediee. Voici le numero de suivi: COLISSIMO 8R12345678901."
=== FIN CONTEXTE FOURNISSEUR ===

Regles fournisseur:
- Tu peux mentionner que le fournisseur a ete contacte si pertinent
- Si le fournisseur a repondu, utilise cette information pour enrichir ta suggestion
- Ne communique JAMAIS d'email technique, d'adresse de reply-to, ou d'identifiant interne du dossier fournisseur au client

Contexte: conversation
Tu dois fournir: ...
```

**Le bloc fournisseur est injecte entre les regles vendeur et les instructions finales.**

---

## 4. Exemple — Conversation avec contexte injecte

### Requete test :
```json
{
  "tenantId": "ecomlg-001",
  "contextType": "conversation",
  "conversationId": "cmmlghdrl51340b3c3ef64dac",
  "payload": {
    "messages": [
      {"role": "customer", "content": "Mon produit est arrive casse. Quand est-ce que le remplacement sera envoye ?"}
    ]
  }
}
```

### Reponse IA :
```
Bonjour,

Je suis desole d'apprendre que votre disque dur externe LC-POWER est arrive endommage.
Je comprends parfaitement votre frustration et nous allons resoudre ce probleme rapidement.

Concernant votre commande 408-2783801-4970714, j'ai contacte notre fournisseur Terra Computer France
et nous avons recu une confirmation de prise en charge de votre dossier.
```

- **`supplierContextUsed: true`**
- L'IA mentionne **naturellement** le fournisseur
- L'IA utilise l'information du dernier message fournisseur

### Conversation SANS supplier_case :
- **`supplierContextUsed: false`**
- Aucun bloc fournisseur dans le prompt
- L'IA repond normalement

---

## 5. Confirmation : aucune modification KBActions

| Test | Source | KBActions debitees | Normal |
|------|--------|-------------------|--------|
| Avec supplier_case | `inbox_contextualized` | 9.9 | Oui (standard pour contexte commande) |
| Sans supplier_case | `inbox_suggestion` | 6.05 | Oui (standard) |

**Le contexte fournisseur est ajoute au prompt systeme sans cout KBActions supplementaire.**

La logique `computeKBActions(kbSource)` n'a PAS ete modifiee. Le `kbSource` reste `inbox_contextualized` quand un contexte commande est present, independamment de la presence ou non du contexte fournisseur.

---

## 6. Logs API DEV

```
[AI Assist] req-mliozvjujjitfc PH32.4 Supplier context: Terra Computer France status=pending_supplier hasInbound=true
```

---

## 7. Ce qui n'a PAS ete modifie

- Routes Amazon / marketplace
- Logique KBActions (aucune nouvelle consommation)
- Journal IA (pas de nouvelle entree)
- Routes existantes (aucun endpoint ajoute/modifie)
- Client/UI (pas de modification necessaire)
- Mail-core-01 (aucun changement)

---

## 8. Donnees injectees / exclues

### Injectees (utiles a l'IA)
- Nom du fournisseur
- Statut du dossier
- Date derniere action
- Contenu message fournisseur (300 chars max)
- Contenu message envoye (300 chars max)

### Exclues (securite)
- `reply_to_address` (email technique)
- `caseId` (UUID interne)
- Email du fournisseur
- Identifiants techniques

---

## 9. Rollback

```bash
# Sur le bastion :
cp /root/keybuzz-api/src/modules/ai/ai-assist-routes.ts.bak.ph324.20260211235649 \
   /root/keybuzz-api/src/modules/ai/ai-assist-routes.ts
```

---

## 10. Prochaine etape

**STOP POINT** — En attente de validation Ludovic pour deploiement PROD.
