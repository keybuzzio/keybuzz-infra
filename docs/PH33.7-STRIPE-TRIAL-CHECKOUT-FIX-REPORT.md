# PH33.7 ‚Äî Stripe Checkout Trial Fix Report

**Date**: 2026-02-13
**Environnement**: DEV uniquement
**Tag client**: `v3.4.0-ph33-stripe-checkout-fix-1`
**Digest**: `sha256` (voir `docker inspect`)
**Git commit**: `f5edcee` (main)

---

## 1. Sympt√¥me rapport√©

"Le bouton 'D√©marrer la p√©riode d'essai' sur Stripe Checkout ne fait rien."

---

## 2. Causes racines identifi√©es

### Cause A ‚Äî BFF strip successUrl/cancelUrl (Bug principal)

**Fichier** : `keybuzz-client/app/api/billing/checkout-session/route.ts`

Le BFF (Backend-for-Frontend) ne forwardait que 4 champs au backend API :

```typescript
// AVANT (bug)
const { tenantId, targetPlan, billingCycle, channelsAddonQty } = body;
body: JSON.stringify({ tenantId, targetPlan, billingCycle, channelsAddonQty }),
// successUrl et cancelUrl √©taient PERDUS
```

**Impact** : Apr√®s checkout Stripe, la `success_url` tombait sur le d√©faut du backend :
- `https://client-dev.keybuzz.io/billing/plan?stripe=success`
- Cette route est prot√©g√©e par AuthGuard ‚Üí redirect `/login` ‚Üí "rien ne se passe"

### Cause B ‚Äî Carte r√©elle en mode test Stripe

**Preuves Stripe** (via API) :
- 3 √ó `setup_intent.setup_failed` (timestamps: 1770991574, 1770991592, 1770991616)
- Session `cs_test_a1bySp2h...` : `status: open`, `payment_status: unpaid`
- **0 subscriptions** cr√©√©es

En mode test Stripe, il faut utiliser les cartes test :
- `4242 4242 4242 4242` (Visa, toujours accept√©e)
- Expiration : n'importe quelle date future
- CVC : n'importe quels 3 chiffres

---

## 3. Fix appliqu√©

### Fichier modifi√© : `keybuzz-client/app/api/billing/checkout-session/route.ts`

```typescript
// APR√àS (fix PH33.7)
const { tenantId, targetPlan, billingCycle, channelsAddonQty, successUrl, cancelUrl } = body;
body: JSON.stringify({ tenantId, targetPlan, billingCycle, channelsAddonQty, successUrl, cancelUrl }),
```

+ Ajout de logs structur√©s pour tra√ßabilit√©.

### Actions compl√©mentaires
- Expiration des 2 sessions Stripe orphelines (`cs_test_a1bySp2h...` et `cs_test_a105L4ou...`)
- Nettoyage Docker (80GB d'images supprim√©es)

---

## 4. Preuves de validation

### A) Checkout session cr√©√©e via BFF (test automatis√©)

```
Session ID: cs_test_a1QcGqaxDuTQfAafYDNizhcY8cdMQwApc37cU8I36bNZl7NwUgfmwwziXu
  status: open
  success_url: https://client-dev.keybuzz.io/register/success?session_id={CHECKOUT_SESSION_ID}  ‚úÖ
  cancel_url: https://client-dev.keybuzz.io/register?step=checkout&plan=pro  ‚úÖ
  mode: subscription  ‚úÖ
  customer: cus_TyK6fpD1j7q9mG
  metadata: {"billing_cycle":"monthly","channels_addon_qty":"0","target_plan":"PRO","tenant_id":"test-ph337-validate"}
```

### B) Logs BFF (client-dev)

```
[billing/checkout-session] tenantId=test-ph337-validate plan=PRO cycle=monthly successUrl=https://client-dev.keybuzz.io/register/success?session_id={CHECKOUT_SESSION_ID}
[billing/checkout-session] Success: url=YES
```

### C) Logs API (backend)

```
[Billing] Checkout session created for test-ph337-validate: cs_test_a1QcGqax...
```

### D) Webhook endpoint v√©rifi√©

```
ID: we_1SmOGjFC0QQLHISRWMpwxKW4
URL: https://api-dev.keybuzz.io/billing/webhook
Status: enabled
Events: checkout.session.completed, customer.subscription.created, customer.subscription.updated, customer.subscription.deleted
```

---

## 5. Configuration Stripe v√©rifi√©e

| √âl√©ment | Status |
|---------|--------|
| `STRIPE_SECRET_KEY` | ‚úÖ Configur√© (sk_test_...) |
| `STRIPE_WEBHOOK_SECRET` | ‚úÖ Configur√© |
| `STRIPE_PRICE_STARTER_MONTHLY` | ‚úÖ price_1SmO9s... |
| `STRIPE_PRICE_PRO_MONTHLY` | ‚úÖ price_1SmO9u... |
| `STRIPE_PRICE_AUTOPILOT_MONTHLY` | ‚úÖ price_1SmO9v... |
| Billing tables (DB) | ‚úÖ billing_subscriptions, billing_customers, billing_events |
| APP_BASE_URL | ‚úÖ https://client-dev.keybuzz.io |
| Trial 14 jours (subscription_data) | ‚úÖ trial_period_days: 14 |

---

## 6. Test E2E √† effectuer par Ludovic

### Proc√©dure

1. Ouvrir en navigation priv√©e : `https://client-dev.keybuzz.io/register?plan=pro`
2. S'authentifier (Google ou Email OTP)
3. Remplir infos entreprise + user
4. Cliquer "Suivant" ‚Üí la page affiche "Redirection vers le paiement..."
5. Sur la page Stripe Checkout :
   - **Carte** : `4242 4242 4242 4242`
   - **Exp** : `12/30` (ou toute date future)
   - **CVC** : `424`
   - Cliquer "D√©marrer la p√©riode d'essai"
6. V√©rifier redirection vers `/register/success`
7. V√©rifier dans l'app :
   - Plan affich√© dans Facturation
   - Canaux ‚Üí Amazon visible

### V√©rifications attendues apr√®s checkout
- `checkout.session.completed` dans billing_events
- `billing_subscriptions` : status=trialing, trial_end pr√©sent
- `billing_customers` : stripe_customer_id rempli

---

## 7. D√©ploiement

- **Image** : `ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-stripe-checkout-fix-1`
- **Namespace** : `keybuzz-client-dev`
- **Pod** : `keybuzz-client-55d95fb8f-n5vnc` (Running)

---

## 8. Rollback

```bash
# Tag pr√©c√©dent
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-register-public-dev-fix-1

# Golden freeze
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:golden-freeze-ph327d-validated
```

---

## 9. STOP POINT

üõë **PROD non d√©ploy√©. En attente de [PROD-APPROVED] de Ludovic.**

Cartes test Stripe √† utiliser en DEV :
- `4242 4242 4242 4242` ‚Äî Visa (toujours OK)
- `4000 0025 0000 3155` ‚Äî Requires 3D Secure authentication
- `4000 0000 0000 9995` ‚Äî D√©clin√©e (pour tester l'erreur)
