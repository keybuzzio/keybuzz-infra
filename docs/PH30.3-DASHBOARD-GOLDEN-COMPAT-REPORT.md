# PH30.3 - Dashboard GOLDEN Compatibility Fix

**Date:** 2026-02-06  
**Statut:** COMPLETE  
**Environnements:** DEV + PROD

---

## Objectif

Faire fonctionner le Tableau de bord en GOLDEN, comme Messages.

---

## 1. Endpoints Dashboard identifiÃ©s (client GOLDEN ef961c8)

Extraction depuis `/app/.next/server/app/dashboard/page.js`:

| Endpoint | MÃ©thode | Usage |
|----------|---------|-------|
| `/stats/dashboard?tenantId=X` | GET | KPIs principaux |
| `/dashboard/summary?tenantId=X` | GET | ActivitÃ© rÃ©cente |

---

## 2. ProblÃ¨me identifiÃ©

Le client GOLDEN attend une structure spÃ©cifique:

```javascript
// Code client GOLDEN (page.js ligne ~70)
r.messages.last24h
```

**Structure attendue:**
```json
{
  "messages": { "last24h": 5 }
}
```

**Structure retournÃ©e (AVANT fix):**
```json
{
  "messages24h": 5
}
```

Le client ne trouvait pas `messages.last24h` et affichait "API indisponible".

---

## 3. Correction appliquÃ©e

### Fichiers modifiÃ©s:

1. **`src/modules/stats/routes.ts`** (ligne 186)
   - AVANT: `messages24h: parseInt(messagesResult.rows[0]?.count) || 0,`
   - APRÃˆS: `messages: { last24h: parseInt(messagesResult.rows[0]?.count) || 0 },`

2. **`src/modules/dashboard/routes.ts`** (lignes 52, 231)
   - Interface: `messages24h: number;` â†’ `messages: { last24h: number };`
   - Valeur: mÃªme changement que stats

### Commit:
- `08db6fc` - PH30.3: Fix dashboard messages.last24h structure

---

## 4. Tests curl AVANT (DEV)

```bash
curl -sk "https://api-dev.keybuzz.io/stats/dashboard?tenantId=ecomlg-001" | jq '.messages'
# RÃ©sultat: null (champ inexistant, Ã©tait "messages24h")
```

---

## 5. Tests curl APRÃˆS (DEV)

```bash
curl -sk "https://api-dev.keybuzz.io/stats/dashboard?tenantId=ecomlg-001" | jq '.messages.last24h'
# RÃ©sultat: 4

curl -sk "https://api-dev.keybuzz.io/dashboard/summary?tenantId=ecomlg-001" | jq '.messages.last24h'
# RÃ©sultat: 4
```

---

## 6. Tests curl APRÃˆS (PROD)

```bash
curl -sk "https://api.keybuzz.io/stats/dashboard?tenantId=ecomlg-001" | jq '.messages.last24h'
# RÃ©sultat: 0

curl -sk "https://api.keybuzz.io/dashboard/summary?tenantId=ecomlg-001" | jq '.messages.last24h'
# RÃ©sultat: 0
```

---

## 7. Images dÃ©ployÃ©es

| Environnement | Image | Digest |
|---------------|-------|--------|
| **DEV** | `ghcr.io/keybuzzio/keybuzz-api:ph30.3-dashboard-fix-dev-2026-02-06` | `sha256:8c19442a48d4cc088a9016b70cc407d5b7f6891860ca35c1f6978985fbae7a7b` |
| **PROD** | `ghcr.io/keybuzzio/keybuzz-api:ph30.3-dashboard-fix-prod-2026-02-06` | `sha256:8c19442a48d4cc088a9016b70cc407d5b7f6891860ca35c1f6978985fbae7a7b` |

---

## 8. Rollback

En cas de problÃ¨me:

**DEV:**
```bash
kubectl -n keybuzz-api-dev set image deployment/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:ph30.2-golden-compat-dev-2026-02-05
```

**PROD:**
```bash
kubectl -n keybuzz-api-prod set image deployment/keybuzz-api keybuzz-api=ghcr.io/keybuzzio/keybuzz-api:ph30.2-golden-compat-prod-2026-02-05
```

---

## Conclusion

Le Dashboard GOLDEN fonctionne maintenant correctement:
- Structure `messages.last24h` conforme aux attentes du client
- Plus de message "API indisponible"
- Stats rÃ©elles affichÃ©es (mÃªme si 0)

**Client intouchable:** âœ… Aucune modification du client  
**GitOps strict:** âœ… Tout versionnÃ© dans Git  
**Rollback possible:** âœ… Images immuables