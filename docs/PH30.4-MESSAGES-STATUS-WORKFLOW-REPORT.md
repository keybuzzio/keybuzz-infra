# PH30.4 â€” Workflow Statuts Messages (pending/open/resolved) + Labels FR

**Date** : 2026-02-06
**Commit API** : `cc2698e` â€” `PH30.4: Workflow statuts messages (pending/open/resolved)`
**Image API** : `ghcr.io/keybuzzio/keybuzz-api:ph30.4-status-workflow-prod`
**Digest** : `sha256:2c076ce34b999f682d6885d4cbc85265ae5801d2ac33e14e9438e69bd668a803`
**Client** : Intouchable (GOLDEN `menu-fr-ph28.26-2026-02-03`)

---

## 1. Transitions Backend

### A) Inbound (email + Amazon)

| Fichier | Modification | Effet |
|---------|-------------|-------|
| `src/modules/inbound/routes.ts:98` | `status` = `'pending'` (was `'open'`) | Nouvelle conversation email â†’ **pending** |
| `src/modules/inbound/routes.ts:139` | Ajout `status = 'pending'` dans UPDATE | Inbound sur conversation existante (email) â†’ **pending** |
| `src/modules/inbound/routes.ts:353` | `status` = `'pending'` (was `'open'`) | Nouvelle conversation Amazon â†’ **pending** |
| `src/modules/inbound/routes.ts:394` | Ajout `status = 'pending'` dans UPDATE | Inbound sur conversation existante (Amazon) â†’ **pending** |

### B) Outbound (Reply agent)

| Fichier | Modification | Effet |
|---------|-------------|-------|
| `src/modules/messages/routes.ts:336` | `SET status = 'open'` quand `direction = 'outbound'` | Reply agent â†’ **open** |

### C) RÃ©sumÃ© des transitions

```
Nouveau message client â†’ pending ("En attente")
Agent rÃ©pond           â†’ open    ("Ouvert")
Client rÃ©Ã©crit         â†’ pending ("En attente")
Agent rÃ©sout           â†’ resolved ("RÃ©solu") [inchangÃ©]
```

---

## 2. Labels FR (Client GOLDEN)

Le client GOLDEN utilise dÃ©jÃ  les labels corrects :
- **"En attente"** = `pending` (10 occurrences trouvÃ©es dans le code compilÃ©)
- **"Ouvert"** = `open` (2 occurrences)
- **"RÃ©solu"** = `resolved`

Client intouchable â€” aucune modification nÃ©cessaire.

---

## 3. Tests E2E DEV (tenant `ecomlg-001`)

### Test 1 : Nouveau inbound â†’ pending
```
POST /inbound/email â†’ {"ok":true,"conversationId":"conv-c1dce8b9","created":true}
DB: conv-c1dce8b9 | pending | email âœ…
```

### Test 2 : Reply agent â†’ open
```
POST /messages/conversations/conv-c1dce8b9/reply â†’ {"success":true}
DB: conv-c1dce8b9 | open âœ…
```

### Test 3 : Re-inbound client â†’ pending
```
POST /inbound/email (mÃªme from/subject) â†’ {"ok":true,"conversationId":"conv-c1dce8b9","created":false}
DB: conv-c1dce8b9 | pending âœ…
```

### Test 4 : Filtres status
```
GET /messages/conversations?tenantId=ecomlg-001&status=pending  â†’ Count: 1 âœ…
GET /messages/conversations?tenantId=ecomlg-001&status=open     â†’ Count: 50 âœ…
GET /messages/conversations?tenantId=ecomlg-001&status=resolved â†’ Count: 1 âœ…
```

### Test 5 : Non-rÃ©gression Amazon
```
Amazon open:     66 conversations (inchangÃ©) âœ…
Amazon resolved: 1 conversation (inchangÃ©) âœ…
Email open:      1 âœ…
Email pending:   1 (test E2E) âœ…
```

---

## 4. Validation PROD

### Endpoints (tous 200)
```
200 /health
200 /messages/conversations?tenantId=ecomlg-ml5hgxky
200 /messages/conversations?tenantId=ecomlg-ml5hgxky&status=pending
200 /messages/conversations?tenantId=ecomlg-ml5hgxky&status=open
200 /stats/dashboard?tenantId=ecomlg-ml5hgxky
200 /dashboard/summary?tenantId=ecomlg-ml5hgxky
```

### DÃ©ploiement
- **DEV** : `ghcr.io/keybuzzio/keybuzz-api:ph30.4-status-workflow` â€” âœ… rollout success
- **PROD** : `ghcr.io/keybuzzio/keybuzz-api:ph30.4-status-workflow-prod` â€” âœ… rollout success
- MÃªme digest (`sha256:2c076ce3...`) = image immuable identique

---

## 5. Backward Compatibility

- Les conversations existantes conservent leur statut actuel (`open`, `resolved`)
- Seuls les **nouveaux** inbound passent en `pending`
- Aucune migration destructive
- Aucune modification du client