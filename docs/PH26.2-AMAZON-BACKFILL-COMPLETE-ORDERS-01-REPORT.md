# PH26.2-AMAZON-BACKFILL-COMPLETE-ORDERS-01 - Amazon Orders Complete Backfill

**Date**: 2026-01-29
**Statut**: EN COURS (Code pret, deploiement a faire)

---

## Objectif

Implementer un backfill Amazon Orders complet (12-24 mois) pour que KeyBuzz devienne la source de verite centrale pour les commandes, permettant :
- IA fiable (retours, litiges, comportements clients)
- Consultation complete des commandes
- Analyse multi-commandes / multi-annees

---

## Architecture

### Schema du Backfill

```
┌────────────────────────────────────────────────────────────────┐
│                     CronJob (*/10 * * * *)                     │
│            POST /api/v1/orders/backfill/run/global             │
└───────────────────────────────┬────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│                   runGlobalBackfill()                          │
│  1. SELECT tenants avec backfill PENDING/RUNNING/ERROR         │
│  2. Pour chaque tenant: runBackfill(tenantId)                  │
│  3. Pagination SP-API avec NextToken                           │
│  4. Chunking par tranches de 30 jours                          │
└───────────────────────────────┬────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
   ┌──────────┐           ┌──────────┐           ┌──────────┐
   │ Chunk 1  │           │ Chunk 2  │           │ Chunk N  │
   │ Jan-Fev  │    →      │ Mar-Avr  │    →      │ Dec-Jan  │
   │ 2024     │           │ 2024     │           │ 2026     │
   └──────────┘           └──────────┘           └──────────┘
        │                       │                       │
        └───────────────────────┴───────────────────────┘
                                │
                                ▼
                    ┌─────────────────────┐
                    │   UPSERT Orders     │
                    │   (idempotent)      │
                    └─────────────────────┘
```

### Caracteristiques

| Feature | Implementation |
|---------|----------------|
| **Periode** | 24 mois glissants (configurable) |
| **Chunking** | 30 jours par chunk |
| **Pagination** | SP-API NextToken |
| **Reprise** | Automatique apres crash/erreur |
| **Idempotence** | UPSERT par (tenantId, marketplace, externalOrderId) |
| **Rate Limit** | 500ms entre appels, backoff exponentiel |
| **Max par run** | 500 commandes (limite soft) |
| **Retry** | 3 tentatives avec backoff |

---

## Fichiers Crees

### Backend (keybuzz-api)

| Fichier | Description |
|---------|-------------|
| `migrations/030_amazon_orders_backfill_state.sql` | Table de suivi du backfill |
| `src/modules/marketplaces/amazon/amazonOrdersBackfill.service.ts` | Service principal de backfill |
| `src/modules/marketplaces/amazon/amazonOrdersBackfill.routes.ts` | Routes API backfill |

### Infrastructure (keybuzz-infra)

| Fichier | Description |
|---------|-------------|
| `k8s/keybuzz-backend-dev/cronjob-orders-backfill.yaml` | CronJob pour backfill automatique |

### Frontend (keybuzz-client)

| Fichier | Description |
|---------|-------------|
| `src/services/amazonBackfill.service.ts` | Service client backfill |
| `src/features/orders/components/BackfillIndicator.tsx` | Composant indicateur UX |

### Scripts

| Fichier | Description |
|---------|-------------|
| `scripts/deploy-ph26.2-amazon-backfill.sh` | Script de deploiement |

---

## Schema Database

### Table: amazon_orders_backfill_state

```sql
CREATE TABLE amazon_orders_backfill_state (
    id TEXT PRIMARY KEY,
    tenantId TEXT NOT NULL,
    marketplace TEXT NOT NULL DEFAULT 'AMAZON',
    
    -- Periode
    backfillStartDate TIMESTAMP(3) NOT NULL,
    backfillEndDate TIMESTAMP(3) NOT NULL,
    
    -- Curseur
    currentChunkStart TIMESTAMP(3),
    currentChunkEnd TIMESTAMP(3),
    lastSyncedOrderDate TIMESTAMP(3),
    nextToken TEXT,
    
    -- Statut
    status BackfillStatus NOT NULL DEFAULT 'PENDING',
    progressPercent INTEGER NOT NULL DEFAULT 0,
    totalOrdersEstimated INTEGER DEFAULT 0,
    totalOrdersSynced INTEGER NOT NULL DEFAULT 0,
    
    -- Configuration
    chunkSizeDays INTEGER NOT NULL DEFAULT 30,
    maxMonths INTEGER NOT NULL DEFAULT 24,
    
    -- Erreurs
    lastError TEXT,
    errorCount INTEGER NOT NULL DEFAULT 0,
    retryAfter TIMESTAMP(3),
    
    -- Timestamps
    startedAt TIMESTAMP(3),
    completedAt TIMESTAMP(3),
    lastRunAt TIMESTAMP(3),
    createdAt TIMESTAMP(3) DEFAULT NOW(),
    updatedAt TIMESTAMP(3) DEFAULT NOW(),
    
    UNIQUE(tenantId, marketplace)
);
```

### Enum: BackfillStatus

```sql
CREATE TYPE BackfillStatus AS ENUM (
    'PENDING',   -- En attente
    'RUNNING',   -- En cours
    'PAUSED',    -- Pause (reprise possible)
    'DONE',      -- Termine
    'ERROR'      -- Erreur (retry automatique)
);
```

---

## API Endpoints

### GET /api/v1/orders/backfill/status

Retourne le statut du backfill pour le tenant.

**Response:**
```json
{
  "status": "RUNNING",
  "progress": 62,
  "ordersSynced": 842,
  "estimatedTotal": 1350,
  "from": "2024-01-01",
  "to": "2026-01-29",
  "currentChunk": {
    "start": "2024-10-01",
    "end": "2024-10-31"
  },
  "lastUpdate": "2026-01-29T10:42:00Z",
  "isBackfillComplete": false
}
```

### POST /api/v1/orders/backfill/start

Demarre le backfill pour un tenant.

**Body (optional):**
```json
{
  "maxMonths": 24,
  "chunkSizeDays": 30
}
```

### POST /api/v1/orders/backfill/run

Execute manuellement le backfill pour le tenant.

### POST /api/v1/orders/backfill/run/global

Execute le backfill pour tous les tenants en attente (CronJob).

---

## CronJobs

| CronJob | Schedule | Description |
|---------|----------|-------------|
| `amazon-orders-sync` | `*/5 * * * *` | Delta sync (commandes recentes) |
| `amazon-orders-backfill` | `3,13,23,33,43,53 * * * *` | Backfill historique |

Les deux CronJobs sont decales pour eviter les conflits.

---

## UX Frontend

### Composant BackfillIndicator

Trois variants disponibles:

1. **Banner** (recommande pour Dashboard/Orders)
   - Affiche le progress bar
   - Message explicatif
   - Tooltip informatif

2. **Badge** (pour headers/listes)
   - Compact
   - Spinner + pourcentage

3. **Compact** (minimal)
   - Uniquement pendant le backfill
   - Discret

### Integration

```tsx
import { BackfillIndicator } from '@/features/orders/components/BackfillIndicator';

// Dans Dashboard ou Orders
<BackfillIndicator 
  tenantId={currentTenant.id} 
  variant="banner" 
/>
```

---

## Limitations SP-API

| Limite | Valeur |
|--------|--------|
| Rate limit Orders API | 1 request/second |
| Max results par page | 100 |
| Periode max (CreatedAfter) | Aucune limite documentee |
| Burst quota | ~25 requests |

---

## Estimation Volumetrie

| Tenant | Commandes estimees (24 mois) | Temps estime |
|--------|------------------------------|--------------|
| Petit vendeur (10 cmd/mois) | ~240 | < 5 min |
| Moyen vendeur (100 cmd/mois) | ~2,400 | ~30 min |
| Gros vendeur (1000 cmd/mois) | ~24,000 | ~4-5h |

Le backfill s'execute en background et n'impacte pas l'UX.

---

## Deploiement

### Etapes

1. **Executer le script de deploiement:**
   ```bash
   bash scripts/deploy-ph26.2-amazon-backfill.sh
   ```

2. **Mettre a jour keybuzz-backend:**
   - Ajouter les routes backfill
   - Builder et pusher l'image
   - Mettre a jour le deployment K8s

3. **Tester:**
   ```bash
   # Demarrer le backfill
   curl -X POST -H "X-Tenant-Id: ecomlg-001" \
     https://backend-dev.keybuzz.io/api/v1/orders/backfill/start
   
   # Verifier le statut
   curl -H "X-Tenant-Id: ecomlg-001" \
     https://backend-dev.keybuzz.io/api/v1/orders/backfill/status
   ```

4. **Integrer le frontend:**
   - Ajouter BackfillIndicator dans Dashboard
   - Ajouter BackfillIndicator dans Orders

---

## Prochaines Etapes

| Phase | Description | Statut |
|-------|-------------|--------|
| PH26.2 | Amazon Orders Backfill | EN COURS |
| PH26.3 | Octopia Orders Backfill | A FAIRE |
| PH26.4 | Alignement Dashboard/Inbox | A FAIRE |
| PH26.5 | Orders comme socle IA global | A FAIRE |

---

## Criteres de Validation

- [ ] Tenant avec > 1 an d'activite: toutes commandes visibles
- [ ] Inbox / Dashboard / Orders coherents
- [ ] Redemarrage serveur → reprise backfill
- [ ] Aucune duplication de commandes
- [ ] UX comprehensible sans explication

---

## Notes Techniques

### Idempotence

Le backfill est 100% idempotent:
- UPSERT par `(tenantId, marketplace, externalOrderId)`
- Relancer ne cree jamais de doublons
- Le curseur est sauvegarde a chaque run

### Reprise apres crash

Si le pod crashe pendant le backfill:
1. Le statut reste `RUNNING`
2. Au prochain run CronJob, le backfill reprend au dernier chunk
3. NextToken est preserve si pagination en cours

### Rate Limiting

- 500ms entre chaque appel SP-API
- Backoff exponentiel sur 429 (2s → 4s → 8s)
- Max 500 commandes par run CronJob (soft limit)

---

## Conclusion

L'architecture de backfill est prete. Une fois deploye et le backend mis a jour, KeyBuzz pourra synchroniser l'historique complet des commandes Amazon (jusqu'a 24 mois) de maniere automatique, robuste et non-bloquante pour l'UX.
