# PH25.8-AI-DEGRADED+ENCODING-FIX-01 + PH24.7-DASHBOARD-API-UNAVAILABLE-FIX-01

**Date** : 2026-01-25
**Environnement** : DEV (keybuzz-api-dev, keybuzz-client-dev)
**Tenant test** : ecomlg-001

---

## Résumé

| Correctif | Statut |
|-----------|--------|
| A) PH25.8 - UTF-8 "Mode dégradé" | ✅ Corrigé |
| B) PH24.7 - Dashboard "API indisponible" | ✅ Corrigé |

---

## A) PH25.8 — Fix Mojibake "Mode dégradé" (UTF-8)

### Diagnostic

1. **Source des strings**
   - Les strings "Mode dégradé", "Réponse personnalisée", etc. sont définies dans `keybuzz-api/src/modules/ai/ai-assist-routes.ts`
   - Encodage vérifié: UTF-8 correct (`c3a9` pour "é")

2. **Headers de réponse API**
   ```
   HTTP/2 200
   content-type: application/json; charset=utf-8
   ```

3. **Strings dans le Dashboard (SLA)**
   - Les strings étaient sans accents dans l'API Dashboard:
     - `SLA depasse:` → devrait être `SLA dépassé :`
     - `SLA a risque:` → devrait être `SLA à risque :`
     - `Resolu:` → devrait être `Résolu :`

### Correction

**Fichier modifié**: `keybuzz-api/src/modules/dashboard/routes.ts`

```typescript
// AVANT
message = `SLA depasse: ${row.subject}`;
message = `SLA a risque: ${row.subject}`;
message = `Resolu: ${row.subject}`;

// APRÈS
message = `SLA dépassé : ${row.subject}`;
message = `SLA à risque : ${row.subject}`;
message = `Résolu : ${row.subject}`;
```

**Commit**: `20b4b2d` - fix(PH25.8): fix SLA strings with proper French accents

### Vérification

**Dashboard - Activité récente (APRÈS correction)**:
```
- "SLA dépassé : =?UTF-8?Q?Vous_avez_des_messages..."
- "SLA dépassé : Demande de renseignements concernant la politique..."
- "SLA dépassé : Article endommagé..."
```

✅ Les accents s'affichent correctement

---

## B) PH24.7 — Dashboard "API indisponible" alors que Inbox OK

### Diagnostic

1. **Symptôme**
   - Dashboard affiche "API indisponible" + badge "Données démo"
   - Inbox affiche "Données API" correctement

2. **Cause identifiée (Network trace)**
   - Dashboard appelait `https://api.keybuzz.io/dashboard/summary?tenantId=ecomlg-001` (PROD)
   - Au lieu de `https://api-dev.keybuzz.io/dashboard/summary?tenantId=ecomlg-001` (DEV)

3. **Raison technique**
   - `process.env.NEXT_PUBLIC_API_URL` est résolu au **build time** (pas au runtime)
   - L'image client est buildée avec `NEXT_PUBLIC_API_URL=https://api.keybuzz.io`
   - Donc le client DEV appelait l'API PROD

### Correction

**Fichier modifié**: `keybuzz-client/src/features/dashboard/api/dashboard.service.ts`

```typescript
// AVANT
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'https://api-dev.keybuzz.io';

// APRÈS
function getApiBase(): string {
  if (typeof window !== 'undefined') {
    const hostname = window.location.hostname;
    if (hostname.includes('-dev.') || hostname.includes('localhost') || hostname.includes('127.0.0.1')) {
      return 'https://api-dev.keybuzz.io';
    }
  }
  return process.env.NEXT_PUBLIC_API_URL || 'https://api.keybuzz.io';
}

const API_BASE = getApiBase();
```

**Commit**: `283544f` - fix(PH24.7): dashboard uses runtime hostname detection for API URL

### Vérification

**Network trace AVANT**:
```
[GET] https://api.keybuzz.io/dashboard/summary?tenantId=ecomlg-001 ← ERREUR (PROD)
```

**Network trace APRÈS**:
```
[GET] https://api-dev.keybuzz.io/dashboard/summary?tenantId=ecomlg-001 ← OK (DEV)
```

**Dashboard APRÈS**:
- Badge: **"Données API"** (au lieu de "Données démo")
- Conversations ouvertes: **44** (données réelles)
- SLA dépassés: **42** (données réelles)
- Amazon: **44 (98%)** (données réelles)

✅ Dashboard utilise maintenant les données API réelles

---

## Versions déployées

### API
```
Image: ghcr.io/keybuzzio/keybuzz-api:v0.9.20-ph258-sla
Commit: 20b4b2d
```

### Client
```
Image: ghcr.io/keybuzzio/keybuzz-client:v0.5.33-ph247-dashboard
Commit: 283544f
```

---

## Captures / Preuves

### A) UTF-8 - Dashboard avec accents corrects

```
Activité récente:
- "SLA dépassé : Demande de renseignements concernant la politique de retours..."
- "SLA dépassé : Demande de renseignements concernant la livraison..."
- "SLA dépassé : Demande de renseignements concernant une commande..."
```

### B) Dashboard - Données API

```
Badge: "Données API"
Conversations ouvertes: 44
En attente: 0
SLA à risque: 0
SLA dépassés: 42
Messages 24h: 6
Résolues: 1
```

**Network trace confirmant l'appel DEV**:
```
[GET] https://api-dev.keybuzz.io/dashboard/summary?tenantId=ecomlg-001 → 200 OK
```

---

## Non-régression

| Composant | Statut |
|-----------|--------|
| Inbox Amazon | ✅ Non modifié |
| Outbound SMTP | ✅ Non modifié |
| PJ MIME | ✅ Non modifié |
| Workers | ✅ Non modifiés |
| MinIO | ✅ Non modifié |

---

## Commits

1. **Client** (`keybuzz-client`):
   - `283544f` - fix(PH24.7): dashboard uses runtime hostname detection for API URL (api-dev vs api)

2. **API** (`keybuzz-api`):
   - `20b4b2d` - fix(PH25.8): fix SLA strings with proper French accents (dépassé, à risque, Résolu)

---

*Rapport généré - 2026-01-25 12:45 UTC*
