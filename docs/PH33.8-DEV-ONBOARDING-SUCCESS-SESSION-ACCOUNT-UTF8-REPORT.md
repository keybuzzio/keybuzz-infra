# PH33.8 â€” Onboarding Success Session + Account + UTF-8 Fix Report

**Date**: 2026-02-13
**Environnement**: DEV uniquement
**Tag client**: `v3.4.0-ph33-session-bootstrap-fix-1`
**Digest**: `sha256:0bacbece57965eac8d81272cd27a027245ad0354f4079933ed0ae6784625f1d9`
**Git commit**: `284d094` (main)

---

## 1. Causes racines identifiÃ©es

### Bug A â€” OTP ne crÃ©e pas de session NextAuth (CRITIQUE)

**Fichier** : `app/register/page.tsx` â†’ `handleVerifyCode`

Le flow OTP du register utilisait un endpoint custom (`/api/auth/magic/verify`) qui vÃ©rifie le code mais **ne crÃ©e aucune session NextAuth**. Il retourne juste `{ success: true }`.

```
Parcours OTP (AVANT):
  Email â†’ magic/start â†’ OTP envoyÃ©
  Code â†’ magic/verify â†’ { success: true } â† PAS DE SESSION
  â†’ company â†’ user â†’ create-signup â†’ Stripe
  â†’ retour /register/success â†’ AUCUNE SESSION â†’ redirect /login
```

**Fix** : RemplacÃ© `fetch('/api/auth/magic/verify')` par `signIn('email-otp', { email, code, redirect: false })` qui :
1. Appelle le CredentialsProvider NextAuth `email-otp`
2. Ce provider utilise le mÃªme `verifyOTP()` (in-memory store partagÃ©)
3. CrÃ©e un JWT session cookie (`__Secure-next-auth.session-token`)
4. Le cookie persiste Ã  travers le redirect Stripe (httpOnly, sameSite: lax)

### Bug B â€” Cookie `currentTenantId` absent aprÃ¨s tenant creation

**Fichier** : `app/register/page.tsx` â†’ `handleUserSubmit`

AprÃ¨s `create-signup`, le tenant est crÃ©Ã© en DB mais le cookie `currentTenantId` n'est pas positionnÃ©. Sans ce cookie, l'endpoint `GET /api/auth/me` retourne `tenantId: ''`, et AuthGuard redirige vers `/select-tenant`.

**Fix** : Ajout de `document.cookie = 'currentTenantId=...'` aprÃ¨s la crÃ©ation du tenant, avant le redirect Stripe.

### Bug C â€” /register/success ne bootstrap pas le tenant

**Fichier** : `app/register/success/page.tsx`

La page success Ã©tait statique (juste des `<Link>`). AprÃ¨s retour de Stripe, si le cookie `currentTenantId` est absent, cliquer "Configurer Amazon" â†’ AuthGuard â†’ redirect `/select-tenant`.

**Fix** : Nouvelle version de la success page :
1. Utilise `useSession()` pour vÃ©rifier NextAuth
2. Si session existe, vÃ©rifie le cookie `currentTenantId`
3. Si cookie absent, appelle `/api/auth/me` puis `/api/auth/tenants` pour rÃ©cupÃ©rer le tenant
4. Si aucune session â†’ affiche un bouton "Se connecter pour continuer" (pas de redirect auto)
5. Pas de sidebar (layout public)

### Bug D â€” UTF-8 Mojibake sur la page login

**Fichier** : `app/login/page.tsx`, ligne 207

```
AVANT: Aucun compte n&apos;est associÃƒÂ© Ãƒ  l&apos;adresse :
APRÃˆS: Aucun compte n'est associÃ© Ã  l'adresse :
```

Les caractÃ¨res `Ã©` et `Ã ` Ã©taient encodÃ©s en UTF-8 mais interprÃ©tÃ©s comme Latin-1 lors d'une Ã©dition prÃ©cÃ©dente.

---

## 2. Fichiers modifiÃ©s

| Fichier | Changement |
|---------|------------|
| `app/register/page.tsx` | OTP â†’ `signIn('email-otp')` + cookie `currentTenantId` |
| `app/register/success/page.tsx` | Session bootstrap + tenant context + fallback login button |
| `app/login/page.tsx` | Fix UTF-8 `associÃ© Ã ` |

---

## 3. Cleanup effectuÃ©

| Ã‰lÃ©ment | Avant | AprÃ¨s |
|---------|-------|-------|
| Users `contact@switaa.com` | 1 | 0 |
| Tenants SWITAA | 2 | 0 |
| user_tenants | 2 | 0 |
| Test tenants (diag/validate) | 2 | 0 |

---

## 4. Flow corrigÃ© (E2E attendu)

```
1. /register?plan=pro
2. Email â†’ magic/start (OTP envoyÃ©)
3. Code â†’ signIn('email-otp') â†’ SESSION NEXTAUTH CRÃ‰Ã‰E âœ…
4. Company info â†’ User info
5. create-signup â†’ tenant crÃ©Ã© â†’ COOKIE currentTenantId SET âœ…
6. Stripe Checkout â†’ paiement test (4242...)
7. /register/success â†’ BOOTSTRAP TENANT âœ…
   - Session dÃ©tectÃ©e via useSession()
   - Cookie currentTenantId vÃ©rifiÃ©/restaurÃ©
   - Boutons "Configurer Amazon" / "Dashboard" actifs
8. Click "Configurer Amazon" â†’ /channels â† PAS DE REDIRECT /login âœ…
```

---

## 5. Test E2E Ã  effectuer

### ProcÃ©dure

1. **Navigation privÃ©e** â†’ `https://client-dev.keybuzz.io/register?plan=pro`
2. Entrer email `contact@switaa.com` â†’ recevoir code OTP (affichÃ© en DEV)
3. Entrer le code â†’ vÃ©rifier que la page passe Ã  "Votre entreprise" (session crÃ©Ã©e)
4. Remplir infos entreprise + user
5. Cliquer "CrÃ©er et passer au paiement"
6. Sur Stripe : carte `4242 4242 4242 4242` / exp `12/30` / CVC `424`
7. Cliquer "DÃ©marrer la pÃ©riode d'essai"
8. VÃ©rifier :
   - Redirection vers `/register/success` âœ…
   - Boutons "Configurer Amazon" et "Aller au dashboard" visibles âœ…
   - Clic "Configurer Amazon" â†’ `/channels` (pas `/login`) âœ…
   - Clic "Aller au dashboard" â†’ `/dashboard` (pas `/login`) âœ…
9. Logout â†’ Login avec `contact@switaa.com` â†’ pas de "Aucun compte"
10. VÃ©rifier UTF-8 : "Aucun compte n'est associÃ© Ã  l'adresse" (si un email inconnu est testÃ©)

---

## 6. DÃ©ploiement

- **Image** : `ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-session-bootstrap-fix-1`
- **Namespace** : `keybuzz-client-dev`
- **Pod** : Running

---

## 7. Rollback

```bash
# Tag prÃ©cÃ©dent
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-stripe-checkout-fix-1

# Golden freeze
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:golden-freeze-ph327d-validated
```

---

## 8. STOP POINT

ğŸ›‘ **PROD non dÃ©ployÃ©. En attente de validation de Ludovic.**
