# PH24.4B-IMPORT-ONDEMAND-CLICK-TRACE-01 - Rapport

**Date**: 2026-01-22
**Environnement**: DEV
**Client Tag**: v0.5.12-import-fix

---

## Probleme identifie

### Symptome
Le bouton "Importer cette commande" ne faisait rien (aucun feedback visible).

### Diagnostic

1. **Handler OK**: Le handler etait bien branche - les logs console montraient:
   - `[OrderSidePanel] Importing order: 403-2054727-4009138`

2. **Requete envoyee**: Le POST partait vers `/api/orders/import-one`

3. **Erreur 500**: Le backend retournait "Amazon not connected for this tenant"

4. **Cause racine**: Le **tenantId envoye etait `kbz-001`** au lieu de `ecomlg-001`

### Trace avant fix
```
[Order Import] Request for 403-2054727-4009138 by ludovic@keybuzz.io (tenant: kbz-001)
[Order Import] Starting import for tenant=kbz-001, orderRef=403-2054727-4009138
```

Le probleme: `OrderSidePanel` n'envoyait pas `tenantId` dans le body, et l'API route utilisait la session qui retournait `kbz-001` par defaut.

---

## Fix applique

### 1) OrderSidePanel.tsx

Ajout de la fonction `getTenantId()`:
```typescript
const getTenantId = (): string => {
  if (typeof window === "undefined") return "ecomlg-001";
  return localStorage.getItem("lastCanonicalTenantId") || "ecomlg-001";
};
```

Modification de `handleImportOrder`:
```typescript
const handleImportOrder = useCallback(async () => {
  const tenantId = getTenantId();  // <-- FIX
  console.debug("[OrderSidePanel] Import click", { orderRef, tenantId });
  
  const response = await fetch("/api/orders/import-one", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ orderRef, tenantId }),  // <-- FIX: tenantId inclus
  });
  // ...
});
```

### 2) Meilleur feedback d'erreur

Ajout d'un encadre rouge si l'erreur n'est pas "introuvable":
```tsx
{error && !error.includes("introuvable") && (
  <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 rounded-lg p-2">
    <p className="text-xs text-red-600">{error}</p>
  </div>
)}
```

---

## Preuves apres fix

### Console logs
```
[DEBUG] Import click {orderRef: 403-2054727-4009138, tenantId: ecomlg-001}
[LOG] Importing order: 403-2054727-4009138 tenant: ecomlg-001
[DEBUG] Import response {status: 200, data: Object}
[LOG] Import success: {success: true, orderId: ord_403_2054727_4009138, imported: true}
```

### Network
```
POST /api/orders/import-one => 200 OK
Response: {success: true, orderId: "ord_403_2054727_4009138", externalOrderId: "403-2054727-4009138", imported: true}
```

### Panel rempli
- Resume: 403-2054727-4009138, 2571.50 EUR, Amazon
- Date: 15 janv. 2026
- Fulfillment: UNKNOWN
- Livraison: En preparation
- Articles (1): Western Digital Ultrastar DC..., 2536.50 EUR, Qte: 5
- Client: Client Amazon, MONTMORENCY 95160, FR

---

## Deploiement

```bash
kubectl -n keybuzz-client-dev set image deployment/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v0.5.12-import-fix
```

---

## Conclusion

| Avant | Apres |
|-------|-------|
| tenantId = kbz-001 (defaut session) | tenantId = ecomlg-001 (localStorage) |
| Erreur 500: "Amazon not connected" | Succes 200: commande importee |
| Panel reste vide | Panel affiche tous les details |