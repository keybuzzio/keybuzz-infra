# PH26.5G — Inbox repasse à 50 : Audit + Fix "no fake counters"

**Date** : 2026-01-30  
**Status** : ✅ Déployé

---

## Audit Initial

### Versions avant intervention

| Élément | Valeur |
|---------|--------|
| Image K8s | `v1.2.0-returnto` (drift!) |
| Image attendue | `v0.5.14-ph265f` |

### API Stats

```bash
curl -sk "https://api-dev.keybuzz.io/stats/conversations?tenantId=ecomlg-001"
```

**Réponse** :
```json
{
  "source": "stats-api",
  "tenantId": "ecomlg-001",
  "conversations": {
    "total": 58,
    "open": 57,
    "pending": 0,
    "resolved": 1
  }
}
```

✅ L'API stats fonctionne et retourne les vrais chiffres (58, pas 50).

---

## Cause Racine

Le code `InboxTripane.tsx` faisait un **fallback** sur `conversations.length` quand l'API stats n'était pas disponible :

```typescript
// AVANT (problématique)
const stats = useMemo(() => {
  const localCounts = {
    total: conversations.length,  // ⚠️ = 50 (pagination size)
    open: conversations.filter(...).length,
    ...
  };
  
  if (apiStats) {
    return { /* vrais stats */ };
  }
  
  return localCounts;  // ⚠️ Fallback qui affiche 50
}, [conversations, apiStats]);
```

**Problème** : Si l'API stats met du temps à charger ou échoue, l'UI affiche `50` (la limite de pagination) au lieu du vrai total.

---

## Solution PH26.5G

### 1. Modifier `stats` pour ne jamais retourner de faux compteurs

```typescript
// APRÈS (PH26.5G)
const stats = useMemo(() => {
  const localUnread = conversations.filter(c => c.unread).length;
  const displayedCount = conversations.length;
  
  if (apiStats) {
    return {
      total: apiStats.conversations.total,
      open: apiStats.conversations.open,
      pending: apiStats.conversations.pending,
      unread: localUnread,
      displayedCount,
      hasMore: apiStats.conversations.total > displayedCount,
      statsAvailable: true,
    };
  }
  
  // API unavailable - return null (will display "—")
  return {
    total: null,      // ← Pas 50 !
    open: null,
    pending: null,
    unread: localUnread,  // OK car c'est local
    displayedCount,
    hasMore: false,
    statsAvailable: false,
  };
}, [conversations, apiStats]);
```

### 2. UI affiche "—" si stats null

```tsx
// Total
<div>{stats.total !== null ? stats.total : <span className="text-gray-400">—</span>}</div>

// Open
<div>{stats.open !== null ? stats.open : <span className="text-gray-400">—</span>}</div>

// Pending
<div>{stats.pending !== null ? stats.pending : <span className="text-gray-400">—</span>}</div>
```

### 3. Bannière "Stats API indisponible"

```tsx
{!stats.statsAvailable && (
  <div className="mb-2 px-2 py-1.5 bg-amber-50 border border-amber-200 rounded-lg">
    <p className="text-xs text-amber-700 text-center">
      Stats API indisponible
    </p>
  </div>
)}
```

---

## Comportement attendu

| Scénario | Avant (bug) | Après (PH26.5G) |
|----------|-------------|-----------------|
| API stats OK | 58 ✅ | 58 ✅ |
| API stats down | 50 ❌ | "—" + bannière ✅ |
| API stats lente | 50 puis 58 ❌ | "—" puis 58 ✅ |

---

## Versions déployées

| Élément | Avant | Après |
|---------|-------|-------|
| Image K8s | `v1.2.0-returnto` | `v0.5.15-ph265g` |
| Digest | — | `sha256:2086887a840452c9d853f8ebb323c10796b0adae793289d827556ab0d3234660` |

---

## Validation

### Tests recommandés

1. **API OK** : Inbox affiche Total = 58 (ou le vrai chiffre)
2. **API simulée down** : Inbox affiche "—" et bannière "Stats API indisponible"
3. **Jamais 50** : Le chiffre 50 ne doit jamais apparaître comme compteur

### Vérification rapide

```bash
# Image déployée
kubectl -n keybuzz-client-dev get deploy keybuzz-client -o=jsonpath='{.spec.template.spec.containers[0].image}'
# → ghcr.io/keybuzzio/keybuzz-client:v0.5.15-ph265g

# API stats
curl -sk "https://api-dev.keybuzz.io/stats/conversations?tenantId=ecomlg-001" | jq .conversations.total
# → 58
```

---

## Fichiers modifiés

| Fichier | Modification |
|---------|--------------|
| `app/inbox/InboxTripane.tsx` | useMemo stats retourne null si API down |
| `app/inbox/InboxTripane.tsx` | UI affiche "—" si stats null |
| `app/inbox/InboxTripane.tsx` | Bannière "Stats API indisponible" |

---

**STATUS** : ✅ Déployé et opérationnel

**Règle établie** : Plus jamais de compteurs dérivés de `conversations.length` (pagination). Source unique = `/stats/conversations`.
