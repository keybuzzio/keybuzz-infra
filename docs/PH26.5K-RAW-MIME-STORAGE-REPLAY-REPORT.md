# PH26.5K — Raw MIME Storage + Replay Parsing

**Date** : 2026-01-30  
**Status** : ✅ Déployé (validation sur prochain message inbound)

---

## Objectif

Stocker le raw MIME complet des messages inbound pour permettre le replay du parsing en cas de bug.

---

## Migration DB

### Colonnes ajoutées à `messages`

| Colonne | Type | Description |
|---------|------|-------------|
| `raw_mime_key` | TEXT | Clé de stockage MinIO (`raw-mime/<tenantId>/<messageId>.eml`) |
| `raw_mime_sha256` | TEXT | Hash SHA256 du raw MIME |
| `raw_mime_size_bytes` | BIGINT | Taille en bytes |

### Index créé

```sql
CREATE INDEX idx_messages_raw_mime_key ON messages(raw_mime_key) WHERE raw_mime_key IS NOT NULL;
```

### Requête de migration

```sql
ALTER TABLE messages ADD COLUMN IF NOT EXISTS raw_mime_key TEXT;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS raw_mime_sha256 TEXT;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS raw_mime_size_bytes BIGINT;
```

---

## Stockage MinIO

### Bucket

- Nom : `keybuzz-raw-mime`
- Création automatique si inexistant

### Structure des clés

```
raw-mime/<tenantId>/<messageId>.eml
```

Exemple :
```
raw-mime/ecomlg-001/cmml0ym4rw5d43ccb23024567.eml
```

### Métadonnées

```javascript
{
  'Content-Type': 'message/rfc822',
  'x-amz-meta-tenant-id': tenantId,
  'x-amz-meta-message-id': messageId,
  'x-amz-meta-sha256': sha256,
}
```

---

## Code ajouté

### `inboxConversation.service.ts`

1. **Import crypto** : `createHash` pour SHA256
2. **Import MinIO** : Client MinIO avec parsing URL
3. **Fonction `parseMinioEndpoint()`** : Parse `http://host:port` correctement
4. **Fonction `storeRawMime()`** : Stocke le raw MIME dans MinIO
5. **Appel dans `createInboxMessage()`** : Stockage avant le parsing des attachments

### Flux

```
1. Message reçu (rawBody)
2. Message créé en DB (msgId)
3. → storeRawMime(tenantId, msgId, rawBody)
   - Calcul SHA256
   - Upload MinIO
   - UPDATE messages SET raw_mime_key, raw_mime_sha256, raw_mime_size_bytes
4. Parsing MIME (attachments, body)
5. Fin
```

---

## Service de Replay (créé mais non exposé)

### `mimeReplay.service.ts`

```typescript
// Replay un message spécifique
replayParsing(messageId: string): Promise<ReplayResult>

// Replay tous les messages avec placeholder body
replayAllPlaceholders(tenantId: string, limit: number): Promise<ReplayResult[]>
```

### Fonctionnalités

- Charge le raw MIME depuis MinIO
- Re-parse avec `parseMimeEmail()`
- Compare avec l'état actuel
- Met à jour body si changé (uniquement si placeholder)
- Ajoute les attachments manquants (idempotent)

---

## Image déployée

| Service | Tag | Digest |
|---------|-----|--------|
| Backend | `v1.0.43-ph265k` | `sha256:90738239835d065e305fc00043d98872cedcf11e36016590021e84616dfcb1f1` |

---

## Validation (à faire sur prochain message)

### 1. Vérifier stockage

```bash
# Après réception d'un nouveau message
kubectl logs -n keybuzz-backend-dev deployment/keybuzz-backend --tail=100 | grep "PH26.5K"
```

Output attendu :
```
[PH26.5K] Stored raw MIME: raw-mime/ecomlg-001/xxx.eml (12345 bytes, sha256=abc123...)
```

### 2. Vérifier DB

```sql
SELECT id, raw_mime_key, raw_mime_sha256, raw_mime_size_bytes 
FROM messages 
WHERE raw_mime_key IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 5;
```

### 3. Vérifier MinIO

```bash
mc ls myminio/keybuzz-raw-mime/raw-mime/ecomlg-001/
```

---

## Sécurité

- **Multi-tenant** : Chaque message stocké avec son `tenantId` dans le path
- **Non-bloquant** : Erreur de stockage ne bloque pas l'ingestion
- **Pas de PII dans logs** : Seuls les métadonnées sont loggées

---

## Recommandations futures

1. **Endpoint replay** : Exposer un endpoint admin pour déclencher le replay
2. **Job périodique** : Replay automatique des messages avec placeholder
3. **Rétention** : Définir une politique de rétention pour les raw MIME anciens
4. **Monitoring** : Alerte si stockage échoue trop souvent

---

## Fichiers modifiés

| Fichier | Modification |
|---------|--------------|
| `inboxConversation.service.ts` | `parseMinioEndpoint()`, `storeRawMime()`, appel de stockage |
| `mimeReplay.service.ts` | Nouveau fichier (replay parsing) |

---

**STATUS** : ✅ Déployé, en attente de validation sur prochain message inbound
