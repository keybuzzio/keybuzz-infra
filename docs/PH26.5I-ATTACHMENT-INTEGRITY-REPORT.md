# PH26.5I — Attachment Integrity Report

**Date** : 2026-01-30  
**Status** : ✅ VÉRIFIÉ - Pas de troncature

---

## Objectif

Vérifier l'intégrité des PJ inbound Amazon en mesurant la taille à 3 niveaux :
- A) Download (navigateur)
- B) Stockage (MinIO)
- C) Parsing (ingestion)

---

## Cas de test

**Fichier** : `20260130_150548.jpg` (Alycia)  
**ID** : `att_abc40e20df9a9cc959669813`  
**Storage Key** : `ecomlg-001/1769782178798-att_abc40e20df9a9cc959669813-20260130_150548.jpg`

---

## Mesures

### A) Taille dans DB (keybuzz.message_attachments)

```sql
SELECT size_bytes FROM message_attachments WHERE id = 'att_abc40e20df9a9cc959669813';
-- Result: 369987 bytes
```

### B) Taille Download Direct (API)

```bash
curl -H 'X-Tenant-Id: ecomlg-001' \
  'https://api-dev.keybuzz.io/attachments/att_abc40e20df9a9cc959669813' \
  -o test.jpg
# HTTP 200, Size: 369987 bytes
```

### C) Taille Download Proxy (Client)

```bash
curl 'https://client-dev.keybuzz.io/api/attachments/att_abc40e20df9a9cc959669813?tenantId=ecomlg-001' \
  -o test.jpg
# HTTP 200, Size: 369987 bytes
```

### D) Vérification SHA256

```
436eb5807585d9b332114ef591825b9939b9017daa32d1f7bd53184a788fdb32  test.jpg (direct)
436eb5807585d9b332114ef591825b9939b9017daa32d1f7bd53184a788fdb32  test.jpg (proxy)
```

---

## Résumé des tailles

| Niveau | Taille | SHA256 (6 premiers car.) |
|--------|--------|--------------------------|
| DB (size_bytes) | 369987 | — |
| API Direct | 369987 | 436eb5 |
| Proxy Client | 369987 | 436eb5 |

**✅ Tailles identiques, SHA256 identique = Pas de troncature**

---

## Problème initial identifié

Le problème **PH26.5H** (API URL) était la cause racine apparente des downloads échoués :
- Le client appelait `api.keybuzz.io` (PROD) au lieu de `api-dev.keybuzz.io` (DEV)
- L'API PROD n'avait pas les données de l'environnement DEV

**Fix PH26.5H** : Corrigé le Dockerfile pour compiler avec la bonne `NEXT_PUBLIC_API_URL`.

---

## Architecture des attachments

```
[Inbound Email] 
    → [attachmentParser.service.ts] parseMimeEmail()
    → [storeAttachments()] 
        → MinIO (keybuzz-attachments bucket)
        → productDb (keybuzz.message_attachments)

[Download Request]
    → [Client /api/attachments/:id] (Next.js proxy)
    → [Backend /attachments/:id] (Fastify)
        → productDb.query() → get storage_key
        → minioClient.getObject() → stream
        → reply.send(stream)
```

---

## Fix appliqué (PH26.5I)

### Backend (attachments.routes.ts)

La route `/api/v1/attachments/:id` a été corrigée pour :
1. Utiliser `productDb` (keybuzz.message_attachments) au lieu de `prisma` (MessageAttachment inexistant)
2. Log DB size vs MinIO size pour debugging
3. Utiliser la taille réelle de MinIO si disponible

**Note** : L'endpoint principal utilisé est `/attachments/:id` (sans `/api/v1`), qui fonctionnait déjà.

---

## Images déployées

| Service | Tag | Digest |
|---------|-----|--------|
| Backend | `v1.0.39-ph265i` | `sha256:d79a268a6ee3408d831bbbb3fd27091d2df1c784989515b2b69551d2b8a6078b` |
| Client | `v0.5.16-ph265h` | (fix API URL) |

---

## Conclusion

**Pas de troncature détectée** sur les attachments. Le problème perçu était dû à :
1. Le client appelant la mauvaise API (PROD au lieu de DEV) → Fix PH26.5H
2. L'intégrité DB → MinIO → Download est confirmée

**Recommandation** : Ajouter un health check qui compare `size_bytes` DB avec la taille réelle dans MinIO pour détecter toute corruption future.

---

**STATUS** : ✅ Intégrité des attachments confirmée
