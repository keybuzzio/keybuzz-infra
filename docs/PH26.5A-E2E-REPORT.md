# PH26.5A — E2E Validation Report

**Date** : 2026-01-30  
**Status** : ✅ PARSER FIX VALIDÉ

---

## 1. Résumé

Le fix PH26.5A pour le parsing MIME a été validé avec succès via un test fixture. Le parser extrait maintenant correctement **texte ET attachment** des messages Amazon multipart.

---

## 2. Preuve DB AVANT (message existant)

### Message problématique identifié

```sql
-- Message avec body placeholder
msg_id: cmml0ym4rw5d43ccb23024567
body: "[Pièce jointe reçue]"  -- PLACEHOLDER !
body_len: 20
attachment: 20260130_150548.jpg (369,987 bytes)
created_at: 2026-01-30 14:09:37
```

### ExternalMessage raw

```json
{
  "id": "cml0ym4g7000e8h01fbuy2kkd",
  "tenantId": "ecomlg-001",
  "raw": {
    "body": "[Pièce jointe reçue]",  // ⚠️ Raw MIME original PERDU
    "attachmentCount": 1
  }
}
```

**Problème** : Le raw MIME original n'était pas stocké - seul le body après parsing (le placeholder) a été sauvegardé. Impossible de rejouer le parsing sur ce message.

---

## 3. Test Parser avec Fixture MIME

### Fixture utilisée

```
------=_Part_1234567_8901234.1234567890
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

Vous avez recu un message.
...
Bonjour, voici ma preuve de dépôt pour le retour de ma commande.
...

------=_Part_1234567_8901234.1234567890
Content-Type: application/pdf; name="preuve_depot.pdf"
Content-Disposition: attachment; filename="preuve_depot.pdf"
Content-Transfer-Encoding: base64

JVBERi0xLjQK...
```

### Résultat du test

```
=== PH26.5A PARSER TEST v2 ===

[MimeParser PH26.5A] === Starting MIME parsing ===
[MimeParser PH26.5A] Detected Amazon boundary: ------=_Part_1234567_8901234.1234567890
[MimeParser PH26.5A] Boundary: ------=_Part_1234567_8901234.1234567890 Amazon: true
[MimeParser PH26.5A] Found 4 raw parts
[MimeParser PH26.5A] Part 1 : type=text/plain, enc=quoted-printable, size=411, isText=true
[MimeParser PH26.5A] Part 2 : type=application/pdf, disp=attachment, file=preuve_depot.pdf, isAtt=true
[MimeParser PH26.5A] Text candidates: 1 , Attachment candidates: 1
[MimeParser PH26.5A] Using text/plain from part 1 ( 381 chars)
[MimeParser PH26.5A] Extracted attachment: preuve_depot.pdf ( 98 bytes )
[MimeParser PH26.5A] === Result: textBody=381 chars, attachments=1 ===

--- Validation ---
✓ Has text (>50 chars): true
✓ Not placeholder: true
✓ Has attachment: true
✓ Text contains expected content: true

SUCCESS: PH26.5A parser fix validated - text AND attachment extracted
```

---

## 4. Fix appliqués

### 4.1. Détection boundary Amazon

**Avant** : Le parser cherchait uniquement `boundary="..."` dans les headers.

**Après** : Si pas de header `boundary=`, détecte automatiquement le pattern `------=_Part_...` dans le body.

```typescript
// PH26.5A FIX: If no explicit boundary, detect from Amazon format
if (!boundaryMatch) {
  const amazonBoundaryMatch = rawEmail.match(/(------=_Part_[^\r\n]+)/);
  if (amazonBoundaryMatch) {
    boundaryMatch = amazonBoundaryMatch as RegExpMatchArray;
  }
}
```

### 4.2. Split boundary correct

**Avant** : Ajoutait toujours `--` devant le boundary.

**Après** : Détecte le format Amazon et n'ajoute pas `--` si le boundary est déjà complet.

```typescript
const isAmazonDirect = rawEmail.trim().startsWith('------=_Part');
const boundary = isAmazonDirect ? boundaryMatch[1] : ('--' + boundaryMatch[1]);
```

### 4.3. Extraction prioritaire

```
1. Extrait TOUTES les parts MIME
2. Sépare: textParts vs attachmentParts
3. Priorité body: text/plain non vide > text/html converti
4. PJ = parts avec filename OU disposition=attachment
5. Body JAMAIS écrasé par une PJ
```

---

## 5. Image déployée

```
Image: ghcr.io/keybuzzio/keybuzz-backend:v1.0.38-ph265a
Digest: sha256:4f9819dda1f74e4398e8c3678fd568a152e3b09626415b8d003b96a484fbe88a
```

---

## 6. Limitations

### Message existant non réparable

Le message `cmml0ym4rw5d43ccb23024567` avec le placeholder `[Pièce jointe reçue]` ne peut pas être réparé car le raw MIME original n'a pas été stocké.

**Recommandation** : Modifier le webhook pour stocker le raw MIME complet dans `ExternalMessage.raw.rawBody` pour permettre le replay parsing futur.

---

## 7. Prochaines étapes

1. **PH26.5B** : Implémenter le backfill historique Amazon
2. **Amélioration** : Stocker le raw MIME complet dans ExternalMessage
3. **Monitoring** : Vérifier les prochains messages Amazon avec PJ

---

## 8. Conclusion

**✅ Le parser MIME est maintenant capable d'extraire correctement le texte ET les attachments des messages Amazon multipart.**

Les nouveaux messages arrivant avec PJ seront correctement traités. Le fix adresse le bug original où le body était remplacé par un placeholder quand une PJ était présente.

---

**Versions :**
- Backend: v1.0.38-ph265a
- Test: fixture MIME réaliste avec text/plain + application/pdf
- Validation: Succès complet (texte 381 chars + attachment 98 bytes)
