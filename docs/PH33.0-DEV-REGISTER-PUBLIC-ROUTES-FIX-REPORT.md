# PH33.0 ‚Äî DEV Register Public Routes Fix Report

**Date**: 2026-02-13
**Environnement**: DEV uniquement
**Tag client**: `v3.4.0-ph33-register-public-dev-fix-1`
**Digest**: `sha256:e5123f885ed669f7bf9f2f23326c9c54fb612fc09f791c48ffb202e59f9988ab`
**Git commit**: `67f1408` (main)

---

## Cause identifi√©e

### Deux couches de protection auth c√¥t√© client React

1. **`AuthGuard.tsx`** (`src/components/auth/AuthGuard.tsx`)
   - Composant wrapper qui v√©rifie l'authentification via `/api/auth/me`
   - Si `unauthenticated` ‚Üí redirect `/login`
   - **PUBLIC_ROUTES avant fix** : `["/login", "/auth/callback", "/pricing"]`
   - `/register` **absent** ‚Üí AuthGuard faisait un fetch auth, recevait 401, puis redirectait vers `/login`

2. **`ClientLayout.tsx`** (`src/components/layout/ClientLayout.tsx`)
   - Layout principal qui affiche sidebar/header ou bypass pour routes publiques
   - **PUBLIC_ROUTES avant fix** : `["/login", "/logout", "/select-tenant"]`
   - `/register` **absent** ‚Üí m√™me si AuthGuard passait, LayoutContent affichait le layout complet au lieu de bypass

### Note : le middleware Next.js (middleware.ts) √©tait correct
Le middleware avait d√©j√† `/register` et `/register/success` dans ses PUBLIC_ROUTES depuis PH33. Le probl√®me √©tait uniquement c√¥t√© React (client-side).

---

## Fix appliqu√©

### Fichier 1 : `src/components/auth/AuthGuard.tsx`

```diff
- const PUBLIC_ROUTES = ["/login", "/auth/callback", "/pricing"];
+ const PUBLIC_ROUTES = ["/login", "/auth/callback", "/pricing", "/register", "/signup"];
```

### Fichier 2 : `src/components/layout/ClientLayout.tsx`

```diff
- const PUBLIC_ROUTES = ["/login", "/logout", "/select-tenant"];
+ const PUBLIC_ROUTES = ["/login", "/logout", "/select-tenant", "/register", "/signup"];
```

### Pattern matching
La fonction `isPublic()` dans AuthGuard utilise `startsWith(route + "/")`, donc :
- `/register` ‚Üí match exact
- `/register/success` ‚Üí match via `/register/` prefix
- `/register?plan=pro` ‚Üí match exact (query params ne changent pas le pathname)
- `/signup` ‚Üí match exact (middleware fait redirect 307 ‚Üí `/register`)

---

## Tests effectu√©s (curl depuis le serveur)

| URL | Avant fix | Apr√®s fix |
|-----|-----------|-----------|
| `/register` | HTTP 307 ‚Üí `/login` | **HTTP 200** ‚úÖ |
| `/register?plan=pro` | HTTP 307 ‚Üí `/login` | **HTTP 200** ‚úÖ |
| `/register/success` | HTTP 307 ‚Üí `/login` | **HTTP 200** ‚úÖ |
| `/signup` | HTTP 307 ‚Üí `/login` | **HTTP 307 ‚Üí /register** ‚úÖ |

### Contenu v√©rifi√©
- `/register` : contient "register" (6 occurrences), aucun "login"
- `/register/success` : contient "success" (7 occurrences), aucun "login"

---

## D√©ploiement

- **Image** : `ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-register-public-dev-fix-1`
- **Namespace** : `keybuzz-client-dev`
- **ArgoCD** : sync via annotation `refresh=hard`
- **Rollout** : termin√© avec succ√®s (pod Running 1/1)

---

## Rollback

```bash
# Option 1 : Tag pr√©c√©dent PH33
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:v3.4.0-ph33-onboarding-dev

# Option 2 : Golden freeze
kubectl -n keybuzz-client-dev set image deploy/keybuzz-client \
  keybuzz-client=ghcr.io/keybuzzio/keybuzz-client:golden-freeze-ph327d-validated
```

---

## P√©rim√®tre du fix

- ‚úÖ Uniquement client-dev (keybuzz-client-dev namespace)
- ‚ùå API non touch√©e
- ‚ùå DB non touch√©e
- ‚ùå Stripe non touch√©
- ‚ùå PROD non touch√©
- ‚úÖ Patch minimal : 2 lignes modifi√©es

---

## STOP POINT

üõë **PROD non d√©ploy√©. En attente de validation explicite de Ludovic.**
