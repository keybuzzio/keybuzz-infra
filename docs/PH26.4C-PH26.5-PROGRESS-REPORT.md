# PH26.4C + PH26.5 — Rapport d'avancement

**Date** : 2026-01-30  
**Environnement** : DEV ONLY

---

## PH26.4C — Guard GitOps Tags Immuables

### ✅ TERMINÉ

**Objectif** : Empêcher les tags non immuables (`:dev`, `:latest`, etc.) dans les manifests K8s.

### Livrables

1. **Script de validation** : `keybuzz-infra/scripts/gitops-guard-immutable-tags.sh`
   - Scanne tous les fichiers YAML dans `k8s/`
   - Détecte les images avec tags interdits
   - Exit code 1 si erreurs détectées

2. **Hook pre-commit** : `keybuzz-infra/scripts/gitops-guard-pre-commit.sh`
   - Pour intégration Git locale

### Tags interdits

- `:dev` (seul)
- `:latest`
- `:main` / `:master`
- Pas de tag (= `:latest` implicite)

### Tags acceptés (exemples)

- `v1.0.0`
- `1.0.20-dev` (version + suffixe)
- `v1.0.35-ph264b`
- `sha-abc123`

### Test

```bash
cd /opt/keybuzz/keybuzz-infra
bash scripts/gitops-guard-immutable-tags.sh k8s/
```

Résultat : 2 erreurs détectées (images curl avec `:latest` dans cronjobs).

---

## PH26.5 — Amazon Messages + PJ + Historique

### Avancement

| Tâche | Status | Description |
|-------|--------|-------------|
| Parsing texte+PJ | ⏳ En investigation | Analyse du code MIME parsing |
| PJ téléchargement forcé | ✅ Terminé | Content-Disposition: attachment |
| Backfill historique | ⏳ À implémenter | Récupération historique SP-API |
| Client affichage | ⏳ À vérifier | Affichage texte + PJ |
| Tests E2E | ⏳ En attente | Commande 171-9818805-2516327 |

### Correction appliquée — PJ téléchargement forcé

**Fichier** : `/opt/keybuzz/keybuzz-backend/src/modules/attachments/attachments.routes.ts`

**Avant** :
```typescript
const disposition = att.isInline ? 'inline' : 'attachment';
```

**Après** :
```typescript
const disposition = 'attachment';  // PH26.5: Toujours forcer le téléchargement
```

**Déploiement** :
- Image : `ghcr.io/keybuzzio/keybuzz-backend:v1.0.36-ph265`
- Digest : `sha256:611bf787cda3c34c5208935dbd01f80dbac2e3c270d60e3b86a7dbcd5bdda51f`

### Analyse du problème de parsing

**Symptômes observés** :
- PJ visible mais texte du message absent
- Historique incomplet (seulement le dernier message)
- IA sans contexte complet

**Causes probables identifiées** :
1. Parser MIME qui ignore le body texte quand PJ présente
2. Multipart mal parsé (boundary issues)
3. Pas de fetch de l'historique via SP-API

**Fichiers à investiguer** :
- `keybuzz-backend/src/modules/inboundEmail/inboundEmail.routes.ts`
- `attachmentParser.service.ts` (si existe)
- `mimeParser.service.ts` (si existe)

### Prochaines étapes

1. **Analyse du code de parsing MIME** 
   - Localiser la logique de parsing multipart
   - Vérifier comment body texte et PJ sont extraits
   
2. **Implémenter backfill historique**
   - À réception d'un message Amazon, vérifier l'historique
   - Si incomplet, fetch via SP-API
   
3. **Tester E2E sur commande 171-9818805-2516327**
   - Vérifier texte visible
   - Vérifier PJ téléchargeable
   - Vérifier historique complet

---

## Versions déployées

| Service | Image | Tag |
|---------|-------|-----|
| keybuzz-backend | ghcr.io/keybuzzio/keybuzz-backend | v1.0.36-ph265 |
| keybuzz-client | ghcr.io/keybuzzio/keybuzz-client | v0.5.11-ph264b |

---

**STATUS** : En cours - Prêt pour investigation approfondie du parsing MIME
