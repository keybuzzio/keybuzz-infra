---
# Reset Hetzner Servers - Optimized Parallel Batch Processing
# PHASE 1: Rebuild servers in parallel batches (BEFORE SSH deployment)
# Uses Hetzner Cloud API (hcloud) ONLY - NO sshpass, NO root password
# Optimized for massive parallel operations
# Expected completion: < 1 hour for 47 servers

- name: Reset Hetzner Servers - Parallel Batch Processing
  hosts: localhost
  gather_facts: false
  vars:
    rebuild_json: "{{ playbook_dir }}/../servers/rebuild_order_v3.json"
    hcloud_env_file: "/opt/keybuzz/credentials/hcloud.env"
    hetzner_api_token: "{{ lookup('env', 'HETZNER_API_TOKEN') | default(lookup('file', hcloud_env_file) | regex_search('HETZNER_API_TOKEN=\"(.*?)\"', '\\1') | first, true) }}"
    ubuntu_image: "ubuntu-24.04"
  
  tasks:
    - name: Load Hetzner API token from credentials file if not in environment
      set_fact:
        hetzner_api_token: "{{ lookup('file', hcloud_env_file) | regex_search('HETZNER_API_TOKEN=\"(.*?)\"', '\\1') | first }}"
      when: 
        - hetzner_api_token == "" or hetzner_api_token is none
        - lookup('file', hcloud_env_file) is not failed
    
    - name: Verify Hetzner API token is set
      fail:
        msg: "HETZNER_API_TOKEN must be set in environment or in {{ hcloud_env_file }}"
      when: hetzner_api_token == "" or hetzner_api_token is none

    - name: Load rebuild_order_v3.json
      slurp:
        src: "{{ rebuild_json }}"
      register: rebuild_json_content
      delegate_to: localhost

    - name: Parse rebuild_order_v3.json
      set_fact:
        rebuild_data: "{{ rebuild_json_content.content | b64decode | from_json }}"
      delegate_to: localhost

    - name: Create server lookup dictionary
      set_fact:
        server_lookup: "{{ server_lookup | default({}) | combine({item.hostname: item}) }}"
      loop: "{{ rebuild_data.servers }}"
      delegate_to: localhost

    - name: Display batch information
      debug:
        msg: |
          ========================================
          KeyBuzz v3 - PHASE 1: Mass Rebuild
          ========================================
          Total servers to rebuild: {{ rebuild_data.metadata.total_servers }}
          Total batches: {{ rebuild_data.metadata.total_batches }}
          Batch size: {{ rebuild_data.metadata.batch_size }}
          Excluded servers: {{ rebuild_data.metadata.excluded_servers | join(', ') }}
          Hetzner API Token: {{ 'SET' if hetzner_api_token != '' else 'NOT SET' }}
          ========================================
          READY FOR PARALLEL EXECUTION
          ========================================

    - name: Create logs directory
      file:
        path: "/opt/keybuzz/logs/phase1"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Process each batch
      block:
        - name: "Display batch {{ item.batch_number }} information"
          debug:
            msg: |
              ========================================
              Processing BATCH {{ item.batch_number }}
              Servers: {{ item.servers | join(', ') }}
              ========================================

        # Step 1: Get server info for all servers in batch (in parallel with throttle)
        - name: "Get server info for batch {{ item.batch_number }} servers"
          community.general.hcloud_server_info:
            name: "{{ server_name }}"
            api_token: "{{ hetzner_api_token }}"
          register: batch_server_info
          loop: "{{ item.servers }}"
          loop_control:
            loop_var: server_name
            label: "{{ server_name }}"
          throttle: 10
          delegate_to: localhost

        # Step 2: Build volumes list for all servers in batch
        - name: "Build volumes list for batch {{ item.batch_number }}"
          set_fact:
            batch_volumes: "{{ batch_volumes | default([]) + [{
              'server_name': server_name,
              'volume_id': vol.id | default(vol.name),
              'volume_name': vol.name
            }] }}"
          loop: "{{ item.servers }}"
          loop_control:
            loop_var: server_name
          vars:
            server_info: "{{ batch_server_info.results | selectattr('item', 'equalto', server_name) | map(attribute='hcloud_server_info') | flatten | first | default({}) }}"
            volumes_list: "{{ server_info.volumes | default([]) }}"
          when: volumes_list | length > 0
          delegate_to: localhost

        # Step 3: Detach all volumes in parallel
        - name: "Detach volumes for batch {{ item.batch_number }} (parallel)"
          community.general.hcloud_volume:
            name: "{{ vol.volume_name }}"
            server: "{{ vol.server_name }}"
            state: detached
            api_token: "{{ hetzner_api_token }}"
          register: detach_results
          loop: "{{ batch_volumes | default([]) }}"
          loop_control:
            loop_var: vol
            label: "{{ vol.server_name }}:{{ vol.volume_name }}"
          throttle: 10
          delegate_to: localhost
          when: batch_volumes | default([]) | length > 0
          failed_when: false

        - name: "Wait for volume detachment to propagate (batch {{ item.batch_number }})"
          pause:
            seconds: 5
          when: batch_volumes | default([]) | length > 0

        # Step 4: Delete all volumes in parallel
        - name: "Delete volumes for batch {{ item.batch_number }} (parallel)"
          community.general.hcloud_volume:
            name: "{{ vol.volume_name }}"
            state: absent
            api_token: "{{ hetzner_api_token }}"
          register: delete_results
          loop: "{{ batch_volumes | default([]) }}"
          loop_control:
            loop_var: vol
            label: "{{ vol.volume_name }}"
          throttle: 10
          delegate_to: localhost
          when: batch_volumes | default([]) | length > 0
          failed_when: false

        # Step 5: Rebuild all servers in batch (in parallel with throttle)
        - name: "Rebuild servers for batch {{ item.batch_number }} (parallel)"
          community.general.hcloud_server:
            name: "{{ server_name }}"
            image: "{{ ubuntu_image }}"
            state: rebuilt
            api_token: "{{ hetzner_api_token }}"
          register: rebuild_results
          loop: "{{ item.servers }}"
          loop_control:
            loop_var: server_name
            label: "{{ server_name }}"
          throttle: 10
          delegate_to: localhost

        # Step 6: Wait for all servers in batch to be running (parallel polling)
        - name: "Wait for all servers in batch {{ item.batch_number }} to be running"
          community.general.hcloud_server_info:
            name: "{{ server_name }}"
            api_token: "{{ hetzner_api_token }}"
          register: server_status_result
          until: "server_status_result.hcloud_server_info[0].status == 'running'"
          retries: 60
          delay: 10
          loop: "{{ item.servers }}"
          loop_control:
            loop_var: server_name
            label: "{{ server_name }}"
          throttle: 10
          delegate_to: localhost

        # Step 7: Wait for SSH port 22 on all servers (parallel check)
        - name: "Wait for SSH port 22 on all servers in batch {{ item.batch_number }}"
          wait_for:
            host: "{{ server_lookup[server_name].ip_public }}"
            port: 22
            delay: 10
            timeout: 300
          loop: "{{ item.servers }}"
          loop_control:
            loop_var: server_name
            label: "{{ server_name }}"
          throttle: 10
          delegate_to: localhost

        # Step 8: Log batch completion
        - name: "Write batch {{ item.batch_number }} completion log"
          copy:
            dest: "/opt/keybuzz/logs/phase1/batch-{{ item.batch_number }}-complete.log"
            content: |
              Batch {{ item.batch_number }} - COMPLETED
              ========================================
              Timestamp: {{ ansible_date_time.iso8601 }}
              Servers: {{ item.servers | to_nice_json }}
              Status: All servers rebuilt and SSH port 22 open
              ========================================
          delegate_to: localhost

        - name: "Batch {{ item.batch_number }} completed successfully"
          debug:
            msg: |
              ✓✓✓ Batch {{ item.batch_number }} COMPLETED ✓✓✓
              Servers: {{ item.servers | join(', ') }}
              All servers rebuilt and ready
              ========================================

        - name: "Reset batch volumes fact for next iteration"
          set_fact:
            batch_volumes: []

      loop: "{{ rebuild_data.batches }}"
      loop_control:
        loop_var: item
        label: "Batch {{ item.batch_number }}"

    - name: Summary - PHASE 1 Complete
      debug:
        msg: |
          ========================================
          KeyBuzz v3 - PHASE 1: Mass Rebuild COMPLETE
          ========================================
          Total servers processed: {{ rebuild_data.metadata.total_servers }}
          Batches processed: {{ rebuild_data.metadata.total_batches }}
          Excluded servers: {{ rebuild_data.metadata.excluded_servers | join(', ') }}
          ========================================
          IMPORTANT: install-01 and install-v3 were NOT touched
          ========================================
          NEXT STEP: Deploy SSH keys (PHASE 2)
          ========================================
          Logs available in: /opt/keybuzz/logs/phase1/
          ========================================
          To generate detailed report, run:
          /opt/keybuzz/keybuzz-infra/scripts/phase1-report.sh
          ========================================

# PHASE 3: Create and attach XFS volumes (AFTER SSH mesh deployment)
# This phase will be executed separately after PHASE 2 (SSH deployment)
