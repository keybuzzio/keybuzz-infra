---
# Reset Hetzner Servers - Optimized Parallel Batch Processing
# PHASE 1: Rebuild servers in parallel batches (BEFORE SSH deployment)
# Uses Hetzner Cloud API (hcloud) ONLY - NO sshpass, NO root password
# Optimized for massive parallel operations
# Expected completion: < 1 hour for 47 servers

- name: Reset Hetzner Servers - Parallel Batch Processing
  hosts: localhost
  gather_facts: false
  vars:
    rebuild_json: "{{ playbook_dir }}/../../servers/rebuild_order_v3.json"
    hcloud_env_file: "/opt/keybuzz/credentials/hcloud.env"
    hetzner_api_token: "{{ lookup('env', 'HCLOUD_TOKEN') | default(lookup('file', hcloud_env_file) | regex_search('HCLOUD_TOKEN=''(.*?)''', '\\1') | first, true) }}"
    ubuntu_image: "ubuntu-24.04"
  
  tasks:
    - name: Set dry_run variable (default to false if not provided)
      set_fact:
        dry_run: "{{ (dry_run | default(false)) | bool }}"
    
    - name: Load Hetzner API token from credentials file if not in environment
      set_fact:
        hetzner_api_token: "{{ lookup('file', hcloud_env_file) | regex_search('HCLOUD_TOKEN=''(.*?)''', '\\1') | first }}"
      when: 
        - hetzner_api_token == "" or hetzner_api_token is none
        - lookup('file', hcloud_env_file) is not failed
    
    - name: Verify Hetzner API token is set
      fail:
        msg: "HCLOUD_TOKEN must be set in environment or in {{ hcloud_env_file }}"
      when: hetzner_api_token == "" or hetzner_api_token is none

    - name: Load rebuild_order_v3.json
      slurp:
        src: "{{ rebuild_json }}"
      register: rebuild_json_content
      delegate_to: localhost

    - name: Parse rebuild_order_v3.json
      set_fact:
        rebuild_data: "{{ rebuild_json_content.content | b64decode | from_json }}"
      delegate_to: localhost

    - name: Create server lookup dictionary
      set_fact:
        server_lookup: "{{ server_lookup | default({}) | combine({item.hostname: item}) }}"
      loop: "{{ rebuild_data.servers }}"
      delegate_to: localhost

    - name: Display batch information
      debug:
        msg: |
          ========================================
          KeyBuzz v3 - PHASE 1: Mass Rebuild
          ========================================
          MODE: {{ 'DRY-RUN (no destructive actions)' if dry_run else 'EXECUTION' }}
          Total servers to rebuild: {{ rebuild_data.metadata.total_servers }}
          Total batches: {{ rebuild_data.metadata.total_batches }}
          Batch size: {{ rebuild_data.metadata.batch_size }}
          Excluded servers: {{ rebuild_data.metadata.excluded_servers | join(', ') }}
          Hetzner API Token: {{ 'SET' if hetzner_api_token != '' else 'NOT SET' }}
          ========================================
          {{ 'DRY-RUN MODE: No destructive actions will be performed' if dry_run else 'READY FOR PARALLEL EXECUTION' }}
          ========================================

    - name: Create logs directory
      file:
        path: "/opt/keybuzz/logs/phase1"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Set variables for batch processing
      set_fact:
        _hetzner_token: "{{ hetzner_api_token }}"
        _ubuntu_image: "{{ ubuntu_image }}"
        _server_lookup: "{{ server_lookup }}"
    
    - name: Process each batch
      include_tasks: process-batch.yml
      loop: "{{ rebuild_data.batches }}"
      loop_control:
        loop_var: item
        label: "Batch {{ item.batch_number }}"

    - name: Summary - PHASE 1 Complete
      debug:
        msg: |
          ========================================
          KeyBuzz v3 - PHASE 1: Mass Rebuild {{ 'DRY-RUN' if dry_run else 'COMPLETE' }}
          ========================================
          MODE: {{ 'DRY-RUN (no actions performed)' if dry_run else 'EXECUTION' }}
          Total servers processed: {{ rebuild_data.metadata.total_servers }}
          Batches processed: {{ rebuild_data.metadata.total_batches }}
          Excluded servers: {{ rebuild_data.metadata.excluded_servers | join(', ') }}
          ========================================
          IMPORTANT: install-01 and install-v3 were NOT touched
          ========================================
          {% if dry_run %}
          DRY-RUN completed successfully - No destructive actions were performed
          Ready for real execution (PH1-09) when validated
          {% else %}
          NEXT STEP: Deploy SSH keys (PHASE 2)
          {% endif %}
          ========================================
          Logs available in: /opt/keybuzz/logs/phase1/
          ========================================
          To generate detailed report, run:
          /opt/keybuzz/keybuzz-infra/scripts/phase1-report.sh
          ========================================

# PHASE 3: Create and attach XFS volumes (AFTER SSH mesh deployment)
# This phase will be executed separately after PHASE 2 (SSH deployment)
