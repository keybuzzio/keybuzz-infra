---
# Install node_exporter on a VM

- name: Check if node_exporter is already running
  ansible.builtin.uri:
    url: "http://localhost:{{ node_exporter_port }}/metrics"
    method: GET
    timeout: 5
  register: node_exporter_check
  failed_when: false
  changed_when: false

- name: Display existing node_exporter status
  ansible.builtin.debug:
    msg: "node_exporter already running on {{ inventory_hostname }}"
  when: node_exporter_check.status == 200

- name: Install node_exporter
  when: node_exporter_check.status != 200
  block:
    - name: Create node_exporter group
      ansible.builtin.group:
        name: "{{ node_exporter_group }}"
        system: true
        state: present

    - name: Create node_exporter user
      ansible.builtin.user:
        name: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        system: true
        shell: /usr/sbin/nologin
        home: "{{ node_exporter_install_dir }}"
        create_home: false
        state: present

    - name: Create install directory
      ansible.builtin.file:
        path: "{{ node_exporter_install_dir }}"
        state: directory
        owner: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        mode: '0755'

    - name: Download node_exporter
      ansible.builtin.get_url:
        url: "{{ node_exporter_download_url }}"
        dest: "/tmp/node_exporter-{{ node_exporter_version }}.tar.gz"
        mode: '0644'

    - name: Extract node_exporter
      ansible.builtin.unarchive:
        src: "/tmp/node_exporter-{{ node_exporter_version }}.tar.gz"
        dest: "/tmp"
        remote_src: true

    - name: Install node_exporter binary
      ansible.builtin.copy:
        src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
        dest: "{{ node_exporter_binary }}"
        owner: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        mode: '0755'
        remote_src: true

    - name: Create systemd service
      ansible.builtin.template:
        src: node_exporter.service.j2
        dest: /etc/systemd/system/node_exporter.service
        owner: root
        group: root
        mode: '0644'
      notify: restart node_exporter

    - name: Cleanup temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/node_exporter-{{ node_exporter_version }}.tar.gz"
        - "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64"

- name: Check UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  failed_when: false
  changed_when: false

- name: Allow node_exporter port in UFW
  ansible.builtin.ufw:
    rule: allow
    port: "{{ node_exporter_port }}"
    proto: tcp
    from_ip: "{{ node_exporter_ufw_allow_from }}"
    comment: "node_exporter from private network"
  when: ufw_status.rc == 0 and ufw_status.stdout is search("Status.* active")

- name: Enable and start node_exporter
  ansible.builtin.systemd:
    name: node_exporter
    state: started
    enabled: true
    daemon_reload: true

- name: Verify node_exporter is responding
  ansible.builtin.uri:
    url: "http://localhost:{{ node_exporter_port }}/metrics"
    method: GET
    timeout: 10
  register: verify_result
  retries: 3
  delay: 2
  until: verify_result.status == 200
