---
# Redis HA v3 Role - Tasks
# Deploys Redis HA cluster with Sentinel on 3 nodes

- name: Ensure /data/redis exists with correct ownership
  file:
    path: /data/redis
    state: directory
    owner: redis
    group: redis
    mode: '0755'

- name: Ensure appendonlydir exists with correct ownership
  file:
    path: /data/redis/appendonlydir
    state: directory
    owner: redis
    group: redis
    mode: '0755'

- name: Install Redis server
  apt:
    name: redis-server
    state: present
    update_cache: yes

- name: Install Redis Sentinel (usually included with redis-server)
  apt:
    name: redis-sentinel
    state: present
  failed_when: false
  changed_when: false

- name: Clean existing AOF and RDB files completely
  shell: |
    find {{ redis_dir }} -type f \( -name "*.aof*" -o -name "*.rdb" -o -name "appendonly*" -o -name "dump*" \) -delete 2>/dev/null || true
    rm -rf {{ redis_dir }}/appendonlydir/* 2>/dev/null || true
    chown -R redis:redis {{ redis_dir }}/appendonlydir 2>/dev/null || true
  failed_when: false
  changed_when: false

- name: Deploy Redis configuration
  template:
    src: redis.conf.j2
    dest: /etc/redis/redis.conf
    owner: redis
    group: redis
    mode: '0644'
  notify: restart redis

- name: Deploy Sentinel configuration
  template:
    src: sentinel.conf.j2
    dest: /etc/redis/sentinel.conf
    owner: redis
    group: redis
    mode: '0644'
  when: redis_enable_sentinel | default(false) | bool
  notify: restart sentinel

- name: Deploy Sentinel systemd unit file
  copy:
    dest: /etc/systemd/system/redis-sentinel.service
    content: |
      [Unit]
      Description=Redis Sentinel
      After=network.target redis-server.service
      Wants=network.target

      [Service]
      ExecStart=/usr/bin/redis-sentinel /etc/redis/sentinel.conf
      ExecStop=/bin/kill -s TERM $MAINPID
      User=redis
      Group=redis
      RuntimeDirectory=redis
      RuntimeDirectoryMode=0755
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  when: redis_enable_sentinel | default(false) | bool
  notify: reload systemd and restart sentinel

- name: Ensure Redis runtime directory exists
  file:
    path: /var/run/redis
    state: directory
    owner: redis
    group: redis
    mode: '0755'

- name: Create systemd override for Redis to allow /data/redis writes
  file:
    path: /etc/systemd/system/redis-server.service.d
    state: directory
    mode: '0755'

- name: Configure systemd override to allow writes to /data/redis
  copy:
    dest: /etc/systemd/system/redis-server.service.d/override.conf
    content: |
      [Service]
      # Allow writes to /data/redis for replication temp files
      ReadWritePaths=/data/redis
      # Set TMPDIR to /data/redis for Redis temp files during replication
      Environment="TMPDIR=/data/redis"
    mode: '0644'
  notify: reload systemd

- name: Force kill any existing redis-server before start
  command: pkill -9 redis-server || true
  failed_when: false
  changed_when: false

- name: Reset systemd state for redis-server before start
  command: systemctl reset-failed redis-server.service || true
  failed_when: false
  changed_when: false

- name: Start and enable Redis server
  systemd:
    name: redis-server
    state: restarted
    enabled: yes
    daemon_reload: yes

- name: Wait for Redis to be ready
  wait_for:
    port: "{{ redis_port }}"
    host: "{{ ansible_host }}"
    delay: 2
    timeout: 30

- name: Configure replica on non-master nodes
  shell: |
    redis-cli -a "{{ redis_auth_password }}" REPLICAOF 10.0.0.123 {{ redis_master_port }}
  when: inventory_hostname != redis_master_host
  failed_when: false
  register: replica_config
  changed_when: "'OK' in replica_config.stdout"

- name: Force kill any existing redis-sentinel before start
  command: pkill -9 redis-sentinel || true
  failed_when: false
  changed_when: false

- name: Reset systemd state for redis-sentinel before start
  command: systemctl reset-failed redis-sentinel.service || true
  failed_when: false
  changed_when: false

- name: Start and enable Redis Sentinel
  systemd:
    name: redis-sentinel
    state: restarted
    enabled: yes
    daemon_reload: yes

- name: Wait for Sentinel to be ready
  wait_for:
    port: "{{ sentinel_port }}"
    host: "{{ ansible_host }}"
    delay: 2
    timeout: 30

- name: Verify Redis replication status
  shell: |
    redis-cli -a "{{ redis_auth_password }}" INFO replication | grep -E "role|master_host|master_port|connected_slaves"
  register: redis_info
  changed_when: false

- name: Display Redis replication info
  debug:
    var: redis_info.stdout_lines

- name: Verify Sentinel status
  shell: |
    redis-cli -p {{ sentinel_port }} SENTINEL master {{ sentinel_master_name }}
  register: sentinel_info
  changed_when: false
  when: redis_enable_sentinel | default(false) | bool

- name: Display Sentinel info
  debug:
    var: sentinel_info.stdout_lines
  when: redis_enable_sentinel | default(false) | bool

