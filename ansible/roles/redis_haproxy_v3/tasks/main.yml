---
# Redis HAProxy v3 Role - Tasks
# Deploys HAProxy configuration for Redis HA cluster

- name: Install HAProxy package
  apt:
    name: haproxy
    state: present
    update_cache: yes

- name: Ensure HAProxy config directory exists
  file:
    path: /etc/haproxy/conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy Redis HAProxy configuration
  template:
    src: redis-haproxy.cfg.j2
    dest: /etc/haproxy/conf.d/redis.cfg
    owner: root
    group: root
    mode: '0644'
  notify: restart haproxy

- name: Check if HAProxy config already includes conf.d
  shell: grep -q "include /etc/haproxy/conf.d/\*\.cfg" /etc/haproxy/haproxy.cfg || echo "NOT_FOUND"
  register: include_check
  changed_when: false
  failed_when: false

- name: Add include directive for conf.d
  lineinfile:
    path: /etc/haproxy/haproxy.cfg
    line: '    include /etc/haproxy/conf.d/*.cfg'
    insertafter: '^global'
    regexp: '^.*include /etc/haproxy/conf\.d'
  when: include_check.stdout == "NOT_FOUND"
  notify: restart haproxy

- name: Validate HAProxy configuration
  command: haproxy -c -f /etc/haproxy/haproxy.cfg
  register: haproxy_check
  changed_when: false
  failed_when: haproxy_check.rc != 0

- name: Ensure HAProxy service is running
  systemd:
    name: haproxy
    state: restarted
    enabled: yes
    daemon_reload: yes

