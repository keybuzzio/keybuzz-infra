---
# PostgreSQL HAProxy v3 Role - Tasks
# Deploys HAProxy configuration for PostgreSQL HA cluster

- name: Ensure HAProxy config directory exists
  file:
    path: /etc/haproxy/conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Add PostgreSQL HAProxy configuration to haproxy.cfg
  blockinfile:
    path: /etc/haproxy/haproxy.cfg
    block: |
      # PostgreSQL Primary (Write) - Via Patroni health check
      # PH-SRE-DB-ENDPOINT-NONREGRESSION-02: Utilise /primary pour détecter le leader
      listen postgres_write
          mode tcp
          bind *:{{ haproxy_postgres_write_port }}
          balance first
          option httpchk GET /primary
          http-check expect status 200
          default-server inter 2000 fall 2 rise 2 on-marked-down shutdown-sessions
          server db-postgres-01 {{ postgres_nodes[0].ansible_host }}:{{ postgres_listen_port }} check port 8008
          server db-postgres-02 {{ postgres_nodes[1].ansible_host }}:{{ postgres_listen_port }} check port 8008
          server db-postgres-03 {{ postgres_nodes[2].ansible_host }}:{{ postgres_listen_port }} check port 8008

      # PostgreSQL Replicas (Read) - Port 5433
      # Utilise /replica pour détecter les replicas
      listen postgres_read
          mode tcp
          bind *:{{ haproxy_postgres_read_port }}
          balance roundrobin
          option httpchk GET /replica
          http-check expect status 200
          default-server inter 2000 fall 2 rise 2
          server db-postgres-01 {{ postgres_nodes[0].ansible_host }}:{{ postgres_listen_port }} check port 8008
          server db-postgres-02 {{ postgres_nodes[1].ansible_host }}:{{ postgres_listen_port }} check port 8008
          server db-postgres-03 {{ postgres_nodes[2].ansible_host }}:{{ postgres_listen_port }} check port 8008
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR POSTGRESQL HA"
    insertafter: EOF
  notify: restart haproxy

- name: Validate HAProxy configuration
  command: haproxy -c -f /etc/haproxy/haproxy.cfg
  register: haproxy_check
  changed_when: false
  failed_when: haproxy_check.rc != 0

- name: Ensure HAProxy service is running
  systemd:
    name: haproxy
    state: restarted
    enabled: yes
    daemon_reload: yes

