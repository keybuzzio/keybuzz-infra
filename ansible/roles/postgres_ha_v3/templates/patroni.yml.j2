# Patroni Configuration for KeyBuzz PostgreSQL 17 HA (RAFT mode)
# Generated by Ansible - DO NOT EDIT MANUALLY

scope: {{ patroni_scope }}
name: {{ inventory_hostname }}

restapi:
  listen: 0.0.0.0:{{ patroni_rest_api_port }}
  connect_address: {{ ansible_host }}:{{ patroni_rest_api_port }}

raft:
  data_dir: {{ postgres_data_dir }}/raft
  self_addr: {{ ansible_host }}:5010
  partner_addrs:
{% for host in groups['db_postgres'] if host != inventory_hostname %}
    - {{ hostvars[host].ansible_host }}:5010
{% endfor %}

postgresql:
  listen: {{ postgres_listen_addresses }}:{{ postgres_listen_port }}
  connect_address: {{ ansible_host }}:{{ postgres_listen_port }}
  data_dir: {{ postgres_data_dir }}/data
  bin_dir: /usr/lib/postgresql/{{ postgres_version }}/bin
  pgpass: /var/lib/postgresql/.pgpass
  
  authentication:
    superuser:
      username: postgres
      password: {{ postgres_superuser_password }}
    replication:
      username: {{ postgres_replication_user }}
      password: {{ postgres_replication_password }}
  
  parameters:
    max_connections: {{ postgres_max_connections }}
    shared_buffers: {{ postgres_shared_buffers }}
    wal_level: {{ postgres_wal_level }}
    hot_standby: "{{ postgres_hot_standby }}"
    max_wal_senders: 10
    max_replication_slots: 10
    wal_keep_size: 1GB
    archive_mode: on
    archive_command: 'test ! -f {{ postgres_data_dir }}/archive/%f && cp %p {{ postgres_data_dir }}/archive/%f'

watchdog:
  mode: automatic

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false

