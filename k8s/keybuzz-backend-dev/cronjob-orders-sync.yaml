# k8s/keybuzz-backend-dev/cronjob-orders-sync.yaml
# PH15-AMAZON-ORDERS-SYNC-SCALE-01: Global multi-tenant sync
apiVersion: batch/v1
kind: CronJob
metadata:
  name: amazon-orders-sync
  namespace: keybuzz-backend-dev
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  concurrencyPolicy: Forbid  # Prevent overlapping runs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 600
      backoffLimit: 1
      template:
        spec:
          restartPolicy: Never
          hostAliases:
            - ip: "10.0.0.150"
              hostnames:
                - "vault.keybuzz.io"
          containers:
            - name: sync-runner
              image: curlimages/curl:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting Global Amazon Orders Sync..."
                  echo "Processing ALL CONNECTED tenants (batch mode)"
                  curl -sk -X POST \
                    -H "X-User-Email: system@keybuzz.io" \
                    https://backend-dev.keybuzz.io/api/v1/orders/sync/run/global
                  echo ""
                  echo "Global sync completed"
              resources:
                limits:
                  memory: "64Mi"
                  cpu: "100m"
                requests:
                  memory: "32Mi"
                  cpu: "50m"