apiVersion: batch/v1
kind: CronJob
metadata:
  name: sla-evaluator
  namespace: keybuzz-api-dev
  labels:
    app: sla-evaluator
  annotations:
    description: "PH11-04-11: SLA Engine with dynamic policies"
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: sla-evaluator
        spec:
          restartPolicy: Never
          containers:
            - name: evaluator
              image: postgres:17-alpine
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "[SLA Evaluator] Starting at $(date -u +%H:%M:%S)"
                  
                  # Update SLA states using policy-based risk thresholds
                  psql "postgresql://$PGUSER:$PGPASSWORD@$PGHOST:$PGPORT/$PGDATABASE?sslmode=disable" <<'EOSQL'
                  -- Update SLA states based on sla_due_at and policy risk_minutes
                  UPDATE conversations c
                  SET 
                    sla_state = CASE
                      WHEN c.sla_due_at IS NULL THEN 'ok'
                      WHEN now() > c.sla_due_at THEN 'breached'
                      WHEN now() > (c.sla_due_at - (COALESCE(p.risk_minutes, 30) || ' minutes')::interval) THEN 'risk'
                      ELSE 'ok'
                    END,
                    sla_last_evaluated_at = now()
                  FROM sla_policies p
                  WHERE c.sla_due_at IS NOT NULL
                    AND p.id = COALESCE(
                      c.sla_policy_id,
                      -- Fallback to global default if no policy_id set
                      (SELECT id FROM sla_policies 
                       WHERE enabled = true 
                         AND tenant_id IS NULL 
                         AND plan IS NULL 
                         AND channel IS NULL 
                       ORDER BY priority ASC 
                       LIMIT 1)
                    )
                    AND (
                      -- Only update if state would actually change
                      c.sla_state IS NULL OR
                      c.sla_state IS DISTINCT FROM CASE
                        WHEN c.sla_due_at IS NULL THEN 'ok'
                        WHEN now() > c.sla_due_at THEN 'breached'
                        WHEN now() > (c.sla_due_at - (COALESCE(p.risk_minutes, 30) || ' minutes')::interval) THEN 'risk'
                        ELSE 'ok'
                      END
                    );
                  EOSQL
                  
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 0 ]; then
                    echo "[SLA Evaluator] ✅ Success - SLA states evaluated with policy-based thresholds"
                  else
                    echo "[SLA Evaluator] ❌ Failed with exit code $EXIT_CODE"
                    exit $EXIT_CODE
                  fi
              envFrom:
                - secretRef:
                    name: keybuzz-api-postgres
              resources:
                limits:
                  cpu: "100m"
                  memory: "64Mi"
                requests:
                  cpu: "50m"
                  memory: "32Mi"

