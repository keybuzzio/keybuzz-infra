apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: keybuzz-infra-alerts
  namespace: observability
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: keybuzz-infra.rules
    interval: 30s
    rules:
    # Node alerts
    - alert: NodeDown
      expr: up{job=~"node_exporter.*"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Node {{ $labels.instance }} is down"
        description: "Node exporter on {{ $labels.instance }} has been unreachable for more than 2 minutes"
    
    - alert: NodeDiskSpaceCritical
      expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.*"} / node_filesystem_size_bytes) * 100 < 15
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Disk space critical on {{ $labels.instance }}"
        description: "Disk space on {{ $labels.instance }} mount {{ $labels.mountpoint }} is below 15% ({{ $value | printf \"%.1f\" }}%)"
    
    - alert: NodeDiskSpaceWarning
      expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.*"} / node_filesystem_size_bytes) * 100 < 20
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Disk space warning on {{ $labels.instance }}"
        description: "Disk space on {{ $labels.instance }} mount {{ $labels.mountpoint }} is below 20% ({{ $value | printf \"%.1f\" }}%)"
    
    - alert: NodeMemoryPressure
      expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage on {{ $labels.instance }}"
        description: "Memory usage on {{ $labels.instance }} is above 90% ({{ $value | printf \"%.1f\" }}%)"
    
    - alert: NodeCPUHigh
      expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "High CPU usage on {{ $labels.instance }}"
        description: "CPU usage on {{ $labels.instance }} is above 90% for 10 minutes ({{ $value | printf \"%.1f\" }}%)"

    # Kubernetes alerts
    - alert: PodCrashLoopBackOff
      expr: increase(kube_pod_container_status_restarts_total[1h]) > 5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in the last hour"
    
    - alert: DeploymentReplicasUnavailable
      expr: kube_deployment_status_replicas_unavailable > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has unavailable replicas"
        description: "{{ $value }} replicas unavailable for deployment {{ $labels.deployment }} in {{ $labels.namespace }}"
    
    - alert: DeploymentDown
      expr: kube_deployment_status_replicas_available == 0 and kube_deployment_spec_replicas > 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} is down"
        description: "All replicas of {{ $labels.deployment }} in {{ $labels.namespace }} are unavailable"

    # Patroni/PostgreSQL alerts
    - alert: PatroniDown
      expr: up{job="patroni"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Patroni on {{ $labels.instance }} is down"
        description: "Patroni metrics endpoint on {{ $labels.instance }} has been unreachable for more than 2 minutes"
    
    - alert: PatroniNoLeader
      expr: sum(patroni_postgres_server_role{role="primary"}) == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL cluster has no leader"
        description: "No Patroni node is currently the primary. Cluster may be in failover or broken state."

    # External infrastructure alerts  
    - alert: HAProxyDown
      expr: up{job="node_exporter_haproxy"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "HAProxy {{ $labels.instance }} is down"
        description: "HAProxy node {{ $labels.instance }} has been unreachable for more than 2 minutes"
    
    - alert: VaultDown
      expr: up{job="node_exporter_vault"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Vault server is down"
        description: "Vault node {{ $labels.instance }} has been unreachable for more than 2 minutes. This is a SPOF!"
