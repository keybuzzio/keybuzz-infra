apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: keybuzz-dev-alerting
  namespace: observability
  labels:
    app: keybuzz-alerting
spec:
  route:
    groupBy:
      - alertname
      - instance
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 1h
    receiver: keybuzz-log-only
    routes:
      # Critical: Slack + Email + log-only
      - matchers:
          - name: severity
            matchType: "="
            value: critical
        receiver: keybuzz-slack-dev
        continue: true
      - matchers:
          - name: severity
            matchType: "="
            value: critical
        receiver: keybuzz-email-dev
        continue: true
      # Warning: Slack + log-only
      - matchers:
          - name: severity
            matchType: "="
            value: warning
        receiver: keybuzz-slack-dev
        continue: true
      # Fallback: log-only
      - matchers:
          - name: severity
            matchType: "=~"
            value: ".*"
        receiver: keybuzz-log-only
        continue: false
  receivers:
    - name: keybuzz-log-only
      webhookConfigs:
        - url: http://10.0.0.152:9099/alerts
          sendResolved: true
    - name: keybuzz-slack-dev
      slackConfigs:
        - apiURL:
            name: alerting-slack-dev
            key: webhook_url
          channel: "#alerts-dev"
          sendResolved: true
          title: |-
            {{ if eq .Status "firing" }} ðŸ”´ {{ else }} âœ… {{ end }} [KeyBuzz DEV] {{ .GroupLabels.alertname }}
          text: |-
            {{ range .Alerts -}}
            *{{ .Labels.severity }}*: {{ .Annotations.summary }}
            {{ .Annotations.description }}
            {{ end }}
    - name: keybuzz-email-dev
      emailConfigs:
        - to: sre@keybuzz.io
          sendResolved: true
          from: alerts@keybuzz.io
          smarthost: "10.0.0.160:25"
          requireTLS: false
          headers:
            - key: Subject
              value: "{{ if eq .Status \"firing\" }}[FIRING]{{ else }}[RESOLVED]{{ end }} [KeyBuzz DEV] {{ .GroupLabels.alertname }}"